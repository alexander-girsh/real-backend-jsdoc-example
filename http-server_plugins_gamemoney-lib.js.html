<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>http-server/plugins/gamemoney-lib.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OutgoingMessage.html">OutgoingMessage</a></li><li><a href="Game.html">Game</a></li><li><a href="CrashGame.html">CrashGame</a><ul class='members'><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGame.html#publishUpdatedPlayer">publishUpdatedPlayer</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#handleManualOutDirectives">handleManualOutDirectives</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#autoOutPlayers">autoOutPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outRemainingPlayers">outRemainingPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outPlayers">outPlayers</a></li></ul></li><li><a href="CrashGameDBTransaction.html">CrashGameDBTransaction</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#createSavePoint">createSavePoint</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#rollbackToSavePoint">rollbackToSavePoint</a></li></ul></li><li><a href="GameWin.html">GameWin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="GameWin.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="GameWin.html#.calcWonAmount">calcWonAmount</a></li></ul></li><li><a href="SteamItem.html">SteamItem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SteamItem.html#.fromObject">fromObject</a></li></ul></li><li><a href="module-Games-Game.html">Game</a></li><li><a href="module-Games-SteamItem.html">SteamItem</a></li><li><a href="module-Games-InventoryItem.html">InventoryItem</a></li><li><a href="module-Games-GameWin.html">GameWin</a></li><li><a href="module-Games-GameBet.html">GameBet</a></li><li><a href="module-Games-User.html">User</a></li><li><a href="module-Games-Player.html">Player</a></li></ul><h3>Modules</h3><ul><li><a href="module-access_config.html">access/config</a></li><li><a href="module-access.html">access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-access.html#~encryptString">encryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#.decryptString">decryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#~issueJWTToken">issueJWTToken</a></li></ul></li><li><a href="module-broadcasting-server_config.html">broadcasting-server/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-broadcasting-server_config.html#.PORT">PORT</a></li></ul></li><li><a href="module-ws-server_ws-clients.html">ws-server/ws-clients</a></li><li><a href="module-database_config.html">database/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_ATTEMPTS">RECONNECTION_ATTEMPTS</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_DELAY">RECONNECTION_DELAY</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_CONNECTION_URL">DB_CONNECTION_URL</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_TRANSACTIONS_RETRIES_LIMIT">DB_TRANSACTIONS_RETRIES_LIMIT</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.PG_POOL_QUERIES_VERBOSE_MODE">PG_POOL_QUERIES_VERBOSE_MODE</a></li></ul></li><li><a href="module-database_connection.html">database/connection</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-database_connection.html#~onClientConnected">onClientConnected</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~reconnect">reconnect</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~createNewClient">createNewClient</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~execRepeatableTransaction">execRepeatableTransaction</a></li></ul></li><li><a href="module-http-server_api_accounts.html">http-server/api/accounts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~createLocal">createLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~authenticateLocal">authenticateLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~initEmailConfirmation">initEmailConfirmation</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~confirmEmailWithCode">confirmEmailWithCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~sendPasswordRecoveryCode">sendPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~checkPasswordRecoveryCode">checkPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~issueNewPassword">issueNewPassword</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~getAccountData">getAccountData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~list">list</a></li></ul></li><li><a href="module-http-server_api_oAuth.html">http-server/api/oAuth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateVKRedirect">generateVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleVKRedirect">handleVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateGoogleRedirect">generateGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleGoogleRedirect">handleGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateYandexRedirect">generateYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleYandexRedirect">handleYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~getOpenIdInstanceByReturnUrl">getOpenIdInstanceByReturnUrl</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleSteamRedirect">handleSteamRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~readUserData">readUserData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~endAuthentication">endAuthentication</a></li></ul></li><li><a href="module-http-server_api_payments_freekassa.html">http-server/api/payments/freekassa</a></li><li><a href="module-http-server_api_payments_gamemoney.html">http-server/api/payments/gamemoney</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~generateDepositRedirectSignature">generateDepositRedirectSignature</a></li></ul></li><li><a href="module-http-server_api_payments.html">http-server/api/payments</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~depositRules">depositRules</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~generateDepositRedirect">generateDepositRedirect</a></li></ul></li><li><a href="module-http-server_config.html">http-server/config</a></li><li><a href="module-http-server.html">http-server</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-http-server.html#.API">API</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server.html#~startServe">startServe</a></li><li data-type='method' style='display: none;'><a href="module-http-server.html#~shutDown">shutDown</a></li></ul></li><li><a href="module-http-server_middleware_access.html">http-server/middleware/access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~setAuthCookie">setAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~removeAuthCookie">removeAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~addAuthorizationDataToRequest">addAuthorizationDataToRequest</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessUser">accessUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessAdmin">accessAdmin</a></li></ul></li><li><a href="module-http-server_gamemoney-lib.html">http-server/gamemoney-lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateHmacSignature">generateHmacSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~verifyRequestRsaSignature">verifyRequestRsaSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~createDeposit">createDeposit</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~updateDepositStatus">updateDepositStatus</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateDepositRedirectUrl">generateDepositRedirectUrl</a></li></ul></li><li><a href="module-http-server_health-check.html">http-server/health-check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~updateState">updateState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~getState">getState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpMiddleware">httpMiddleware</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpEndpoint">httpEndpoint</a></li></ul></li><li><a href="module-http-server_mailer.html">http-server/mailer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_mailer.html#~sendMail">sendMail</a></li></ul></li><li><a href="module-http-server_plugins_withdrawals_approval.html">http-server/plugins/withdrawals/approval</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_plugins_withdrawals_approval.html#~checkForWithdrawalsBlockers">checkForWithdrawalsBlockers</a></li></ul></li><li><a href="module-http-server_lib.html">http-server/lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~freezeObjectDeep">freezeObjectDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesSizeOfObject">bytesSizeOfObject</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~asyncInterval">asyncInterval</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~delay">delay</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~compareDeep">compareDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~generateRandomString">generateRandomString</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~minMax">minMax</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~shuffleArray">shuffleArray</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~toFixedPrecisionFloat">toFixedPrecisionFloat</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~to2DigitsPrecisionFloat">to2DigitsPrecisionFloat</a></li></ul></li><li><a href="module-logger.html">logger</a></li><li><a href="module-redis-connection_config.html">redis-connection/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_HOST">REDIS_HOST</a></li><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_PORT">REDIS_PORT</a></li></ul></li><li><a href="module-Games.html">Games</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createLocalAccount">createLocalAccount</a></li><li><a href="global.html#authenticateLocalAccount">authenticateLocalAccount</a></li><li><a href="global.html#fetchAccountData">fetchAccountData</a></li><li><a href="global.html#createAxiosInstance">createAxiosInstance</a></li><li><a href="global.html#createAuthInfrastructure">createAuthInfrastructure</a></li><li><a href="global.html#createWebsocketConnection">createWebsocketConnection</a></li><li><a href="global.html#socketCookieParser">socketCookieParser</a></li><li><a href="global.html#authCookieParser">authCookieParser</a></li><li><a href="global.html#hasAccessUser">hasAccessUser</a></li><li><a href="global.html#hasAccessAdmin">hasAccessAdmin</a></li><li><a href="global.html#util">util</a></li><li><a href="global.html#isMainBroadcastingServer">isMainBroadcastingServer</a></li><li><a href="global.html#MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD">MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD</a></li><li><a href="global.html#BETTING_PERIOD_MS">BETTING_PERIOD_MS</a></li><li><a href="global.html#COMPLETED_PERIOD_MS">COMPLETED_PERIOD_MS</a></li><li><a href="global.html#CRASH_GAME_FRAMES_DELAY_MS">CRASH_GAME_FRAMES_DELAY_MS</a></li><li><a href="global.html#GAME_LOOP_DELAY_AFTER_ERROR_MS">GAME_LOOP_DELAY_AFTER_ERROR_MS</a></li><li><a href="global.html#%2522your-256-bit-secret%2522">"your-256-bit-secret"</a></li><li><a href="global.html#CURRENT_GAME">CURRENT_GAME</a></li><li><a href="global.html#generateFinalMultipliersGroup">generateFinalMultipliersGroup</a></li><li><a href="global.html#activateFinalMultipliersGroup">activateFinalMultipliersGroup</a></li><li><a href="global.html#generateDepositRedirect">generateDepositRedirect</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#Accounts">Accounts</a></li><li><a href="global.html#performInventoryItemWithdrawalStatusUpdateNotificationForUser">performInventoryItemWithdrawalStatusUpdateNotificationForUser</a></li><li><a href="global.html#itemsList">itemsList</a></li><li><a href="global.html#fileParser">fileParser</a></li><li><a href="global.html#CONTENT_TYPES%255Bundefined%255D">CONTENT_TYPES[undefined]</a></li><li><a href="global.html#STEAM_ITEM_ICON_URL_HASHES_CACHE%255Bundefined%255D">STEAM_ITEM_ICON_URL_HASHES_CACHE[undefined]</a></li><li><a href="global.html#freekassaIPVerificationMiddleware">freekassaIPVerificationMiddleware</a></li><li><a href="global.html#freekassaHookSignatureVerificationMiddleware">freekassaHookSignatureVerificationMiddleware</a></li><li><a href="global.html#gamemoneyIPVerificationMiddleware">gamemoneyIPVerificationMiddleware</a></li><li><a href="global.html#gamemoneyHookSignatureVerificationMiddleware">gamemoneyHookSignatureVerificationMiddleware</a></li><li><a href="global.html#skinsBackIPVerificationMiddleware">skinsBackIPVerificationMiddleware</a></li><li><a href="global.html#skinsBackHookSignatureVerificationMiddleware">skinsBackHookSignatureVerificationMiddleware</a></li><li><a href="global.html#unitpayIPVerificationMiddleware">unitpayIPVerificationMiddleware</a></li><li><a href="global.html#unitpayHookSignatureVerificationMiddleware">unitpayHookSignatureVerificationMiddleware</a></li><li><a href="global.html#affiliateExists">affiliateExists</a></li><li><a href="global.html#getAffiliate">getAffiliate</a></li><li><a href="global.html#createNewAffiliate">createNewAffiliate</a></li><li><a href="global.html#performRevshareAccrual">performRevshareAccrual</a></li><li><a href="global.html#createDefaultTariff">createDefaultTariff</a></li><li><a href="global.html#getValidMatchingTariff">getValidMatchingTariff</a></li><li><a href="global.html#MENTION_SUGGESTIONS">MENTION_SUGGESTIONS</a></li><li><a href="global.html#searchMentionedUsers">searchMentionedUsers</a></li><li><a href="global.html#filterProhibitedWords">filterProhibitedWords</a></li><li><a href="global.html#EMOJIS_LIST">EMOJIS_LIST</a></li><li><a href="global.html#generateDepositRedirectUrl">generateDepositRedirectUrl</a></li><li><a href="global.html#handleNewPromocodeActivation">handleNewPromocodeActivation</a></li><li><a href="global.html#handleNewCompletedDeposit">handleNewCompletedDeposit</a></li><li><a href="global.html#generateSignature">generateSignature</a></li><li><a href="global.html#verifyHookSignature">verifyHookSignature</a></li><li><a href="global.html#createOrReplaceDeposit">createOrReplaceDeposit</a></li><li><a href="global.html#Status">Status</a></li><li><a href="global.html#createConnection">createConnection</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#KNOWN_ACQUIRING_SYSTEMS">KNOWN_ACQUIRING_SYSTEMS</a></li><li><a href="global.html#PAYMENT_METHOD_KINDS">PAYMENT_METHOD_KINDS</a></li><li><a href="global.html#PAYMENT_METHOD_ICON_NAMES">PAYMENT_METHOD_ICON_NAMES</a></li><li><a href="global.html#PaymentMethod">PaymentMethod</a></li><li><a href="global.html#depositRules">depositRules</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">http-server/plugins/gamemoney-lib.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const GameMoneySDK = require( 'gamemoney')
const {config} = require( '../config.js')
const {codes} = require( 'status-codes')
const {error} = require( '../../logger/index.js')
const {DB, createNewClient} = require( '../../database/connection.js')
const util = require( 'util')
const {USD_EXCHANGE_RATE} = require( './currencies.js')
const {to2DigitsPrecisionFloat} = require('../../lib.js')

/**
 * Contains bindings and methods to interact
 * with deposits and withdraws made with
 * gamemoney.com acquirer.
 * @module http-server/gamemoney-lib
 */

const GameMoneyClient = new GameMoneySDK.GameMoney({
    hmacKey: config.GAMEMONEY_HMAC_KEY,
    project: Number(config.GAMEMONEY_PROJECT_ID)
})

/**
 * Required to sign redirects to cashier window on acquirer side
 * @function generateHmacSignature
 * @param args {*}
 * @returns {String}
 */
const generateHmacSignature = (...args) => GameMoneyClient.generateHmacSignature(...args)



/**
 * In use to verify signatures of incoming hooks
 * @function verifyRequestRsaSignature
 * @param request_body {GameMoneyDepositHook}
 * @returns Boolean
 */
const verifyRequestRsaSignature = (request_body) => GameMoneySDK.verifyRsaSignature(request_body)

const createInvoice = (details) => GameMoneyClient.createInvoice(details)

/**
 * @typedef {Object} GameMoneyDepositHook
 * @property project {String}  our shop id
 * @property invoice {String}  the unique invoice number
 * @property status  {String} 'Paid' if completed.
 * Allowed statuses, according the docs {@link https://cp.gamemoney.com/apidoc#anchor3}
 * 'New' — The invoice is created, I dunno why do we need this hook,
 * 'Processing' — Some external payments system processes the money transfer,
 * 'Paid' — Transfer completed, our shop balance on gamemoney.com was incremented,
 * 'Chargeback' — Need to write-off the amount if it was accrued earlier,
 * 'Chargeback_cancel' — Need to re-accrue the deposit amount to the user's balance
 * @property amount {String} Is amount user inputs on our side
 * @property net_amount {String} Is amount gamemoney.com took from user's wallet
 * @property received_amount {String} The amount which we got ( = net_amount - acquirer fee ). They did a spelling mistake in this field name in original hook.
 * @property user {String} The unique user_id in our system we sent them redirecting user
 * @property type {String} is the wallet type used depositing, for e.g 'yandex', 'qiwi' etc.
 * @property wallet {String} Is the mask or full (!!!) wallet number which we can use later to approve only the withdraws to wallets used earlier to deposit funds
 * @property comment {String} We can use to add any content to invoice to use it later
 * @property currency_project {String} The currency of our shop balance (?)
 * @property currency_user {String} The currency in which user paid
 * @property time {String} Unix timestamp (numeric) of hook sending, but they prefer Strings =)
 * @property signature {String} RSA signature we can validate using middleware &amp; GameMoneySDK .verifyRsaSignature() method
 */


/**
 * @param user_id {String|Number}
 * @param acquiring_system  {String} Only 'GAME_MONEY' if allowed now
 * @param id_in_acquiring_system {String|Number}
 * @param status {String} only 'IN_PROGRESS', 'COMPLETED' and 'RETURNED' are allowed
 * @param net_amount {String | Number}
 * @param received_amount {String | Number}
 * @param wallet_type {String}
 * @param wallet_number {String}
 * @param acquiring_system_hooks_array_name {String} Column where we store raw hooks from this acquirer for e.g "gamemoney_hooks"
 * @param acquiring_system_hook {Object} The raw hook from acquirer
 * @param currency_project
 * @param currency_user
 * @returns {Promise&lt;{deposit_id: Number, status: number}|{status: number}>}
 */
const createDeposit = async ({
    user_id,
    acquiring_system,
    id_in_acquiring_system,
    net_amount_rur,
    received_amount_rur,
    net_amount_usd,
    received_amount_usd,
    our_rur_to_usd_exchange_rate,
    market_rur_to_usd_exchange_rate,
    status,
    wallet_number,
    wallet_type,
    currency_project,
    currency_user
},
acquiring_system_hooks_array_name,
acquiring_system_hook) => {


    const DBClient = await createNewClient()

    try {

        await DBClient.query('BEGIN')

        await DBClient.query('SET TRANSACTION ISOLATION LEVEL SERIALIZABLE')


        if (currency_project !== 'RUB') {
            throw new Error(`We can not handle the .currency_project = "${currency_project}"`)
        }



        /**
         * @ignore
         * @type {{deposit_id: Number}}
         * @desc An unique id of created deposit
         */
        const deposit_creation_result = await DBClient.query(`INSERT INTO deposits 
                (user_id,
                 acquiring_system,
                 id_in_acquiring_system,
                 status,
                 net_amount_rur,
                 net_amount_usd,
                 received_amount_rur,
                 received_amount_usd,
                 our_rur_to_usd_exchange_rate,
                 market_rur_to_usd_exchange_rate,
                 wallet_type,
                 wallet_number,
                 ${acquiring_system_hooks_array_name})
                VALUES  ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13) RETURNING deposit_id, net_amount_usd, user_id`,
        [
            user_id,
            acquiring_system,
            id_in_acquiring_system,
            status,
            net_amount_rur,
            net_amount_usd,
            received_amount_rur,
            received_amount_usd,
            our_rur_to_usd_exchange_rate,
            market_rur_to_usd_exchange_rate,
            wallet_type,
            wallet_number,
            [acquiring_system_hook]
        ])
            .then(res => res.rows[0])

        await DBClient.query('COMMIT')

        return {status: codes.OK, ...deposit_creation_result}

    } catch (e) {
        error('http-server/gamemoney_lib~createDeposit err:', e)
        await DBClient.query('ROLLBACK')
        return {status: codes.FAIL}
    } finally {
        DBClient.release()
    }
}


/**
 *
 * @param status_to_set {String} only 'IN_PROGRESS', 'COMPLETED' and 'RETURNED' are allowed
 * @param acquiring_system {String}, only 'GAME_MONEY' is allowed now
 * @param id_in_acquiring_system {String} unique foreign id with which we identify the hooks
 * @param acquiring_system_hooks_array_name {String} Column where we store raw hooks from acquirer
 * @param acquiring_system_hook {Object} raw hook from acquirer
 * @returns {Promise&lt;{deposit_id: Number, status: number}|{status: number}>}
 */
const updateDepositStatus = async ({status_to_set,  acquiring_system, id_in_acquiring_system}, acquiring_system_hooks_array_name, acquiring_system_hook) => {
    try {

        /**
         * @ignore
         * @type {{deposit_id: Number}}
         */
        const deposit_updating_result = await DB.query(`UPDATE deposits SET status = $1, ${acquiring_system_hooks_array_name} = array_append(${acquiring_system_hooks_array_name}, $2) 
                        WHERE (acquiring_system = $3 AND id_in_acquiring_system = $4) RETURNING deposit_id`,
        [   status_to_set,
            acquiring_system_hook,
            acquiring_system,
            id_in_acquiring_system
        ])
            .then(res => res.rows[0])

        if (deposit_updating_result) {
            return {status: codes.OK, deposit_id: deposit_updating_result.deposit_id}
        } else {
            return {status: codes.NOT_FOUND}
        }


    } catch (e) {
        error('http-server/gamemoney_lib~updateDepositStatus err:', e)
        return {status: codes.FAIL}
    }
}





/**
 * It replaces all GameMoney-specific field names to unified ones
 * before updating the data in DB according the hook data.
 * It returns the unique deposit DB record id for testing purposes.
 * @param hook_data {GameMoneyDepositHook}
 * @returns {Promise&lt;{status: Status, deposit_id: String}|{status: Status}>}
 */
const handleDepositHook = async (hook_data) => {
    try {

        /** payment is not completed, we shouldn't do anything */
        if (hook_data.status === 'New') return {status: codes.OK}


        const our_platform_status = config.GAMEMONEY_DEPOSIT_STATUSES_DICTIONARY[hook_data.status]

        /** for some payment systems Gamemoney acquiring system doesnt send to us the .wallet prop (user's (masked) wallet number) */
        const wallet_number = hook_data.wallet ? hook_data.wallet : '****'

        /**
         * Trying to find and update the existed deposit
         * @type {{status: Status}|{deposit_id: Number, status: Status}}
         */
        const existed_deposit_update_result = await updateDepositStatus({
            status_to_set: our_platform_status,
            id_in_acquiring_system: hook_data.invoice,
            acquiring_system: 'GAME_MONEY'
        },
        'gamemoney_hooks',
        hook_data)

        /**
             * existed deposit updated, our work is done
             * @ignore
             * @type {{status: Status, deposit_id: Number}|{status: String}}
             */
        if (codes.statusEqual(existed_deposit_update_result.status, codes.OK)) {
            return existed_deposit_update_result
        }

        /** deposit not found, time to create a new one
             * @ignore
             * @type {{status: Status, deposit_id: Number}|{status: String}}
             * */
        const new_deposit_creation_result = await createDeposit({
            user_id: hook_data.user,
            acquiring_system: 'GAME_MONEY',
            id_in_acquiring_system: hook_data.invoice,
            net_amount_rur: parseFloat(hook_data.net_amount),
            received_amount_rur: parseFloat(hook_data.received_amount),
            net_amount_usd: (await USD_EXCHANGE_RATE.exchangeRURtoUSD(parseFloat(hook_data.net_amount))).usd_amount,
            received_amount_usd: (await USD_EXCHANGE_RATE.exchangeRURtoUSD(parseFloat(hook_data.received_amount))).usd_amount,
            our_rur_to_usd_exchange_rate: await USD_EXCHANGE_RATE.getTransformedRate(),
            market_rur_to_usd_exchange_rate: await USD_EXCHANGE_RATE.getMarketRate(),
            status: our_platform_status,
            wallet_number,
            wallet_type: hook_data.type,
            currency_project: hook_data.currency_project,
            currency_user: hook_data.currency_user
        },
        'gamemoney_hooks',
        hook_data)


        /** new deposit record created */
        if (codes.statusEqual(new_deposit_creation_result.status, codes.OK)) {
            return new_deposit_creation_result
        }

        /** Smth went wrong, we can not create or update a deposit */
        error(`http-server/plugins/gamemoney_lib~handleDepositHook err: can not create or update deposit using data from hook: ${util.inspect(hook_data)}`)

        return {status: codes.FAIL}


    } catch (e) {
        error('http-server/plugins/gamemoney_lib~handleDepositHook err:', e)
        return {status: codes.FAIL}
    }
}

/**
 *
 * @param {User.user_id} user_id
 * @param {Number} amount_rur
 * @param {Number} [steam_id]
 * @param {String} [steam_trade_url]
 * @param {PaymentMethod} payment_method
 * @param {String} IP - an ip-address of client
 * @returns {Promise&lt;{status: Status, url: String}|{status: Status, desc: String}>}
 */
const generateDepositRedirectUrl = async ({user_id, steam_id, steam_trade_url,  amount_rur, payment_method , IP}) => {
    try {

        if (!user_id) {
            return {status: codes.WRONG_ARGS, desc: '.user_id'}
        }

        if (!amount_rur || isNaN(parseFloat(amount_rur))) {
            return {status: codes.WRONG_ARGS, desc: '.amount'}
        }

        if (!payment_method) {
            return {status: codes.WRONG_ARGS, desc: '.payment_method'}
        }

        if (payment_method.requirements.steam_id_existence &amp;&amp;  !steam_id ) {
            return {status: codes.WRONG_ARGS, desc: '.steam_id'}
        }

        if (payment_method.requirements.steam_trade_url_existence &amp;&amp;  !steam_trade_url ) {
            return {status: codes.WRONG_ARGS, desc: '.steam_trade_url'}
        }

        const invoice_details = {
            project: Number(config.GAMEMONEY_PROJECT_ID),
            type: payment_method.payment_method_name_in_acquiring_system,
            user: user_id,
            ip: IP, /** todo IP*/
            amount: to2DigitsPrecisionFloat(amount_rur),
            comment: 'Инвойс такой-то',
        }

        /** ONLY STEAM ITEMS DEPOSIT ADDITIONAL FIELDS */
        if (payment_method.payment_method_kind === 'STEAM_ITEMS') {

            if (payment_method.payment_method_name_in_acquiring_system === 'skinpay') {


                /** is a .token URL param (String) from user's steam trade url */
                const add_skinpay_token = steam_trade_url.split('token=')[1].split('&amp;')[0].trim()

                const add_steam_id = String(steam_id)

                const wallet = String(steam_id)

                invoice_details.add_skinpay_token = add_skinpay_token

                invoice_details.add_steam_id = add_steam_id

                invoice_details.wallet = wallet

            } else {
                throw new Error(`steam items but not the skinpay. What the hell are you?`)
            }

        }
        /** ******************* **/


        const invoice = await createInvoice(invoice_details)

        if (!invoice || invoice.type !== 'redirect' || !invoice.data) {
            throw new Error(invoice)
        }

        return {
            status: codes.OK,
            redirect_url: invoice.data
        }

    } catch (e) {
        error('http-server/plugins/gamemoney_lib~generateDepositRedirectUrl err:', e)
        return {status: codes.FAIL, desc: 'Unexpected err'}
    }

}



module.exports = {generateHmacSignature, verifyRequestRsaSignature, createInvoice, handleDepositHook, generateDepositRedirectUrl}



























</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> on Mon Feb 08 2021 15:54:23 GMT+0300 (Moscow Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
