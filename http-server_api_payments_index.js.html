<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>http-server/api/payments/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OutgoingMessage.html">OutgoingMessage</a></li><li><a href="Game.html">Game</a></li><li><a href="CrashGame.html">CrashGame</a><ul class='members'><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGame.html#publishUpdatedPlayer">publishUpdatedPlayer</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#handleManualOutDirectives">handleManualOutDirectives</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#autoOutPlayers">autoOutPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outRemainingPlayers">outRemainingPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outPlayers">outPlayers</a></li></ul></li><li><a href="CrashGameDBTransaction.html">CrashGameDBTransaction</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#createSavePoint">createSavePoint</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#rollbackToSavePoint">rollbackToSavePoint</a></li></ul></li><li><a href="GameWin.html">GameWin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="GameWin.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="GameWin.html#.calcWonAmount">calcWonAmount</a></li></ul></li><li><a href="SteamItem.html">SteamItem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SteamItem.html#.fromObject">fromObject</a></li></ul></li><li><a href="module-Games-Game.html">Game</a></li><li><a href="module-Games-SteamItem.html">SteamItem</a></li><li><a href="module-Games-InventoryItem.html">InventoryItem</a></li><li><a href="module-Games-GameWin.html">GameWin</a></li><li><a href="module-Games-GameBet.html">GameBet</a></li><li><a href="module-Games-User.html">User</a></li><li><a href="module-Games-Player.html">Player</a></li></ul><h3>Modules</h3><ul><li><a href="module-access_config.html">access/config</a></li><li><a href="module-access.html">access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-access.html#~encryptString">encryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#.decryptString">decryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#~issueJWTToken">issueJWTToken</a></li></ul></li><li><a href="module-broadcasting-server_config.html">broadcasting-server/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-broadcasting-server_config.html#.PORT">PORT</a></li></ul></li><li><a href="module-ws-server_ws-clients.html">ws-server/ws-clients</a></li><li><a href="module-database_config.html">database/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_ATTEMPTS">RECONNECTION_ATTEMPTS</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_DELAY">RECONNECTION_DELAY</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_CONNECTION_URL">DB_CONNECTION_URL</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_TRANSACTIONS_RETRIES_LIMIT">DB_TRANSACTIONS_RETRIES_LIMIT</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.PG_POOL_QUERIES_VERBOSE_MODE">PG_POOL_QUERIES_VERBOSE_MODE</a></li></ul></li><li><a href="module-database_connection.html">database/connection</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-database_connection.html#~onClientConnected">onClientConnected</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~reconnect">reconnect</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~createNewClient">createNewClient</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~execRepeatableTransaction">execRepeatableTransaction</a></li></ul></li><li><a href="module-http-server_api_accounts.html">http-server/api/accounts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~createLocal">createLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~authenticateLocal">authenticateLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~initEmailConfirmation">initEmailConfirmation</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~confirmEmailWithCode">confirmEmailWithCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~sendPasswordRecoveryCode">sendPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~checkPasswordRecoveryCode">checkPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~issueNewPassword">issueNewPassword</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~getAccountData">getAccountData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~list">list</a></li></ul></li><li><a href="module-http-server_api_oAuth.html">http-server/api/oAuth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateVKRedirect">generateVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleVKRedirect">handleVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateGoogleRedirect">generateGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleGoogleRedirect">handleGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateYandexRedirect">generateYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleYandexRedirect">handleYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~getOpenIdInstanceByReturnUrl">getOpenIdInstanceByReturnUrl</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleSteamRedirect">handleSteamRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~readUserData">readUserData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~endAuthentication">endAuthentication</a></li></ul></li><li><a href="module-http-server_api_payments_freekassa.html">http-server/api/payments/freekassa</a></li><li><a href="module-http-server_api_payments_gamemoney.html">http-server/api/payments/gamemoney</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~generateDepositRedirectSignature">generateDepositRedirectSignature</a></li></ul></li><li><a href="module-http-server_api_payments.html">http-server/api/payments</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~depositRules">depositRules</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~generateDepositRedirect">generateDepositRedirect</a></li></ul></li><li><a href="module-http-server_config.html">http-server/config</a></li><li><a href="module-http-server.html">http-server</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-http-server.html#.API">API</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server.html#~startServe">startServe</a></li><li data-type='method' style='display: none;'><a href="module-http-server.html#~shutDown">shutDown</a></li></ul></li><li><a href="module-http-server_middleware_access.html">http-server/middleware/access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~setAuthCookie">setAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~removeAuthCookie">removeAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~addAuthorizationDataToRequest">addAuthorizationDataToRequest</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessUser">accessUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessAdmin">accessAdmin</a></li></ul></li><li><a href="module-http-server_gamemoney-lib.html">http-server/gamemoney-lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateHmacSignature">generateHmacSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~verifyRequestRsaSignature">verifyRequestRsaSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~createDeposit">createDeposit</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~updateDepositStatus">updateDepositStatus</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateDepositRedirectUrl">generateDepositRedirectUrl</a></li></ul></li><li><a href="module-http-server_health-check.html">http-server/health-check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~updateState">updateState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~getState">getState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpMiddleware">httpMiddleware</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpEndpoint">httpEndpoint</a></li></ul></li><li><a href="module-http-server_mailer.html">http-server/mailer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_mailer.html#~sendMail">sendMail</a></li></ul></li><li><a href="module-http-server_plugins_withdrawals_approval.html">http-server/plugins/withdrawals/approval</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_plugins_withdrawals_approval.html#~checkForWithdrawalsBlockers">checkForWithdrawalsBlockers</a></li></ul></li><li><a href="module-http-server_lib.html">http-server/lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~freezeObjectDeep">freezeObjectDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesSizeOfObject">bytesSizeOfObject</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~asyncInterval">asyncInterval</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~delay">delay</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~compareDeep">compareDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~generateRandomString">generateRandomString</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~minMax">minMax</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~shuffleArray">shuffleArray</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~toFixedPrecisionFloat">toFixedPrecisionFloat</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~to2DigitsPrecisionFloat">to2DigitsPrecisionFloat</a></li></ul></li><li><a href="module-logger.html">logger</a></li><li><a href="module-redis-connection_config.html">redis-connection/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_HOST">REDIS_HOST</a></li><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_PORT">REDIS_PORT</a></li></ul></li><li><a href="module-Games.html">Games</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createLocalAccount">createLocalAccount</a></li><li><a href="global.html#authenticateLocalAccount">authenticateLocalAccount</a></li><li><a href="global.html#fetchAccountData">fetchAccountData</a></li><li><a href="global.html#createAxiosInstance">createAxiosInstance</a></li><li><a href="global.html#createAuthInfrastructure">createAuthInfrastructure</a></li><li><a href="global.html#createWebsocketConnection">createWebsocketConnection</a></li><li><a href="global.html#socketCookieParser">socketCookieParser</a></li><li><a href="global.html#authCookieParser">authCookieParser</a></li><li><a href="global.html#hasAccessUser">hasAccessUser</a></li><li><a href="global.html#hasAccessAdmin">hasAccessAdmin</a></li><li><a href="global.html#util">util</a></li><li><a href="global.html#isMainBroadcastingServer">isMainBroadcastingServer</a></li><li><a href="global.html#MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD">MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD</a></li><li><a href="global.html#BETTING_PERIOD_MS">BETTING_PERIOD_MS</a></li><li><a href="global.html#COMPLETED_PERIOD_MS">COMPLETED_PERIOD_MS</a></li><li><a href="global.html#CRASH_GAME_FRAMES_DELAY_MS">CRASH_GAME_FRAMES_DELAY_MS</a></li><li><a href="global.html#GAME_LOOP_DELAY_AFTER_ERROR_MS">GAME_LOOP_DELAY_AFTER_ERROR_MS</a></li><li><a href="global.html#%2522your-256-bit-secret%2522">"your-256-bit-secret"</a></li><li><a href="global.html#CURRENT_GAME">CURRENT_GAME</a></li><li><a href="global.html#generateFinalMultipliersGroup">generateFinalMultipliersGroup</a></li><li><a href="global.html#activateFinalMultipliersGroup">activateFinalMultipliersGroup</a></li><li><a href="global.html#generateDepositRedirect">generateDepositRedirect</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#Accounts">Accounts</a></li><li><a href="global.html#performInventoryItemWithdrawalStatusUpdateNotificationForUser">performInventoryItemWithdrawalStatusUpdateNotificationForUser</a></li><li><a href="global.html#itemsList">itemsList</a></li><li><a href="global.html#fileParser">fileParser</a></li><li><a href="global.html#CONTENT_TYPES%255Bundefined%255D">CONTENT_TYPES[undefined]</a></li><li><a href="global.html#STEAM_ITEM_ICON_URL_HASHES_CACHE%255Bundefined%255D">STEAM_ITEM_ICON_URL_HASHES_CACHE[undefined]</a></li><li><a href="global.html#freekassaIPVerificationMiddleware">freekassaIPVerificationMiddleware</a></li><li><a href="global.html#freekassaHookSignatureVerificationMiddleware">freekassaHookSignatureVerificationMiddleware</a></li><li><a href="global.html#gamemoneyIPVerificationMiddleware">gamemoneyIPVerificationMiddleware</a></li><li><a href="global.html#gamemoneyHookSignatureVerificationMiddleware">gamemoneyHookSignatureVerificationMiddleware</a></li><li><a href="global.html#skinsBackIPVerificationMiddleware">skinsBackIPVerificationMiddleware</a></li><li><a href="global.html#skinsBackHookSignatureVerificationMiddleware">skinsBackHookSignatureVerificationMiddleware</a></li><li><a href="global.html#unitpayIPVerificationMiddleware">unitpayIPVerificationMiddleware</a></li><li><a href="global.html#unitpayHookSignatureVerificationMiddleware">unitpayHookSignatureVerificationMiddleware</a></li><li><a href="global.html#affiliateExists">affiliateExists</a></li><li><a href="global.html#getAffiliate">getAffiliate</a></li><li><a href="global.html#createNewAffiliate">createNewAffiliate</a></li><li><a href="global.html#performRevshareAccrual">performRevshareAccrual</a></li><li><a href="global.html#createDefaultTariff">createDefaultTariff</a></li><li><a href="global.html#getValidMatchingTariff">getValidMatchingTariff</a></li><li><a href="global.html#MENTION_SUGGESTIONS">MENTION_SUGGESTIONS</a></li><li><a href="global.html#searchMentionedUsers">searchMentionedUsers</a></li><li><a href="global.html#filterProhibitedWords">filterProhibitedWords</a></li><li><a href="global.html#EMOJIS_LIST">EMOJIS_LIST</a></li><li><a href="global.html#generateDepositRedirectUrl">generateDepositRedirectUrl</a></li><li><a href="global.html#handleNewPromocodeActivation">handleNewPromocodeActivation</a></li><li><a href="global.html#handleNewCompletedDeposit">handleNewCompletedDeposit</a></li><li><a href="global.html#generateSignature">generateSignature</a></li><li><a href="global.html#verifyHookSignature">verifyHookSignature</a></li><li><a href="global.html#createOrReplaceDeposit">createOrReplaceDeposit</a></li><li><a href="global.html#Status">Status</a></li><li><a href="global.html#createConnection">createConnection</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#KNOWN_ACQUIRING_SYSTEMS">KNOWN_ACQUIRING_SYSTEMS</a></li><li><a href="global.html#PAYMENT_METHOD_KINDS">PAYMENT_METHOD_KINDS</a></li><li><a href="global.html#PAYMENT_METHOD_ICON_NAMES">PAYMENT_METHOD_ICON_NAMES</a></li><li><a href="global.html#PaymentMethod">PaymentMethod</a></li><li><a href="global.html#depositRules">depositRules</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">http-server/api/payments/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * This part of http-server-api contains handlers
 * for all user/admins actions which affect
 * the finances, for e.g the deposit redirects,
 * deposit hooks from acquirers, withdraws requests etc.
 * @module http-server/api/payments
 */

const Express = require('express')
const GamemoneyRoutes = require('./gamemoney.js')
const SkinsbackRoutes = require('./skinsback.js')
const UnitpayRoutes = require('./unitpay.js')
const FreeKassaRoutes = require('./freekassa.js')
const {accessAdmin, accessUser} = require('../../middleware/access.js')
const {codes} = require('status-codes')
const {DB} = require('../../../database/connection.js')
const {config} = require('../../config.js')
const {error} = require('../../../logger/index.js')
const {USD_EXCHANGE_RATE} = require('../../plugins/currencies.js')
const SkinsBackLib = require('../../plugins/skinsback-lib.js')
const FreeKassaLib = require('../../plugins/freekassa-lib.js')
const GameMoneyLib = require( '../../plugins/gamemoney-lib.js')
const {to2DigitsPrecisionFloat} = require('../../../lib.js')


const router = Express.Router()


router.use('/gamemoney', GamemoneyRoutes)
router.use('/skinsback', SkinsbackRoutes)
router.use('/unitpay', UnitpayRoutes)
router.use('/freekassa', FreeKassaRoutes)


/**
 * @module Payments
 * @desc It returns all info we need to display the deposit modal
 * @function depositRules
 * @path {GET} /api/payments/deposit-rules
 * @chain {@link module:http-server/middleware/access~addAuthorizationDataToRequest}
 * @chain {@link module:http-server/middleware/access~accessUser}
 * @chain this endpoint
 * @response {codes.OK} status - if success
 * @response {PaymentMethod[]} payment_methods - if success
 * @response {Number} USD_EXCHANGE_RATE - if success
 * @response {codes.FORBIDDEN} status - if not authorized
 * @response {codes.FAIL} status - if internal error
 */
const depositRules = async (req, res) => {
    try {

        const payment_methods = await DB.query(`
            SELECT payment_method_name,
                   payment_method_kind,
                   payment_method_icon_name,
                   requirements,
                   limits,
                   active
            FROM payment_methods`)
            .then(r => r.rows)


        return res.json({
            status: codes.OK,
            USD_EXCHANGE_RATE: await USD_EXCHANGE_RATE.getTransformedRate(),
            payment_methods
        })


    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


/**
 * @module Payments
 * @desc It returns the absolute url to the acquiring system side where user can complete his deposit
 * @function generateDepositRedirect
 * @path {POST} /api/payments/generate-deposit-redirect
 * @chain {@link module:http-server/middleware/access~addAuthorizationDataToRequest}
 * @chain {@link module:http-server/middleware/access~accessUser}
 * @chain this endpoint
 * @body {PaymentMethod.payment_method_name} payment_method_name
 * @body {Number} [phone_number] - phone number typed in by user, in numbers-only format (better starting it from "7" for RU numbers);
 * is required if .phone_number_input is listed into the PaymentMethod.requirements property
 * @body {Number} [amount_rur] - amount typed in by user; is required if .amount_rur_input is listed into the PaymentMethod.requirements property
 * @response {codes.OK} status - if success
 * @response {String} redirect_url - if success; is an absolute url to which u need to redirect user;
 * @response {codes.WRONG_ARGS} status - if .payment_method_name is not provided
 * @response {codes.WRONG_ARGS} status - if .amount_rur_input is listed into the PaymentMethod.requirements but .amount_rur is not provided
 * @response {codes.WRONG_ARGS} status - if .phone_number_input is listed into the PaymentMethod but the .phone_number is not provided or is incorrect
 * @response {codes.NOT_FOUND} status - if the PaymentMethod with provided .payment_method_name does not exists
 * @response {codes.INCORRECT_STATE} status - if PaymentMethod.active is not true
 * @response {codes.payments.INCORRECT_DEPOSIT_AMOUNT} status - if you ignore the PaymentMethod.limits content
 * @response {codes.INCORRECT_STATE} status - if .steam_id_existence is listed in PaymentMethod.requirements and user has no .steam_id specified
 * @response {codes.INCORRECT_STATE} status - if .steam_trade_url_existence is listed in PaymentMethod.requirements and user has no .steam_trade_url specified
 * @response {String} desc - on any business-logic level err; it contains the debug information for dev purposes.
 * @response {codes.FORBIDDEN} status - if not authorized
 * @response {codes.FAIL} status - if internal error
 */
const generateDepositRedirect = async (req, res) => {
    try {

        const {amount_rur, payment_method_name, phone_number } = req.body

        if (!payment_method_name) {
            return res.json({
                status: codes.WRONG_ARGS,
                desc: '.payment_method_name'
            })
        }

        if (amount_rur &amp;&amp; isNaN(parseFloat(amount_rur))) {
            return res.json({
                status: codes.WRONG_ARGS,
                desc: '.amount_rur'
            })
        }

        const {user_id} = req.account_data


        /**
         * @type PaymentMethod
         */
        const payment_method = await DB.query(`SELECT * FROM payment_methods WHERE payment_method_name = $1`, [
            payment_method_name
        ])
            .then(r => r.rows[0])

        /** validation of the payment method existence and state */
        if (!payment_method) {
            return res.json({status: codes.NOT_FOUND, desc: 'payment method does not exists'})
        }

        if (!payment_method.active) {
            return res.json({status: codes.INCORRECT_STATE, desc: 'payment method is not in .active state'})
        }

        /** **/


        /** matching the provided body params with the payment method requirements */

        /** amount &amp;&amp; limits */
        if (payment_method.requirements.amount_rur_input) {

            if (!amount_rur || isNaN(parseFloat(amount_rur))) {
                return res.json({
                    status: codes.WRONG_ARGS,
                    desc: '.amount_rur'
                })
            }


            if (payment_method.limits.min_deposit_amount_rur ) {

                if (to2DigitsPrecisionFloat(amount_rur) &lt; to2DigitsPrecisionFloat(payment_method.limits.min_deposit_amount_rur)) {
                    return res.json({status: codes.payments.INCORRECT_DEPOSIT_AMOUNT, desc: 'too low'})
                }
            }

            if (payment_method.limits.max_deposit_amount_rur ) {

                if (to2DigitsPrecisionFloat(amount_rur) > to2DigitsPrecisionFloat(payment_method.limits.max_deposit_amount_rur)) {
                    return res.json({status: codes.payments.INCORRECT_DEPOSIT_AMOUNT, desc: 'too high'})
                }
            }

        }


        /** mobile phone input **/
        if (payment_method.requirements.phone_number_input) {

            /** todo: add regexp validation */
            if (!phone_number || isNaN(parseInt(phone_number))) {
                return res.json({status: codes.WRONG_ARGS, desc: '.phone_number_input'})
            }

        }

        let steam_id, steam_trade_url

        /** steam_id / steam_trade url */
        if (payment_method.requirements.steam_id_existence || payment_method.requirements.steam_trade_url_existence) {

            const data_from_user_account = await DB.query(`
                    SELECT steam_id, steam_trade_url FROM users WHERE user_id = $1`, [
                user_id
            ])
                .then(r => r.rows[0])

            steam_id = data_from_user_account.steam_id
            steam_trade_url = data_from_user_account.steam_trade_url

            if (payment_method.requirements.steam_id_existence &amp;&amp; !steam_id) {
                return res.json({status: codes.INCORRECT_STATE, desc: '.steam_id existence'})
            }

            if (payment_method.requirements.steam_trade_url_existence &amp;&amp; !steam_trade_url) {
                return res.json({status: codes.INCORRECT_STATE, desc: '.steam_trade_url existence'})
            }
        }

        /** **/


        if (payment_method.acquiring_system === 'SKINSBACK') {
            return res.json(await SkinsBackLib.generateDepositRedirectUrl({user_id, steam_id, steam_trade_url}))
        }

        if (payment_method.acquiring_system === 'FREE_KASSA') {
            return res.json(await FreeKassaLib.generateDepositRedirectUrl({user_id, amount_rur, phone_number, payment_method}))
        }

        if (payment_method.acquiring_system === 'GAME_MONEY') {

            /** gamemoney acquirer requires a client IP */
            const IP = process.env.NODE_ENV === 'production' ? req.IP : '46.101.149.106' // fixed IP for development purposes

            return res.json(await GameMoneyLib.generateDepositRedirectUrl({user_id, amount_rur, payment_method, steam_id, steam_trade_url, IP, phone_number}))
        }


        throw new Error(`No deposit redirect url generator for .acquiring_system "${payment_method.acquiring_system}"`)

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL, desc: 'Unexpected err'})
    }
}



router.get('/deposit-rules', accessUser, depositRules)
router.post('/generate-deposit-redirect', accessUser, generateDepositRedirect)


const depositsList = async (req, res) => {
    try {

        const { offset = 0, limit = 15, sorting_property = 'd.created_at', sorting_direction = 'DESC'}  = req.query

        const created_at_from = req.query.created_at &amp;&amp; req.query.created_at.from &amp;&amp; new Date(req.query.created_at.from).toString() !== 'Incorrect Date' ? new Date(req.query.created_at.from) : null
        const created_at_to = req.query.created_at &amp;&amp; req.query.created_at.to &amp;&amp; new Date(req.query.created_at.to).toString() !== 'Incorrect Date' ? new Date(req.query.created_at.to) : null
        const username = req.query.username &amp;&amp; req.query.username.trim() ? `%${req.query.username.trim()}%` : null
        const wallet_number = req.query.wallet_number &amp;&amp; String(req.query.wallet_number).trim() ? `%${String(req.query.wallet_number).trim()}%` : null
        const deposit_id = req.query.deposit_id &amp;&amp; !isNaN(Number(req.query.deposit_id)) ? String(req.query.deposit_id).trim() : null
        const acquiring_system = req.query.acquiring_system ? req.query.acquiring_system : null
        const id_in_acquiring_system = req.query.id_in_acquiring_system &amp;&amp; String(req.query.id_in_acquiring_system).trim() ? String(req.query.id_in_acquiring_system).trim() : null
        const received_amount_usd_from = req.query.received_amount_usd &amp;&amp;  req.query.received_amount_usd.from ? req.query.received_amount_usd.from : null
        const received_amount_usd_to = req.query.received_amount_usd &amp;&amp;  req.query.received_amount_usd.to ? req.query.received_amount_usd.to : null
        const net_amount_usd_from = req.query.net_amount_usd &amp;&amp;  req.query.net_amount_usd.from ? req.query.net_amount_usd.from : null
        const net_amount_usd_to = req.query.net_amount_usd &amp;&amp;  req.query.net_amount_usd.to ? req.query.net_amount_usd.to : null
        const status = req.query.status &amp;&amp; req.query.status.trim() ? req.query.status.trim() : null

        const deposits = await DB.query(`
            SELECT 
                    (count(*) OVER())::INTEGER AS total_found,
                   d.*,
                   u.username,
                   u.avatar_link
            FROM deposits d
            LEFT JOIN users u
                ON (d.user_id = u.user_id)
            WHERE 
            ($1::TIMESTAMPTZ IS NULL OR d.created_at >= $1::TIMESTAMPTZ)
            AND
            ($2::TIMESTAMPTZ IS NULL OR d.created_at &lt; $2::TIMESTAMPTZ)
            AND
            ($3::TEXT IS NULL OR LOWER(u.username COLLATE "ru_RU.utf8") LIKE LOWER($3::TEXT COLLATE "ru_RU.utf8"))
            AND
            ($4::TEXT IS NULL OR LOWER(d.wallet_number COLLATE "ru_RU.utf8") LIKE LOWER($4::TEXT COLLATE "ru_RU.utf8"))
            AND
            ($5::BIGINT IS NULL OR d.deposit_id = $5::BIGINT)
            AND
            ($6::KNOWN_ACQUIRING_SYSTEMS IS NULL OR d.acquiring_system = $6::KNOWN_ACQUIRING_SYSTEMS)
            AND
            ($7::TEXT IS NULL OR d.id_in_acquiring_system = $7::TEXT)
            AND
            ($8::NUMERIC(16,2) IS NULL OR d.received_amount_usd >= $8::NUMERIC(16,2))
            AND
            ($9::NUMERIC(16,2) IS NULL OR d.received_amount_usd &lt;= $9::NUMERIC(16,2))
            AND
            ($10::NUMERIC(16,2) IS NULL OR d.net_amount_usd >= $10::NUMERIC(16,2))
            AND
            ($11::NUMERIC(16,2) IS NULL OR d.net_amount_usd &lt;= $11::NUMERIC(16,2))
            AND
            ($12::DEPOSIT_STATUSES IS NULL OR d.status = $12::DEPOSIT_STATUSES)
            ORDER BY ${sorting_property} ${sorting_direction}
            OFFSET $13
            LIMIT $14
        `, [
            created_at_from,
            created_at_to,
            username,
            wallet_number,
            deposit_id,
            acquiring_system,
            id_in_acquiring_system,
            received_amount_usd_from,
            received_amount_usd_to,
            net_amount_usd_from,
            net_amount_usd_to,
            status,
            offset,
            limit
        ])
            .then(r => r.rows)

        return res.json({status: codes.OK, deposits})

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}

router.get('/deposits/list', accessAdmin({FINANCE: true}), depositsList)

module.exports = router
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> on Mon Feb 08 2021 15:54:23 GMT+0300 (Moscow Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
