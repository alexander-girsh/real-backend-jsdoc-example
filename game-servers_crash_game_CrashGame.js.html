<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>game-servers/crash/game/CrashGame.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OutgoingMessage.html">OutgoingMessage</a></li><li><a href="Game.html">Game</a></li><li><a href="CrashGame.html">CrashGame</a><ul class='members'><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGame.html#publishUpdatedPlayer">publishUpdatedPlayer</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#handleManualOutDirectives">handleManualOutDirectives</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#autoOutPlayers">autoOutPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outRemainingPlayers">outRemainingPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outPlayers">outPlayers</a></li></ul></li><li><a href="CrashGameDBTransaction.html">CrashGameDBTransaction</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#createSavePoint">createSavePoint</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#rollbackToSavePoint">rollbackToSavePoint</a></li></ul></li><li><a href="GameWin.html">GameWin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="GameWin.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="GameWin.html#.calcWonAmount">calcWonAmount</a></li></ul></li><li><a href="SteamItem.html">SteamItem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SteamItem.html#.fromObject">fromObject</a></li></ul></li><li><a href="module-Games-Game.html">Game</a></li><li><a href="module-Games-SteamItem.html">SteamItem</a></li><li><a href="module-Games-InventoryItem.html">InventoryItem</a></li><li><a href="module-Games-GameWin.html">GameWin</a></li><li><a href="module-Games-GameBet.html">GameBet</a></li><li><a href="module-Games-User.html">User</a></li><li><a href="module-Games-Player.html">Player</a></li></ul><h3>Modules</h3><ul><li><a href="module-access_config.html">access/config</a></li><li><a href="module-access.html">access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-access.html#~encryptString">encryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#.decryptString">decryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#~issueJWTToken">issueJWTToken</a></li></ul></li><li><a href="module-broadcasting-server_config.html">broadcasting-server/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-broadcasting-server_config.html#.PORT">PORT</a></li></ul></li><li><a href="module-ws-server_ws-clients.html">ws-server/ws-clients</a></li><li><a href="module-database_config.html">database/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_ATTEMPTS">RECONNECTION_ATTEMPTS</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_DELAY">RECONNECTION_DELAY</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_CONNECTION_URL">DB_CONNECTION_URL</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_TRANSACTIONS_RETRIES_LIMIT">DB_TRANSACTIONS_RETRIES_LIMIT</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.PG_POOL_QUERIES_VERBOSE_MODE">PG_POOL_QUERIES_VERBOSE_MODE</a></li></ul></li><li><a href="module-database_connection.html">database/connection</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-database_connection.html#~onClientConnected">onClientConnected</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~reconnect">reconnect</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~createNewClient">createNewClient</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~execRepeatableTransaction">execRepeatableTransaction</a></li></ul></li><li><a href="module-http-server_api_accounts.html">http-server/api/accounts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~createLocal">createLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~authenticateLocal">authenticateLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~initEmailConfirmation">initEmailConfirmation</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~confirmEmailWithCode">confirmEmailWithCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~sendPasswordRecoveryCode">sendPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~checkPasswordRecoveryCode">checkPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~issueNewPassword">issueNewPassword</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~getAccountData">getAccountData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~list">list</a></li></ul></li><li><a href="module-http-server_api_oAuth.html">http-server/api/oAuth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateVKRedirect">generateVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleVKRedirect">handleVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateGoogleRedirect">generateGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleGoogleRedirect">handleGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateYandexRedirect">generateYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleYandexRedirect">handleYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~getOpenIdInstanceByReturnUrl">getOpenIdInstanceByReturnUrl</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleSteamRedirect">handleSteamRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~readUserData">readUserData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~endAuthentication">endAuthentication</a></li></ul></li><li><a href="module-http-server_api_payments_freekassa.html">http-server/api/payments/freekassa</a></li><li><a href="module-http-server_api_payments_gamemoney.html">http-server/api/payments/gamemoney</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~generateDepositRedirectSignature">generateDepositRedirectSignature</a></li></ul></li><li><a href="module-http-server_api_payments.html">http-server/api/payments</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~depositRules">depositRules</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~generateDepositRedirect">generateDepositRedirect</a></li></ul></li><li><a href="module-http-server_config.html">http-server/config</a></li><li><a href="module-http-server.html">http-server</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-http-server.html#.API">API</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server.html#~startServe">startServe</a></li><li data-type='method' style='display: none;'><a href="module-http-server.html#~shutDown">shutDown</a></li></ul></li><li><a href="module-http-server_middleware_access.html">http-server/middleware/access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~setAuthCookie">setAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~removeAuthCookie">removeAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~addAuthorizationDataToRequest">addAuthorizationDataToRequest</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessUser">accessUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessAdmin">accessAdmin</a></li></ul></li><li><a href="module-http-server_gamemoney-lib.html">http-server/gamemoney-lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateHmacSignature">generateHmacSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~verifyRequestRsaSignature">verifyRequestRsaSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~createDeposit">createDeposit</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~updateDepositStatus">updateDepositStatus</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateDepositRedirectUrl">generateDepositRedirectUrl</a></li></ul></li><li><a href="module-http-server_health-check.html">http-server/health-check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~updateState">updateState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~getState">getState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpMiddleware">httpMiddleware</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpEndpoint">httpEndpoint</a></li></ul></li><li><a href="module-http-server_mailer.html">http-server/mailer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_mailer.html#~sendMail">sendMail</a></li></ul></li><li><a href="module-http-server_plugins_withdrawals_approval.html">http-server/plugins/withdrawals/approval</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_plugins_withdrawals_approval.html#~checkForWithdrawalsBlockers">checkForWithdrawalsBlockers</a></li></ul></li><li><a href="module-http-server_lib.html">http-server/lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~freezeObjectDeep">freezeObjectDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesSizeOfObject">bytesSizeOfObject</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~asyncInterval">asyncInterval</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~delay">delay</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~compareDeep">compareDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~generateRandomString">generateRandomString</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~minMax">minMax</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~shuffleArray">shuffleArray</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~toFixedPrecisionFloat">toFixedPrecisionFloat</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~to2DigitsPrecisionFloat">to2DigitsPrecisionFloat</a></li></ul></li><li><a href="module-logger.html">logger</a></li><li><a href="module-redis-connection_config.html">redis-connection/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_HOST">REDIS_HOST</a></li><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_PORT">REDIS_PORT</a></li></ul></li><li><a href="module-Games.html">Games</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createLocalAccount">createLocalAccount</a></li><li><a href="global.html#authenticateLocalAccount">authenticateLocalAccount</a></li><li><a href="global.html#fetchAccountData">fetchAccountData</a></li><li><a href="global.html#createAxiosInstance">createAxiosInstance</a></li><li><a href="global.html#createAuthInfrastructure">createAuthInfrastructure</a></li><li><a href="global.html#createWebsocketConnection">createWebsocketConnection</a></li><li><a href="global.html#socketCookieParser">socketCookieParser</a></li><li><a href="global.html#authCookieParser">authCookieParser</a></li><li><a href="global.html#hasAccessUser">hasAccessUser</a></li><li><a href="global.html#hasAccessAdmin">hasAccessAdmin</a></li><li><a href="global.html#util">util</a></li><li><a href="global.html#isMainBroadcastingServer">isMainBroadcastingServer</a></li><li><a href="global.html#MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD">MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD</a></li><li><a href="global.html#BETTING_PERIOD_MS">BETTING_PERIOD_MS</a></li><li><a href="global.html#COMPLETED_PERIOD_MS">COMPLETED_PERIOD_MS</a></li><li><a href="global.html#CRASH_GAME_FRAMES_DELAY_MS">CRASH_GAME_FRAMES_DELAY_MS</a></li><li><a href="global.html#GAME_LOOP_DELAY_AFTER_ERROR_MS">GAME_LOOP_DELAY_AFTER_ERROR_MS</a></li><li><a href="global.html#%2522your-256-bit-secret%2522">"your-256-bit-secret"</a></li><li><a href="global.html#CURRENT_GAME">CURRENT_GAME</a></li><li><a href="global.html#generateFinalMultipliersGroup">generateFinalMultipliersGroup</a></li><li><a href="global.html#activateFinalMultipliersGroup">activateFinalMultipliersGroup</a></li><li><a href="global.html#generateDepositRedirect">generateDepositRedirect</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#Accounts">Accounts</a></li><li><a href="global.html#performInventoryItemWithdrawalStatusUpdateNotificationForUser">performInventoryItemWithdrawalStatusUpdateNotificationForUser</a></li><li><a href="global.html#itemsList">itemsList</a></li><li><a href="global.html#fileParser">fileParser</a></li><li><a href="global.html#CONTENT_TYPES%255Bundefined%255D">CONTENT_TYPES[undefined]</a></li><li><a href="global.html#STEAM_ITEM_ICON_URL_HASHES_CACHE%255Bundefined%255D">STEAM_ITEM_ICON_URL_HASHES_CACHE[undefined]</a></li><li><a href="global.html#freekassaIPVerificationMiddleware">freekassaIPVerificationMiddleware</a></li><li><a href="global.html#freekassaHookSignatureVerificationMiddleware">freekassaHookSignatureVerificationMiddleware</a></li><li><a href="global.html#gamemoneyIPVerificationMiddleware">gamemoneyIPVerificationMiddleware</a></li><li><a href="global.html#gamemoneyHookSignatureVerificationMiddleware">gamemoneyHookSignatureVerificationMiddleware</a></li><li><a href="global.html#skinsBackIPVerificationMiddleware">skinsBackIPVerificationMiddleware</a></li><li><a href="global.html#skinsBackHookSignatureVerificationMiddleware">skinsBackHookSignatureVerificationMiddleware</a></li><li><a href="global.html#unitpayIPVerificationMiddleware">unitpayIPVerificationMiddleware</a></li><li><a href="global.html#unitpayHookSignatureVerificationMiddleware">unitpayHookSignatureVerificationMiddleware</a></li><li><a href="global.html#affiliateExists">affiliateExists</a></li><li><a href="global.html#getAffiliate">getAffiliate</a></li><li><a href="global.html#createNewAffiliate">createNewAffiliate</a></li><li><a href="global.html#performRevshareAccrual">performRevshareAccrual</a></li><li><a href="global.html#createDefaultTariff">createDefaultTariff</a></li><li><a href="global.html#getValidMatchingTariff">getValidMatchingTariff</a></li><li><a href="global.html#MENTION_SUGGESTIONS">MENTION_SUGGESTIONS</a></li><li><a href="global.html#searchMentionedUsers">searchMentionedUsers</a></li><li><a href="global.html#filterProhibitedWords">filterProhibitedWords</a></li><li><a href="global.html#EMOJIS_LIST">EMOJIS_LIST</a></li><li><a href="global.html#generateDepositRedirectUrl">generateDepositRedirectUrl</a></li><li><a href="global.html#handleNewPromocodeActivation">handleNewPromocodeActivation</a></li><li><a href="global.html#handleNewCompletedDeposit">handleNewCompletedDeposit</a></li><li><a href="global.html#generateSignature">generateSignature</a></li><li><a href="global.html#verifyHookSignature">verifyHookSignature</a></li><li><a href="global.html#createOrReplaceDeposit">createOrReplaceDeposit</a></li><li><a href="global.html#Status">Status</a></li><li><a href="global.html#createConnection">createConnection</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#KNOWN_ACQUIRING_SYSTEMS">KNOWN_ACQUIRING_SYSTEMS</a></li><li><a href="global.html#PAYMENT_METHOD_KINDS">PAYMENT_METHOD_KINDS</a></li><li><a href="global.html#PAYMENT_METHOD_ICON_NAMES">PAYMENT_METHOD_ICON_NAMES</a></li><li><a href="global.html#PaymentMethod">PaymentMethod</a></li><li><a href="global.html#depositRules">depositRules</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">game-servers/crash/game/CrashGame.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const {DB} = require( '../../../database/connection.js')
const {codes} = require( 'status-codes')
const {error, info} = require( '../../../logger/index.js')
const {delay, generateRandomString} = require( '../../../lib.js')
const {nats} = require( 'nats-connection/index.cjs')
const {CrashGameMultiplier} = require( './CrashGameMultiplier.js')
const {CrashGamePlayer} = require( './CrashGamePlayer.js')
const JWT = require( 'jsonwebtoken')
const {config} = require('../config.js')
const {CrashGameDBTransaction} = require('./CrashGameDBTransaction.js')


/**
 * @abstract
 * @class Game
 */


/**
 * @extends Game
 */
class CrashGame {

    /**
     * @type { CrashGamePlayer[] }
     */
    #players = []

    /**
     * @type Number
     */
    #game_id

    /**
     * @type Date
     */
    #created_at

    /**
     * @type Date
     */
    #started_at

    /**
     * @type Date
     */
    #completed_at


    /**
     * @type { CrashGameMultiplier }
     */
    #final_multiplier

    /**
     * @enum String
     */
    #status = 'CREATED'

    /**
     * @type String
     */
    #game_type = 'CRASH'

    /**
     * @type { CrashGameMultiplier }
     */
    #current_multiplier = new CrashGameMultiplier(1)


    /**
     * @type {Nats.Subscription}
     */
    #join_subscription

    /**
     * @type {Nats.Subscription}
     */
    #out_subscription

    /**
     * @type Number
     */
    #betting_period_end_timestamp


    /**
     * @const
     * @type String
     */
    #token


    #bets_under_processing = 0

    #was_ran = false

    /**
     * @type {CrashGameDBTransaction}
     */
    #db_transaction

    /**
     * @desc A flag that describes that the game-level db transaction will be rolled back at game end.
     * @type {Boolean}
     */
    #has_fatal_error = false


    /**
     * @type {CrashGameDBTransaction.client}
     */
    #client

    /**
     * @type {Object}
     */
    #processing_players_user_ids = {}
    /**
     * @type {Object}
     */
    #joined_players_user_ids = {}


    /**
     * @param game_id
     * @param created_at
     * @param started_at
     * @param completed_at
     * @param {CrashGameMultiplier} final_multiplier
     * @param status
     * @param token
     * @param {CrashGameDBTransaction} db_transaction - game-level db transaction
     */
    constructor ({game_id, created_at, started_at, completed_at, final_multiplier, status, token}, {db_transaction, client}) {


        if (!game_id || !created_at || !final_multiplier || !status || !token || !db_transaction) {
            throw new Error(codes.WRONG_ARGS)
        }

        this.#game_id = game_id
        this.#created_at = created_at
        this.#started_at = started_at ? started_at : null
        this.#completed_at = completed_at ? completed_at : null
        this.#final_multiplier = final_multiplier
        this.#status = status
        this.#token = token
        this.#db_transaction = db_transaction
        this.#client = client

    }

    static async create () {

        let db_transaction

        try {

            const db_transaction_creation_result = await CrashGame.startGameLevelDBTransaction()

            if (!codes.statusEqual(db_transaction_creation_result.status, codes.OK)) {
                error(`Unable to create CrashGameDBTransaction, status: ${JSON.stringify(db_transaction_creation_result.status)}`)
                return {
                    status: db_transaction_creation_result.status
                }
            }

            db_transaction = db_transaction_creation_result.db_transaction

            const final_multiplier_selection_result = await CrashGameMultiplier.fromDB({db_transaction})

            if (!codes.statusEqual(final_multiplier_selection_result.status, codes.OK)) {
                error(`Unable to select the random final_multiplier`)
                await db_transaction.rollback()
                await db_transaction.end()
            }

            const {final_multiplier} = final_multiplier_selection_result

            const token_secure_key = generateRandomString(96)

            const token = await JWT.sign({
                crash_point: final_multiplier.to2NumbersPrecisionFloat, /** .crash_point is the most popular alias for .final_multiplier */
                'your-256-bit-secret': token_secure_key
            }, token_secure_key, {algorithm: 'HS512'})


            const random_client = db_transaction.randomClient()


            const game = await random_client.query(`INSERT INTO games (final_multiplier_id, status, game_type, token)
                                                 VALUES ($1, 'CREATED', 'CRASH', $2)
                                                 RETURNING *`, [
                final_multiplier.finalMultiplierId,
                token
            ])
                .then(r => r.rows[0])

            await random_client.query(`
                COMMIT;
                BEGIN;
                START TRANSACTION; 
                SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
            `)

            return {status: codes.OK, game: new CrashGame({...game, final_multiplier, token}, {db_transaction, client: random_client})}


        } catch (e) {
            error('games/crash/createGame() err:', e)

            if (db_transaction) {
                await db_transaction.rollback()
                await db_transaction.end()
            }

            throw e
        }
    }




    async* run () {

        try {

            this.#was_ran = true

            info(`game #${this.#game_id} is running, frame delay is ${config.CRASH_GAME_FRAMES_DELAY_MS}ms`)

            /**
             * @type {number}
             */
            this.#betting_period_end_timestamp = Date.now() + config.BETTING_PERIOD_MS


            this.publishUpdatedGameStatus()

            /** publishing list of players which was added previously */
            this.playersIn.forEach(p => this.publishUpdatedPlayer(p))


            /** AWAITING FOR BETS*/
            await new Promise((resolve) => {
                setTimeout(() => {
                    resolve()
                }, Math.trunc(this.bettingPeriodEndTimestamp - Date.now()))
            })

            while (this.someBetsAreUnderProcessing) {
                await delay(config.CRASH_GAME_FRAMES_DELAY_MS)
            }

            await this.setStatusInProgress()


            /** CrashGameLoop instance needs for this yield
             *  to start the awaiting of bets on the next CrashGame instance */
            yield {game_status: this.status}

            /** ************** */



            /** MULTIPLIER INCREMENTING PERIOD */
            const period_start_time = this.startedAt.getTime()


            this.createOutSubscription()

            while (this.#current_multiplier.to2NumbersPrecisionFloat &lt; this.#final_multiplier.value) {

                const game_already_on_for = Date.now() - period_start_time

                this.#current_multiplier = this.#current_multiplier.increment(this.#final_multiplier, game_already_on_for)

                this.autoOutPlayers(new CrashGameMultiplier(this.currentMultiplier.to2NumbersPrecisionFloat))

                await delay(config.CRASH_GAME_FRAMES_DELAY_MS)

                this.handleManualOutDirectives(new CrashGameMultiplier(this.currentMultiplier.to2NumbersPrecisionFloat))

            }

            console.log(Date.now())
            /** ****************************** */

            /** GAME CRASH PERIOD */

            this.#current_multiplier = new CrashGameMultiplier(0)

            this.outRemainingPlayers(new CrashGameMultiplier(this.currentMultiplier.to2NumbersPrecisionFloat))

            await this.setStatusCompleted()

            while (this.someBetsAreUnderProcessing) {
                await delay(config.CRASH_GAME_FRAMES_DELAY_MS)
            }


            if (this.hasFatalError === false) {
                info(`game #${this.gameId} has no errors, committing DB transactions...`)
                await this.commitGameLevelDBTransaction()
            } else {
                info(`game #${this.gameId} has a fatal error, rolling back DB transactions...`)
                await this.rollbackGameLevelDBTransaction()
            }

            await delay(config.COMPLETED_PERIOD_MS)

            /** ***************** */


        } catch (e) {
            error('games/crash/run() err:', e)
            throw e
        }

    }


    createJoinSubscription () {
        this.#join_subscription = nats.subscribe(`REQUEST.GAMES.CRASH.join`, async (request_data, reply) => {
            nats.publish(reply, await this.join(request_data))
        })
    }

    removeJoinSubscription () {
        nats.unsubscribe(this.#join_subscription)
    }


    createOutSubscription () {
        this.#out_subscription = nats.subscribe('REQUEST.GAMES.CRASH.out', async (request_data, reply) => {

            const {user_id} = request_data

            if (!user_id || isNaN(parseInt(user_id))) {
                return nats.publish(reply, {status: codes.WRONG_ARGS})
            }

            const player = this.#players.find((p) => String(p.userId) === String(user_id))

            if (!player) {
                return nats.publish(reply, {status: codes.NOT_FOUND})
            }

            if (!player.outProcessingStarted &amp;&amp; !player.outDirectiveAdded) {
                player.addOutDirective()
            }

            nats.publish(reply, {status: codes.OK})

        })
    }

    removeOutSubscription () {
        nats.unsubscribe(this.#out_subscription)
    }


    async join (request_data) {

        let user_id

        try {

            if (!request_data || !request_data.user_id) {
                return {status: codes.WRONG_ARGS}
            }

            this.betsUnderProcessing++

            if (this.status !== 'CREATED') {
                return {status: codes.INCORRECT_STATE}
            }

            user_id = String(request_data.user_id)

            /** user is already in game or join request already is proceed */
            if (this.#processing_players_user_ids[user_id] ||
                this.#joined_players_user_ids[user_id]) {
                return {status: codes.ALREADY_DONE}
            }

            this.#processing_players_user_ids[user_id] = true


            const {status, player} = await CrashGamePlayer.create({...request_data, game_id: this.gameId}, {db_transaction: this.DBTransaction})

            if (!codes.statusEqual(status, codes.OK)) {
                return {status}
            }

            this.#players.push(player)

            this.#joined_players_user_ids[user_id] = true

            if (this.#was_ran) {
                this.publishUpdatedPlayer(player)
            }

            return {status, game_id: this.gameId, bet_amount: player.bet.amount}

        } catch (e) {
            error('games/crash/join() err:', e)
            this.hasFatalError = true
            return {status: codes.FAIL}
        } finally {
            this.betsUnderProcessing--
            delete this.#processing_players_user_ids[user_id]
        }
    }

    publishUpdatedGameStatus () {
        nats.publish('PUBLIC.GAMES.CRASH.STATUS_UPDATE', {
            status: this.status,
            token_signature: this.status === 'CREATED' ? this.tokenSignature : null,
            game_id: this.gameId,
            started_at: this.startedAt,
            completed_at: this.completedAt,
            token: this.status === 'COMPLETED' ? this.token : null,
            final_multiplier: this.status === 'COMPLETED' ? this.finalMultiplier.to2NumbersPrecisionFloat : null,
            betting_period_end_timestamp: this.status === 'CREATED' ? this.bettingPeriodEndTimestamp : null,
            message_sent_at_ms_timestamp: Date.now()
        })
    }

    /**
     * @param {CrashGamePlayer} updated_player
     */
    publishUpdatedPlayer (updated_player) {
        nats.publish('PUBLIC.GAMES.CRASH.PLAYER_UPDATE', {
            player: updated_player.publicInfo
        })
    }

    async setStatusInProgress () {

        try {
            this.#started_at = new Date()
            this.#status = 'IN_PROGRESS'

            const result = await this.#client.query(`UPDATE games SET status = 'IN_PROGRESS', started_at =  $1 WHERE game_id = $2`, [
                this.#started_at,
                this.#game_id
            ])

            if (!result.rowCount) {
                return {status: codes.IMPOSSIBLE}
            }

            this.publishUpdatedGameStatus()

            return {status: codes.OK}
        } catch (err) {
            error('games/crash/setStatusInProgress() err:', err)
            return {status: codes.FAIL}
        }
    }

    async setStatusCompleted () {
        try {

            this.#completed_at = new Date()
            this.#status = 'COMPLETED'

            this.removeOutSubscription()

            this.publishUpdatedGameStatus()

            const result = await this.#client.query(`UPDATE games 
                    SET status = 'COMPLETED', 
                        completed_at =  $1 
                    WHERE game_id = $2`, [
                this.#completed_at,
                this.#game_id
            ])


            if (!result.rowCount) {
                return {status: codes.IMPOSSIBLE}
            }


            return {status: codes.OK}

        } catch (err) {
            error('games/crash/setStatusCompleted() err:', err)
            return {status: codes.FAIL}
        }

    }

    /**
     * @param {CrashGameMultiplier} current_multiplier
     * @return {Promise&lt;void>}
     */
    async handleManualOutDirectives (current_multiplier) {

        const players_to_out = this.playersIn.filter(p => p.outDirectiveAdded &amp;&amp; !p.outProcessingStarted)

        await this.outPlayers(players_to_out, current_multiplier)

    }


    /**
     * @param {CrashGameMultiplier} current_multiplier
     * @return {Promise&lt;void>}
     */
    async autoOutPlayers (current_multiplier) {
        try {

            const players_to_auto_out = this.playersIn.filter(p => p.autoOutAtMultiplier.value &lt;= current_multiplier.value)

            await Promise.all(players_to_auto_out.map(async (player) => {
                await this.outPlayers([player], player.autoOutAtMultiplier)
            }))

        } catch (e) {
            error('games/crash/autoOutPlayers err:', e)
        }
    }

    /**
     * @param {CrashGameMultiplier} current_multiplier
     * @return {Promise&lt;void>}
     */
    async outRemainingPlayers (current_multiplier) {

        const players_to_out = this.playersIn

        await this.outPlayers(players_to_out, current_multiplier)

    }

    /**
     * @param {CrashGamePlayer[]} players_list
     * @param {CrashGameMultiplier} current_multiplier
     * @return {Promise&lt;void>}
     */
    async outPlayers (players_list, current_multiplier) {
        const results = await Promise.all(players_list.map(async player => {
            if (!player.outProcessingStarted) {
                try {
                    this.betsUnderProcessing++

                    const {status} = await player.makeOut(current_multiplier, {db_transaction: this.DBTransaction})

                    if (!codes.statusEqual(status, codes.OK)) {
                        return {status}
                    }

                    this.publishUpdatedPlayer(player)

                    return {status: codes.OK}

                } catch (e) {
                    error('CrashGame.outPlayers() err:', e)
                    return {status: codes.FAIL}
                } finally {
                    this.betsUnderProcessing--
                }
            } else {
                return {status: codes.ALREADY_DONE}
            }

        }))


        if (
            results.some(({status}) => {
                return !codes.statusEqual(status, codes.OK) &amp;&amp; !codes.statusEqual(status, codes.ALREADY_DONE)
            })
        ) {
            this.hasFatalError = true
        }
    }


    static async startGameLevelDBTransaction () {
        try {
            const {status, db_transaction} = await CrashGameDBTransaction.start()

            if (!codes.statusEqual(status, codes.OK)) {
                error(`Unable to start transaction for new game`)
                return {status}
            }

            return {status: codes.OK, db_transaction}

        } catch (e) {
            error('CrashGame.startGameLevelDBTransaction() err:', e)
            return {status: codes.FAIL}
        }
    }

    async commitGameLevelDBTransaction () {
        try {
            await this.DBTransaction.commit()
            await this.DBTransaction.end()
        } catch (e) {
            error(`CrashGame.commitGameLevelDBTransaction() err:`, e)
            return {status: codes.FAIL}
        }
    }

    async rollbackGameLevelDBTransaction () {
        try {

            await this.DBTransaction.rollback()
            await this.DBTransaction.end()

        } catch (e) {
            error(`CrashGame.rollbackGameLevelDBTransaction() err:`,e)
            return {status: codes.FAIL}
        }
    }



    get playersIn () {
        return this.#players.filter(p => !p.win)
    }

    get status () {
        return this.#status
    }

    get gameId () {
        return this.#game_id
    }

    get bettingPeriodEndTimestamp () {
        return this.#betting_period_end_timestamp
    }

    get startedAt () {
        return this.#started_at
    }

    get completedAt () {
        return this.#started_at
    }

    get currentMultiplier () {
        return this.#current_multiplier
    }

    get finalMultiplier () {
        return this.#final_multiplier
    }

    get token () {
        return this.#token
    }

    get tokenSignature () {
        return this.#token.split('.')[2]
    }

    get someBetsAreUnderProcessing () {
        return this.betsUnderProcessing > 0
    }

    get betsUnderProcessing () {
        return this.#bets_under_processing
    }

    set betsUnderProcessing (_new) {
        info(`bets under processing: ${this.betsUnderProcessing} -> ${_new}`)
        this.#bets_under_processing = _new
    }

    get hasFatalError () {
        return this.#has_fatal_error
    }

    set hasFatalError (_new) {

        if (this.#has_fatal_error &amp;&amp; Boolean(_new) === false) {
            throw new Error(`Game #${this.gameId} already has a fatal error and the game transaction will be rolled back; You can not undo that;`)
        }

        if (Boolean(_new) === true)  {
            info(`Game #${this.gameId} has a fatal error flag and the game-level db transaction will be rolled back on the game end`)
        }

        this.#has_fatal_error = Boolean(_new)
    }

    get DBTransaction () {
        return this.#db_transaction
    }

}



module.exports = {CrashGame}





</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> on Mon Feb 08 2021 15:54:23 GMT+0300 (Moscow Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
