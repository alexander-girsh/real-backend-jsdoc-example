<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>middleware/access - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-api_accounts.html">api/accounts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_accounts.html#createLocal">createLocal</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#authenticateLocal">authenticateLocal</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#initEmailConfirmation">initEmailConfirmation</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#confirmEmailWithCode">confirmEmailWithCode</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#sendPasswordRecoveryCode">sendPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#checkPasswordRecoveryCode">checkPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#issueNewPassword">issueNewPassword</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#getAccountData">getAccountData</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts.html#list">list</a></li></ul></li><li><a href="module-api_accounts_social-network-integrations_telegram.html">api/accounts/social-network-integrations/telegram</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_accounts_social-network-integrations_telegram.html#initTelegramAccountIntegration">initTelegramAccountIntegration</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts_social-network-integrations_telegram.html#getCommunity">getCommunity</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts_social-network-integrations_telegram.html#checkCommunityMembership">checkCommunityMembership</a></li></ul></li><li><a href="module-api_accounts_social-network-integrations_vk.html">api/accounts/social-network-integrations/vk</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_accounts_social-network-integrations_vk.html#getCommunity">getCommunity</a></li><li data-type='method' style='display: none;'><a href="module-api_accounts_social-network-integrations_vk.html#checkCommunityMembership">checkCommunityMembership</a></li></ul></li><li><a href="module-api_games_crash.html">api/games/crash</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_games_crash.html#~generateFinalMultipliersGroup">generateFinalMultipliersGroup</a></li><li data-type='method' style='display: none;'><a href="module-api_games_crash.html#~activateFinalMultipliersGroup">activateFinalMultipliersGroup</a></li></ul></li><li><a href="module-api_games.html">api/games</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_games.html#playingHistory">playingHistory</a></li><li data-type='method' style='display: none;'><a href="module-api_games.html#playingStats">playingStats</a></li></ul></li><li><a href="module-api_inventory.html">api/inventory</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_inventory.html#itemsList">itemsList</a></li></ul></li><li><a href="module-api_oAuth.html">api/oAuth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_oAuth.html#generateVKRedirect">generateVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-api_oAuth.html#handleVKRedirect">handleVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-api_oAuth.html#generateGoogleRedirect">generateGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-api_oAuth.html#handleGoogleRedirect">handleGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-api_oAuth.html#generateYandexRedirect">generateYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-api_oAuth.html#handleYandexRedirect">handleYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-api_oAuth.html#generateSteamRedirect">generateSteamRedirect</a></li><li data-type='method' style='display: none;'><a href="module-api_oAuth.html#~handleSteamRedirect">handleSteamRedirect</a></li></ul></li><li><a href="module-api_payments.html">api/payments</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-api_payments.html#depositRules">depositRules</a></li><li data-type='method' style='display: none;'><a href="module-api_payments.html#generateDepositRedirect">generateDepositRedirect</a></li></ul></li><li><a href="module-middleware_access.html">middleware/access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-middleware_access.html#~setAuthCookie">setAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-middleware_access.html#~removeAuthCookie">removeAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-middleware_access.html#addAuthorizationDataToRequest">addAuthorizationDataToRequest</a></li><li data-type='method' style='display: none;'><a href="module-middleware_access.html#accessUser">accessUser</a></li><li data-type='method' style='display: none;'><a href="module-middleware_access.html#accessAdmin">accessAdmin</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="module-api_accounts.html#.event:personal:account/balanceUpdate">personal:account/balanceUpdate</a></li><li><a href="module-api_accounts.html#.event:personal:account/accountDataUpdate">personal:account/accountDataUpdate</a></li></ul><h3>Global</h3><ul><li><a href="global.html#AccountPermissions">AccountPermissions</a></li><li><a href="global.html#AdminPermissionsScope">AdminPermissionsScope</a></li><li><a href="global.html#AccountData">AccountData</a></li><li><a href="global.html#GameType">GameType</a></li><li><a href="global.html#Game">Game</a></li><li><a href="global.html#GameWin">GameWin</a></li><li><a href="global.html#GameBet">GameBet</a></li><li><a href="global.html#Player">Player</a></li><li><a href="global.html#PlayingStats">PlayingStats</a></li><li><a href="global.html#PlayingHistoryEntry">PlayingHistoryEntry</a></li><li><a href="global.html#SteamAppName">SteamAppName</a></li><li><a href="global.html#InventoryItemStatus">InventoryItemStatus</a></li><li><a href="global.html#InventoryItem">InventoryItem</a></li><li><a href="global.html#KNOWN_ACQUIRING_SYSTEMS">KNOWN_ACQUIRING_SYSTEMS</a></li><li><a href="global.html#PAYMENT_METHOD_KINDS">PAYMENT_METHOD_KINDS</a></li><li><a href="global.html#PAYMENT_METHOD_ICON_NAMES">PAYMENT_METHOD_ICON_NAMES</a></li><li><a href="global.html#PaymentMethod">PaymentMethod</a></li><li><a href="global.html#Status">Status</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">middleware/access</h1>
    

    




<section>

<header>
    
        
            
        
    
</header>

<article>
    
        <div class="container-overview">
        
            
                <div class="description usertext"><h5>Exports</h5>
<hr>
<p>A set of methods to work with auth cookies and also a set middlewares to authorizing and permissions
checking</p>
<h5>Procedure</h5>
<hr>
<p>When user credentials are correct on oauth / local signing in,
we read the frequently used user data from the DB (for e.x. username, avatar link, permissions)
and pack it into the jwt (access token). User can not change the packed data, but can read the token using
web services like https://jwt.io, and we don't need to read smth from DB to get user data handling his requests.
Tokens stored in signed cookies and so we only need to read the req cookie and decrypt the token.</p>
<p>We should store the &quot;compromised&quot; web-tokens in the in-memory-cache with cold storage (redis seems perfect)
to not accept the tokens that were revoked.</p>
<p>To make data into the jwt unavailable to be read by user, we add the extra-level of encryption and encrypt
the issued token using node native &quot;crypto&quot; module and the secret keys from env. It adds no significant CPU/MEM
overhead handling the api requests.</p></div>
            

            
                




<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <dt class="tag-see">See:</dt>
    <dd class="tag-see">
        <ul>
            <li><a href="https://jwt.io">https://jwt.io</a></li>
        
            <li><a href="https://tools.ietf.org/html/rfc7519">https://tools.ietf.org/html/rfc7519</a></li>
        </ul>
    </dd>
    

    
</dl>
































            
        
        </div>
    

    

    

    
    
    

     

    

    

    
        <h3 class="subsection-title">Methods</h3>

        
            

    

    <h4 class="name" id="~setAuthCookie"><span class="type-signature">(inner) </span>setAuthCookie<span class="signature">(req, res, cookie_string, explicit_auth_cookie_domain<span class="signature-attributes">opt</span>)</span><span class="type-signature"></span></h4>

    




<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <h5>Handlers Chain:</h5>
                            <table class="params">
                            <thead><tr class="last"><th>Order</th></tr></thead>
                            <tr><td class="type"><a href="module-api_accounts.html#authenticateLocal">module:api/accounts~authenticateLocal</a></td></tr><tr><td class="type">this handler</td></tr><tr><td class="type">OR</td></tr><tr><td class="type">some oAuth authentication implementation.
See handlers named like .handle<oAuth-Provider-Name>Redirect in <a href="module-api_oAuth.html">module:api/oAuth</a>.</td></tr><tr><td class="type">this handler</td></tr><tr><td class="type">OR</td></tr><tr><td class="type">some handler which updates the account data stored also in auth token</td></tr><tr><td class="type">this handler</td></tr>
                            </table>
                            <p>It adds the auth cookie to response with
different config depends of module:config.AUTH_COOKIE_OPTIONS</p>
</div>











    <h5>Parameters:</h5>
    

<table class="params">
    <thead>
    <tr>
        
        <th>Name</th>
        

        <th>Type</th>

        
        <th>Attributes</th>
        

        

        <th class="last">Description</th>
    </tr>
    </thead>

    <tbody>
    

        <tr>
            
                <td class="name"><code>req</code></td>
            

            <td class="type">
            
                
<span class="param-type">Express.request</span>


            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>res</code></td>
            

            <td class="type">
            
                
<span class="param-type">Express.response</span>


            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>cookie_string</code></td>
            

            <td class="type">
            
                
<span class="param-type">String</span>


            
            </td>

            
                <td class="attributes">
                

                

                
                </td>
            

            

            <td class="description last"><p>auth cookie to set</p></td>
        </tr>

    

        <tr>
            
                <td class="name"><code>explicit_auth_cookie_domain</code></td>
            

            <td class="type">
            
                
<span class="param-type">String</span>


            
            </td>

            
                <td class="attributes">
                
                    &lt;optional><br>
                

                

                
                </td>
            

            

            <td class="description last"><p>is required if req.headers['referer'] contains the foreign domain - after the oauth/openid service redirects etc.</p></td>
        </tr>

    
    </tbody>
</table>



















        
            

    

    <h4 class="name" id="~removeAuthCookie"><span class="type-signature">(inner) </span>removeAuthCookie<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <h5>Handlers Chain:</h5>
                            <table class="params">
                            <thead><tr class="last"><th>Order</th></tr></thead>
                            <tr><td class="type"><a href="module-api_accounts.html#logout">module:api/accounts~logout</a></td></tr><tr><td class="type">this handler</td></tr>
                            </table>
                            <p>It removes cookie &quot;authorization&quot;, provides the same cookie options as when cookie were placed</p>
                            <h5>Header Parameters:</h5>
          <table class="params">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                
                
                <th class="last">Description</th>
              </tr>
            </thead>
            <tr>
            <td class="name">host</td>
            <td class="type">String</td>
            
            
            <td class="description last">to get domain name</td>
          </tr>
          </table>
</div>




























        
            

    

    <h4 class="name" id="addAuthorizationDataToRequest"><span class="type-signature">(async, route) </span>addAuthorizationDataToRequest<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <h5>Handlers Chain:</h5>
                            <table class="params">
                            <thead><tr class="last"><th>Order</th></tr></thead>
                            <tr><td class="type">this middleware</td></tr><tr><td class="type"><a href="module-middleware_access.html#accessUser">module:middleware/access~accessUser</a></td></tr><tr><td class="type">any api endpoint</td></tr><tr><td class="type">OR</td></tr><tr><td class="type">this middleware</td></tr><tr><td class="type"><a href="module-middleware_access.html#accessAdmin">module:middleware/access~accessAdmin</a></td></tr><tr><td class="type">any api endpoint</td></tr><tr><td class="type">OR</td></tr><tr><td class="type">this middleware</td></tr><tr><td class="type">any api endpoint that don't needs for authorization, but it still can use data from request.account_data</td></tr><tr><td class="type">OR</td></tr><tr><td class="type">this middleware</td></tr><tr><td class="type">any another middleware</td></tr>
                            </table>
                            <h5>Route:</h5>
                            <table class="params">
                            <thead><tr><th>Method</th><th class="last">Path</th></tr></thead>
                            <tr>
                            <td class="type">ANY</td>
                            <td class="name last">/api/*</td>
                            </tr>
                            </table>
                            <p>This middleware extracts a signed jwt-token from a signed cookie &quot;authorization&quot;,
decrypts using module:middleware/access~decryptString to get a jwt token,
verifies and decrypts the jwt-token using package <a href="https://www.npmjs.com/package/jsonwebtoken">https://www.npmjs.com/package/jsonwebtoken</a>
and if token is verified (we can trust its content) it adds its content to request to make them available as request.account_data</p>
                            <h5>Header Parameters:</h5>
          <table class="params">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                
                
                <th class="last">Description</th>
              </tr>
            </thead>
            <tr>
            <td class="name">cookies</td>
            <td class="type">String</td>
            
            
            <td class="description last">not directly, using native express-cookie-parser</td>
          </tr>
          </table>
</div>




























        
            

    

    <h4 class="name" id="accessUser"><span class="type-signature">(route) </span>accessUser<span class="signature">()</span><span class="type-signature"></span></h4>

    




<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <h5>Handlers Chain:</h5>
                            <table class="params">
                            <thead><tr class="last"><th>Order</th></tr></thead>
                            <tr><td class="type"><a href="module-middleware_access.html#addAuthorizationDataToRequest">module:middleware/access~addAuthorizationDataToRequest</a></td></tr><tr><td class="type">this middleware</td></tr><tr><td class="type">some api method for authorized requests only</td></tr>
                            </table>
                            <h5>Route:</h5>
                            <table class="params">
                            <thead><tr><th>Method</th><th class="last">Path</th></tr></thead>
                            <tr>
                            <td class="type">ANY</td>
                            <td class="name last">/api/*</td>
                            </tr>
                            </table>
                            
                            <h5>Response:</h5>
          <table class="params">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                
                
                <th class="last">Description</th>
              </tr>
            </thead>
            <tr>
            <td class="name">status</td>
            <td class="type">FORBIDDEN</td>
            
            
            <td class="description last">if not authenticated</td>
          </tr>
          </table>
                            <h5>Response Code:</h5>
          <table class="params">
            <thead>
              <tr>
                
                <th>Type</th>
                
                
                <th class="last">Description</th>
              </tr>
            </thead>
            <tr>
            
            <td class="type">403</td>
            
            
            <td class="description last">if user is not authenticated and access denied</td>
          </tr>
          </table>
</div>









    <h5>Example</h5>
    
        <p class="code-caption">Usage example</p>
    
    <pre class="prettyprint"><code>// creating the api endpoint guarded with user-level access using default express router syntax
 router.get('/api/some-protected-method', accessUser, (req, res) => {

 // ...protected endpoint code...
 // here we can use the user credentials,
 // for e.g, req.account_data.user_id,
 // because request is definitely authorized

 }</code></pre>





















        
            

    

    <h4 class="name" id="accessAdmin"><span class="type-signature">(route) </span>accessAdmin<span class="signature">()</span><span class="type-signature"> &rarr; {function}</span></h4>

    




<dl class="details">

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
</dl>





<div class="description usertext">
    <h5>Handlers Chain:</h5>
                            <table class="params">
                            <thead><tr class="last"><th>Order</th></tr></thead>
                            <tr><td class="type"><a href="module-middleware_access.html#addAuthorizationDataToRequest">module:middleware/access~addAuthorizationDataToRequest</a></td></tr><tr><td class="type">this middleware</td></tr><tr><td class="type">some api method for admins with provided scope only</td></tr>
                            </table>
                            <h5>Route:</h5>
                            <table class="params">
                            <thead><tr><th>Method</th><th class="last">Path</th></tr></thead>
                            <tr>
                            <td class="type">ANY</td>
                            <td class="name last">/api/*</td>
                            </tr>
                            </table>
                            <p>This is not a middleware, this is a simple middlewares constructor
returning the access-control middleware that requires the provided
permissions_scope to allow assess.
Usage is to to built the result (middleware) of this constructor call into the middlewares chain</p>
                            <h5>Response:</h5>
          <table class="params">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                
                
                <th class="last">Description</th>
              </tr>
            </thead>
            <tr>
            <td class="name">status</td>
            <td class="type">FORBIDDEN</td>
            
            
            <td class="description last">if access not allowed</td>
          </tr>
          </table>
                            <h5>Response Code:</h5>
          <table class="params">
            <thead>
              <tr>
                
                <th>Type</th>
                
                
                <th class="last">Description</th>
              </tr>
            </thead>
            <tr>
            
            <td class="type">403</td>
            
            
            <td class="description last">if access not allowed</td>
          </tr>
          </table>
</div>









    <h5>Example</h5>
    
        <p class="code-caption">Declaring some endpoint that reqires the admin-level permissions</p>
    
    <pre class="prettyprint"><code>router.post('/api/some-admin-endpoint', accessAdmin({ACCOUNTS: true}), (req, res) => {
 // ...protected endpoint code...
 // only admin with .admin_permissions_scope.BLOCKING_ACCOUNTS == true
 // can get access to this endpoint
})

// also you can combine permissions scope as you need, for e.g
   accessAdmin({ACCOUNTS: true, SOME_ANOTHER_PERMISSION: true})
// it will return a middleware that will deny all requests authorized without this scopes combination</code></pre>


















<h5>Returns:</h5>

        
<div class="param-desc">
    <p>a middleware which will check all provided permissions before access permitting</p>
</div>



<dl class="param-type">
    <dt>
        Type
    </dt>
    <dd>
        
<span class="param-type">function</span>


    </dd>
</dl>

    



        
    

    

    
</article>

</section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.6</a> on Thu Feb 11 2021 23:50:46 GMT+0300 (Moscow Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>