<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>http-server/api/affiliates.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OutgoingMessage.html">OutgoingMessage</a></li><li><a href="Game.html">Game</a></li><li><a href="CrashGame.html">CrashGame</a><ul class='members'><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGame.html#publishUpdatedPlayer">publishUpdatedPlayer</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#handleManualOutDirectives">handleManualOutDirectives</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#autoOutPlayers">autoOutPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outRemainingPlayers">outRemainingPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outPlayers">outPlayers</a></li></ul></li><li><a href="CrashGameDBTransaction.html">CrashGameDBTransaction</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#createSavePoint">createSavePoint</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#rollbackToSavePoint">rollbackToSavePoint</a></li></ul></li><li><a href="GameWin.html">GameWin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="GameWin.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="GameWin.html#.calcWonAmount">calcWonAmount</a></li></ul></li><li><a href="SteamItem.html">SteamItem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SteamItem.html#.fromObject">fromObject</a></li></ul></li><li><a href="module-Games-Game.html">Game</a></li><li><a href="module-Games-SteamItem.html">SteamItem</a></li><li><a href="module-Games-InventoryItem.html">InventoryItem</a></li><li><a href="module-Games-GameWin.html">GameWin</a></li><li><a href="module-Games-GameBet.html">GameBet</a></li><li><a href="module-Games-User.html">User</a></li><li><a href="module-Games-Player.html">Player</a></li></ul><h3>Modules</h3><ul><li><a href="module-access_config.html">access/config</a></li><li><a href="module-access.html">access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-access.html#~encryptString">encryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#.decryptString">decryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#~issueJWTToken">issueJWTToken</a></li></ul></li><li><a href="module-broadcasting-server_config.html">broadcasting-server/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-broadcasting-server_config.html#.PORT">PORT</a></li></ul></li><li><a href="module-ws-server_ws-clients.html">ws-server/ws-clients</a></li><li><a href="module-database_config.html">database/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_ATTEMPTS">RECONNECTION_ATTEMPTS</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_DELAY">RECONNECTION_DELAY</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_CONNECTION_URL">DB_CONNECTION_URL</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_TRANSACTIONS_RETRIES_LIMIT">DB_TRANSACTIONS_RETRIES_LIMIT</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.PG_POOL_QUERIES_VERBOSE_MODE">PG_POOL_QUERIES_VERBOSE_MODE</a></li></ul></li><li><a href="module-database_connection.html">database/connection</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-database_connection.html#~onClientConnected">onClientConnected</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~reconnect">reconnect</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~createNewClient">createNewClient</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~execRepeatableTransaction">execRepeatableTransaction</a></li></ul></li><li><a href="module-http-server_api_accounts.html">http-server/api/accounts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~createLocal">createLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~authenticateLocal">authenticateLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~initEmailConfirmation">initEmailConfirmation</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~confirmEmailWithCode">confirmEmailWithCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~sendPasswordRecoveryCode">sendPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~checkPasswordRecoveryCode">checkPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~issueNewPassword">issueNewPassword</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~getAccountData">getAccountData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~list">list</a></li></ul></li><li><a href="module-http-server_api_oAuth.html">http-server/api/oAuth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateVKRedirect">generateVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleVKRedirect">handleVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateGoogleRedirect">generateGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleGoogleRedirect">handleGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateYandexRedirect">generateYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleYandexRedirect">handleYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~getOpenIdInstanceByReturnUrl">getOpenIdInstanceByReturnUrl</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleSteamRedirect">handleSteamRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~readUserData">readUserData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~endAuthentication">endAuthentication</a></li></ul></li><li><a href="module-http-server_api_payments_freekassa.html">http-server/api/payments/freekassa</a></li><li><a href="module-http-server_api_payments_gamemoney.html">http-server/api/payments/gamemoney</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~generateDepositRedirectSignature">generateDepositRedirectSignature</a></li></ul></li><li><a href="module-http-server_api_payments.html">http-server/api/payments</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~depositRules">depositRules</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~generateDepositRedirect">generateDepositRedirect</a></li></ul></li><li><a href="module-http-server_config.html">http-server/config</a></li><li><a href="module-http-server.html">http-server</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-http-server.html#.API">API</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server.html#~startServe">startServe</a></li><li data-type='method' style='display: none;'><a href="module-http-server.html#~shutDown">shutDown</a></li></ul></li><li><a href="module-http-server_middleware_access.html">http-server/middleware/access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~setAuthCookie">setAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~removeAuthCookie">removeAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~addAuthorizationDataToRequest">addAuthorizationDataToRequest</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessUser">accessUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessAdmin">accessAdmin</a></li></ul></li><li><a href="module-http-server_gamemoney-lib.html">http-server/gamemoney-lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateHmacSignature">generateHmacSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~verifyRequestRsaSignature">verifyRequestRsaSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~createDeposit">createDeposit</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~updateDepositStatus">updateDepositStatus</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateDepositRedirectUrl">generateDepositRedirectUrl</a></li></ul></li><li><a href="module-http-server_health-check.html">http-server/health-check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~updateState">updateState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~getState">getState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpMiddleware">httpMiddleware</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpEndpoint">httpEndpoint</a></li></ul></li><li><a href="module-http-server_mailer.html">http-server/mailer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_mailer.html#~sendMail">sendMail</a></li></ul></li><li><a href="module-http-server_plugins_withdrawals_approval.html">http-server/plugins/withdrawals/approval</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_plugins_withdrawals_approval.html#~checkForWithdrawalsBlockers">checkForWithdrawalsBlockers</a></li></ul></li><li><a href="module-http-server_lib.html">http-server/lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~freezeObjectDeep">freezeObjectDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesSizeOfObject">bytesSizeOfObject</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~asyncInterval">asyncInterval</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~delay">delay</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~compareDeep">compareDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~generateRandomString">generateRandomString</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~minMax">minMax</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~shuffleArray">shuffleArray</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~toFixedPrecisionFloat">toFixedPrecisionFloat</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~to2DigitsPrecisionFloat">to2DigitsPrecisionFloat</a></li></ul></li><li><a href="module-logger.html">logger</a></li><li><a href="module-redis-connection_config.html">redis-connection/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_HOST">REDIS_HOST</a></li><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_PORT">REDIS_PORT</a></li></ul></li><li><a href="module-Games.html">Games</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createLocalAccount">createLocalAccount</a></li><li><a href="global.html#authenticateLocalAccount">authenticateLocalAccount</a></li><li><a href="global.html#fetchAccountData">fetchAccountData</a></li><li><a href="global.html#createAxiosInstance">createAxiosInstance</a></li><li><a href="global.html#createAuthInfrastructure">createAuthInfrastructure</a></li><li><a href="global.html#createWebsocketConnection">createWebsocketConnection</a></li><li><a href="global.html#socketCookieParser">socketCookieParser</a></li><li><a href="global.html#authCookieParser">authCookieParser</a></li><li><a href="global.html#hasAccessUser">hasAccessUser</a></li><li><a href="global.html#hasAccessAdmin">hasAccessAdmin</a></li><li><a href="global.html#util">util</a></li><li><a href="global.html#isMainBroadcastingServer">isMainBroadcastingServer</a></li><li><a href="global.html#MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD">MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD</a></li><li><a href="global.html#BETTING_PERIOD_MS">BETTING_PERIOD_MS</a></li><li><a href="global.html#COMPLETED_PERIOD_MS">COMPLETED_PERIOD_MS</a></li><li><a href="global.html#CRASH_GAME_FRAMES_DELAY_MS">CRASH_GAME_FRAMES_DELAY_MS</a></li><li><a href="global.html#GAME_LOOP_DELAY_AFTER_ERROR_MS">GAME_LOOP_DELAY_AFTER_ERROR_MS</a></li><li><a href="global.html#%2522your-256-bit-secret%2522">"your-256-bit-secret"</a></li><li><a href="global.html#CURRENT_GAME">CURRENT_GAME</a></li><li><a href="global.html#generateFinalMultipliersGroup">generateFinalMultipliersGroup</a></li><li><a href="global.html#activateFinalMultipliersGroup">activateFinalMultipliersGroup</a></li><li><a href="global.html#generateDepositRedirect">generateDepositRedirect</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#Accounts">Accounts</a></li><li><a href="global.html#performInventoryItemWithdrawalStatusUpdateNotificationForUser">performInventoryItemWithdrawalStatusUpdateNotificationForUser</a></li><li><a href="global.html#itemsList">itemsList</a></li><li><a href="global.html#fileParser">fileParser</a></li><li><a href="global.html#CONTENT_TYPES%255Bundefined%255D">CONTENT_TYPES[undefined]</a></li><li><a href="global.html#STEAM_ITEM_ICON_URL_HASHES_CACHE%255Bundefined%255D">STEAM_ITEM_ICON_URL_HASHES_CACHE[undefined]</a></li><li><a href="global.html#freekassaIPVerificationMiddleware">freekassaIPVerificationMiddleware</a></li><li><a href="global.html#freekassaHookSignatureVerificationMiddleware">freekassaHookSignatureVerificationMiddleware</a></li><li><a href="global.html#gamemoneyIPVerificationMiddleware">gamemoneyIPVerificationMiddleware</a></li><li><a href="global.html#gamemoneyHookSignatureVerificationMiddleware">gamemoneyHookSignatureVerificationMiddleware</a></li><li><a href="global.html#skinsBackIPVerificationMiddleware">skinsBackIPVerificationMiddleware</a></li><li><a href="global.html#skinsBackHookSignatureVerificationMiddleware">skinsBackHookSignatureVerificationMiddleware</a></li><li><a href="global.html#unitpayIPVerificationMiddleware">unitpayIPVerificationMiddleware</a></li><li><a href="global.html#unitpayHookSignatureVerificationMiddleware">unitpayHookSignatureVerificationMiddleware</a></li><li><a href="global.html#affiliateExists">affiliateExists</a></li><li><a href="global.html#getAffiliate">getAffiliate</a></li><li><a href="global.html#createNewAffiliate">createNewAffiliate</a></li><li><a href="global.html#performRevshareAccrual">performRevshareAccrual</a></li><li><a href="global.html#createDefaultTariff">createDefaultTariff</a></li><li><a href="global.html#getValidMatchingTariff">getValidMatchingTariff</a></li><li><a href="global.html#MENTION_SUGGESTIONS">MENTION_SUGGESTIONS</a></li><li><a href="global.html#searchMentionedUsers">searchMentionedUsers</a></li><li><a href="global.html#filterProhibitedWords">filterProhibitedWords</a></li><li><a href="global.html#EMOJIS_LIST">EMOJIS_LIST</a></li><li><a href="global.html#generateDepositRedirectUrl">generateDepositRedirectUrl</a></li><li><a href="global.html#handleNewPromocodeActivation">handleNewPromocodeActivation</a></li><li><a href="global.html#handleNewCompletedDeposit">handleNewCompletedDeposit</a></li><li><a href="global.html#generateSignature">generateSignature</a></li><li><a href="global.html#verifyHookSignature">verifyHookSignature</a></li><li><a href="global.html#createOrReplaceDeposit">createOrReplaceDeposit</a></li><li><a href="global.html#Status">Status</a></li><li><a href="global.html#createConnection">createConnection</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#KNOWN_ACQUIRING_SYSTEMS">KNOWN_ACQUIRING_SYSTEMS</a></li><li><a href="global.html#PAYMENT_METHOD_KINDS">PAYMENT_METHOD_KINDS</a></li><li><a href="global.html#PAYMENT_METHOD_ICON_NAMES">PAYMENT_METHOD_ICON_NAMES</a></li><li><a href="global.html#PaymentMethod">PaymentMethod</a></li><li><a href="global.html#depositRules">depositRules</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">http-server/api/affiliates.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const router = require( 'express').Router()
const {codes} = require( 'status-codes')
const {DB} = require( '../../database/connection.js')
const {error} = require( '../../logger/index.js')
const {accessUser, accessAdmin} = require( '../middleware/access.js')
const {config} = require('../config.js')
const {createDefaultTariff} = require('../plugins/affiliates/tariffs.js')

const calcShortStats = async ({affiliate_id }) => {
    try {

        if (!affiliate_id) {
            return {status: codes.WRONG_ARGS}
        }

        return {
            status: codes.OK,
            short_stats: await DB.query(`
                WITH affiliate_with_known_tariff AS (SELECT (SELECT row_to_json(tariff)
                                                             FROM (SELECT revshare_percentage
                                                                   FROM affiliate_tariffs
                                                                   WHERE affiliate_id = $1
                                                                     AND valid_before >= now()
                                                                   ORDER BY revshare_percentage DESC
                                                                   LIMIT 1) tariff)                         AS tariff,
                                                            (SELECT count(*)::INT
                                                             FROM user_affiliate_bindings
                                                             WHERE affiliate_id = $1)                       AS registrations,
                                                            (SELECT 
                                                                    count(*)::INT
                                                             FROM visitors 
                                                             WHERE affiliate_id = $1) AS visitors,
                                                            COALESCE((SELECT sum(accrued_amount_usd) 
                                                             FROM affiliate_accruals 
                                                             WHERE affiliate_id = $1), 0.00 )::NUMERIC(16,2) AS accrued_amount,
                                                            calcNotPayedOffAffiliateRevshareInout($1, NULL) AS not_payed_off_inout
                                                     FROM affiliates
                                                     WHERE affiliate_id = $1)
                SELECT *,
                       not_payed_off_inout *
                       ((tariff ->> 'revshare_percentage')::NUMERIC(16,2) / 100) AS potential_affiliate_profit
                FROM affiliate_with_known_tariff
            `, [
                affiliate_id
            ])
                .then(r => r.rows[0])
        }

    } catch (e) {
        error('calcShortStats() err:', e)
        return {status: codes.FAIL}
    }

}


const shortStats = async (req, res) => {
    try {

        const {user_id} = req.account_data

        const affiliate_id = user_id

        let {short_stats} = await calcShortStats({affiliate_id})

        /** current tariff may be expired */
        if (short_stats &amp;&amp; !short_stats.tariff) {
            await createDefaultTariff({affiliate_id})

            short_stats = (await calcShortStats({affiliate_id})).short_stats
        }


        /** affiliate has no visitors / registrations /pot.profit, we should display defaults */
        if (!short_stats) {

            const defaults = {
                tariff: {
                    revshare_percentage: config.DEFAULT_REVSHARE_PERCENTAGE
                },
                visitors: 0,
                registrations: 0,
                potential_affiliate_profit: 0,
                accrued_amount: 0
            }

            return res.json({status: codes.NOT_FOUND, defaults})
        }

        return res.json({status: codes.OK, short_stats})

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


const periodical = async (req, res) => {

    try {

        const {
            grouping_period = '1 day',
            sorting_property = 'period_end_timestamp',
            sorting_direction = 'DESC',
            limit = 15,
            offset = 0
        } = req.query

        /** Affiliate.affiliate_id is now hid .user_id */
        const affiliate_id = req.account_data.user_id

        const timestamp_from =  req.query.timestamp &amp;&amp; req.query.timestamp.from &amp;&amp; new Date(req.query.timestamp.from).toString() !== 'Invalid Date' ? new Date(req.query.timestamp.from) : new Date(0)
        const timestamp_to = req.query.timestamp &amp;&amp; req.query.timestamp.to &amp;&amp; new Date(req.query.timestamp.to).toString() !== 'Invalid Date' ? new Date(req.query.timestamp.to) : new Date()


        const periodical = await DB.query(`
                 WITH nullable_periods AS (
                    SELECT generate_series($1::TIMESTAMPTZ, $2::TIMESTAMPTZ, $3::INTERVAL ) AS period_start_timestamp,
                           generate_series($1::TIMESTAMPTZ + $3::INTERVAL, $2::TIMESTAMPTZ, $3::INTERVAL) as period_end_timestamp
                ),
                unfiltered_periods AS ( SELECT period_start_timestamp, COALESCE(period_end_timestamp, $2::TIMESTAMPTZ) AS period_end_timestamp FROM nullable_periods),
                periods AS (
                    SELECT * FROM unfiltered_periods WHERE period_start_timestamp != period_end_timestamp
                ),
                matching_users AS (
                    SELECT u.user_id
                    FROM users u
                        LEFT JOIN user_affiliate_bindings uab
                            ON (u.user_id = uab.user_id)
                    WHERE (uab.affiliate_id = $6::BIGINT)
                ),
                matching_visitors AS (
                    SELECT created_at 
                        FROM visitors
                    WHERE ($6::BIGINT = visitors.affiliate_id) 
                ),
                data_rows AS (
                    SELECT 
                    (count(*) OVER())::INTEGER AS total_found,       
                    $3::TEXT AS grouping_period,   
                     period_start_timestamp,      
                     period_end_timestamp,      
                     (SELECT count(*)::INT 
                      FROM ( 
                            SELECT user_id 
                            FROM bets 
                            WHERE bets.created_at >= p.period_start_timestamp 
                                AND bets.created_at &lt; p.period_end_timestamp
                                    AND bets.user_id IN (SELECT * FROM matching_users)
                            UNION 
                            SELECT user_id 
                            FROM deposits
                            WHERE deposits.created_at >= p.period_start_timestamp
                              AND deposits.created_at &lt; p.period_end_timestamp
                                AND deposits.user_id IN (SELECT * FROM matching_users)
                            GROUP BY user_id
                          ) AS active_player_or_depositor
                     ) AS active_users_count,
                     (SELECT count(*)::INT 
                      FROM matching_visitors
                      WHERE created_at >= p.period_start_timestamp
                         AND created_at &lt; p.period_end_timestamp
                         ) AS unique_visitors_count,
                     (SELECT count(*)::INT
                      FROM users
                      WHERE created_at >= p.period_start_timestamp
                        AND created_at &lt; p.period_end_timestamp
                          AND users.user_id IN (SELECT * FROM matching_users)
                     ) AS registrations_count,
                     (SELECT count(*)::INT
                      FROM deposits
                      WHERE created_at >= p.period_start_timestamp
                        AND created_at &lt; p.period_end_timestamp
                         AND deposits.user_id IN (SELECT * FROM matching_users)
                     ) AS deposits_count,
                     (SELECT COALESCE(sum(net_amount_usd), 0.00)::NUMERIC(16,2)
                      FROM deposits
                      WHERE created_at >= p.period_start_timestamp
                        AND created_at &lt; p.period_end_timestamp
                         AND deposits.user_id IN (SELECT * FROM matching_users)
                     ) AS deposits_sum,
                     (SELECT count(*)::INT
                      FROM inventory_items ii 
                          LEFT JOIN inventory_item_withdrawals iiw 
                              ON (ii.inventory_item_id = iiw.inventory_item_id)
                      WHERE 
                            ii.status = 'WITHDRAWN'
                        AND
                            iiw.updated_at >= p.period_start_timestamp
                        AND iiw.updated_at &lt; p.period_end_timestamp
                          AND ii.user_id IN (SELECT * FROM matching_users)
                     ) AS withdraws_count,
                     (SELECT COALESCE(sum(ii.price), 0.00)::NUMERIC(16,2)
                      FROM inventory_items ii
                               LEFT JOIN inventory_item_withdrawals iiw
                                         ON (ii.inventory_item_id = iiw.inventory_item_id)
                      WHERE
                          ii.status = 'WITHDRAWN'
                        AND
                          iiw.updated_at >= p.period_start_timestamp
                        AND iiw.updated_at &lt; p.period_end_timestamp
                         AND ii.user_id IN (SELECT * FROM matching_users)
                     ) AS withdraws_sum,
                     (SELECT count(*)::INT FROM (SELECT game_id
                      FROM bets
                      WHERE created_at >= p.period_start_timestamp
                        AND created_at &lt; p.period_end_timestamp
                        AND bets.user_id IN (SELECT * FROM matching_users)
                      GROUP BY game_id) as unique_non_empty_games) AS games_count,
                     (SELECT count(*)::INT
                      FROM bets
                      WHERE created_at >= p.period_start_timestamp
                        AND created_at &lt; p.period_end_timestamp
                         AND bets.user_id IN (SELECT * FROM matching_users)
                     ) AS bets_count,
                     (SELECT COALESCE(sum(amount), 0.00)::NUMERIC(16,2)
                      FROM bets
                      WHERE created_at >= p.period_start_timestamp
                        AND created_at &lt; p.period_end_timestamp
                         AND bets.user_id IN (SELECT * FROM matching_users)
                     ) AS bets_sum,
                     (SELECT count(*)::INT
                      FROM wins w
                      WHERE 
                            ( w.won_fiat_amount > 0 OR w.won_inventory_item IS NOT NULL) 
                        AND w.created_at >= p.period_start_timestamp
                        AND w.created_at &lt; p.period_end_timestamp
                         AND w.user_id IN (SELECT * FROM matching_users)
                     ) AS wins_count,
                     (SELECT COALESCE(sum(won_fiat_amount + COALESCE(ii.price, 0.00)::NUMERIC(16,2) ), 0.00)::NUMERIC(16,2)
                      FROM wins w 
                          LEFT JOIN inventory_items ii
                            ON (w.won_inventory_item = ii.inventory_item_id)
                      WHERE ( w.won_fiat_amount > 0 OR w.won_inventory_item IS NOT NULL)
                        AND w.created_at >= p.period_start_timestamp
                        AND w.created_at &lt; p.period_end_timestamp
                         AND w.user_id IN (SELECT * FROM matching_users)
                     ) AS wins_sum,
                     (SELECT COALESCE(sum(accrued_amount_usd), 0.00)::NUMERIC(16,2)
                      FROM affiliate_accruals
                      WHERE created_at >= p.period_start_timestamp
                        AND created_at &lt; p.period_end_timestamp
                         AND affiliate_accruals.user_id IN (SELECT * FROM matching_users)
                     ) AS affiliate_accruals_sum
                FROM periods p
                )
                SELECT *
                FROM data_rows 
                ORDER BY ${sorting_property} ${sorting_direction}
                OFFSET $4
                LIMIT $5
        `, [
            timestamp_from,
            timestamp_to,
            grouping_period,
            offset,
            limit,
            affiliate_id
        ])
            .then(r => r.rows)

        return res.json({status: codes.OK, periodical})

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}



/** users (affiliates) endpoints */
router.get('/short-stats', accessUser, shortStats)
router.get('/periodical', accessUser, periodical)



const list = async (req, res) => {
    try {

        const offset = req.query.offset &amp;&amp; !isNaN(parseInt(req.query.offset)) ? parseInt(req.query.offset) : 0
        const limit = req.query.limit &amp;&amp; !isNaN(parseInt(req.query.limit)) ? parseInt(req.query.limit) : 50

        const sorting_property = req.query.sorting_property &amp;&amp; req.query.sorting_property.trim() ? req.query.sorting_property.trim() : 'u.created_at'
        const sorting_direction = req.query.sorting_direction &amp;&amp; req.query.sorting_direction.trim() ? req.query.sorting_direction.trim() : 'ASC'

        const affiliate_id = req.query.affiliate_id &amp;&amp; !isNaN(parseInt(req.query.affiliate_id.trim())) ? parseInt(req.query.affiliate_id.trim()) : null

        const affiliates = await DB.query(`SELECT
                                                   (count(*) OVER())::INTEGER AS total_found, 
                                                   a.*,
                                                   (SELECT ARRAY ((SELECT 
                                                   row_to_json(tariff)
                                                   FROM (SELECT revshare_percentage, 
                                                                tariff_kind,
                                                                valid_before,
                                                                revshare_inout_accounting,
                                                                revshare_pace_of_accruing
                                                   FROM affiliate_tariffs at
                                                   WHERE at.affiliate_id = a.affiliate_id
                                                     AND valid_before >= now()
                                                   ORDER BY revshare_percentage DESC) tariff))) AS tariffs,
                                                    
                                                   (SELECT count(*)::INT
                                                       FROM visitors
                                                       WHERE affiliate_id = a.affiliate_id) AS visitors,     
       
                                                   (SELECT count(*)::INT
                                                       FROM user_affiliate_bindings
                                                       WHERE affiliate_id = a.affiliate_id) AS registrations,       
                                                   (SELECT count(*) 
                                                    FROM deposits d 
                                                       LEFT JOIN user_affiliate_bindings uab 
                                                           ON (uab.user_id = d.user_id) 
                                                    WHERE uab.affiliate_id = a.affiliate_id
                                                        AND d.status = 'COMPLETED'
                                                    )::INT AS referrals_deposits_count,
       
                                                    (SELECT COALESCE(sum(net_amount_usd), 0.00)
                                                     FROM deposits d
                                                         LEFT JOIN user_affiliate_bindings uab
                                                             ON (d.user_id = uab.user_id)
                                                     WHERE uab.affiliate_id = a.affiliate_id
                                                         AND d.status = 'COMPLETED')::NUMERIC(16,2) AS referrals_deposits_sum,
                                                    (SELECT count(*) 
                                                    FROM inventory_items ii 
                                                       LEFT JOIN user_affiliate_bindings uab 
                                                           ON (uab.user_id = ii.user_id) 
                                                    WHERE uab.affiliate_id = a.affiliate_id
                                                        AND ii.status = 'WITHDRAWN'
                                                    )::INT AS referrals_withdraws_count,
                                                    (SELECT COALESCE(sum(price), 0.00)
                                                     FROM inventory_items ii
                                                         LEFT JOIN user_affiliate_bindings uab
                                                             ON (ii.user_id = uab.user_id)
                                                     WHERE uab.user_id = ii.user_id
                                                         AND uab.affiliate_id  = a.affiliate_id
                                                         AND ii.status = 'WITHDRAWN')::NUMERIC(16,2) AS referrals_withdraws_sum,
                                                    calcAffiliateInout(a.affiliate_id, NULL) AS in_out,
                                                    calcAffiliateRevshareAccruals(a.affiliate_id, NULL) AS affiliate_accruals_sum, /* another tariffs accruals may be added */
                                                    (SELECT COALESCE(sum(usd_amount), 0.00) FROM affiliate_withdraws WHERE affiliate_id = a.affiliate_id) AS affiliate_withdraws_sum
        FROM affiliates a 
            LEFT JOIN users u ON (a.affiliate_id = u.user_id)
        WHERE $1::BIGINT IS NULL OR a.affiliate_id = $1::BIGINT
        ORDER BY ${sorting_property} ${sorting_direction}
        OFFSET $2
        LIMIT $3`, [
            affiliate_id,
            offset,
            limit
        ])
            .then(r => r.rows)

        return res.json({status: codes.OK, affiliates})


    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


const detailed = async (req, res) => {
    try {

        const {affiliate_id} = req.query

        if (!affiliate_id) {
            return res.json({status: codes.WRONG_ARGS})
        }

        const info = await DB.query(`
            SELECT a.*, 
                   u.username,
                   u.email,
                   u.steam_id,
                   u.vk_id,
                   u.google_id,
                   u.steam_id,
                   calcbalance(u.user_id) AS platform_balance,
                   u.avatar_link,
                   u.created_at 
                FROM affiliates a
                    LEFT JOIN users u
                        ON a.affiliate_id = u.user_id
                WHERE affiliate_id = $1`, [affiliate_id])
            .then(r => r.rows[0])


        if (!info) {
            return res.json({status: codes.NOT_FOUND})
        }


        const stats = await DB.query(`
            SELECT
                ARRAY (
                      SELECT row_to_json(user_affiliate_binding)
                        FROM (SELECT uab.*
                              FROM user_affiliate_bindings uab
                              WHERE uab.affiliate_id = $1 ) user_affiliate_binding
                )  AS referrals
        `, [
            affiliate_id
        ])

        return res.json({
            status: codes.OK,
            info,
            stats
        })



    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


/** admin endpoints */
router.get('/list', accessAdmin({AFFILIATES: true}), list)
router.get('/detailed', accessAdmin({AFFILIATES: true}), detailed)
module.exports = router
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> on Mon Feb 08 2021 15:54:23 GMT+0300 (Moscow Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
