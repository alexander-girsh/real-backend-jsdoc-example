<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>botz-service/index.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OutgoingMessage.html">OutgoingMessage</a></li><li><a href="Game.html">Game</a></li><li><a href="CrashGame.html">CrashGame</a><ul class='members'><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGame.html#publishUpdatedPlayer">publishUpdatedPlayer</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#handleManualOutDirectives">handleManualOutDirectives</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#autoOutPlayers">autoOutPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outRemainingPlayers">outRemainingPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outPlayers">outPlayers</a></li></ul></li><li><a href="CrashGameDBTransaction.html">CrashGameDBTransaction</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#createSavePoint">createSavePoint</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#rollbackToSavePoint">rollbackToSavePoint</a></li></ul></li><li><a href="GameWin.html">GameWin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="GameWin.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="GameWin.html#.calcWonAmount">calcWonAmount</a></li></ul></li><li><a href="SteamItem.html">SteamItem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SteamItem.html#.fromObject">fromObject</a></li></ul></li><li><a href="module-Games-Game.html">Game</a></li><li><a href="module-Games-SteamItem.html">SteamItem</a></li><li><a href="module-Games-InventoryItem.html">InventoryItem</a></li><li><a href="module-Games-GameWin.html">GameWin</a></li><li><a href="module-Games-GameBet.html">GameBet</a></li><li><a href="module-Games-User.html">User</a></li><li><a href="module-Games-Player.html">Player</a></li></ul><h3>Modules</h3><ul><li><a href="module-access_config.html">access/config</a></li><li><a href="module-access.html">access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-access.html#~encryptString">encryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#.decryptString">decryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#~issueJWTToken">issueJWTToken</a></li></ul></li><li><a href="module-broadcasting-server_config.html">broadcasting-server/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-broadcasting-server_config.html#.PORT">PORT</a></li></ul></li><li><a href="module-ws-server_ws-clients.html">ws-server/ws-clients</a></li><li><a href="module-database_config.html">database/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_ATTEMPTS">RECONNECTION_ATTEMPTS</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_DELAY">RECONNECTION_DELAY</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_CONNECTION_URL">DB_CONNECTION_URL</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_TRANSACTIONS_RETRIES_LIMIT">DB_TRANSACTIONS_RETRIES_LIMIT</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.PG_POOL_QUERIES_VERBOSE_MODE">PG_POOL_QUERIES_VERBOSE_MODE</a></li></ul></li><li><a href="module-database_connection.html">database/connection</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-database_connection.html#~onClientConnected">onClientConnected</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~reconnect">reconnect</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~createNewClient">createNewClient</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~execRepeatableTransaction">execRepeatableTransaction</a></li></ul></li><li><a href="module-http-server_api_accounts.html">http-server/api/accounts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~createLocal">createLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~authenticateLocal">authenticateLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~initEmailConfirmation">initEmailConfirmation</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~confirmEmailWithCode">confirmEmailWithCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~sendPasswordRecoveryCode">sendPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~checkPasswordRecoveryCode">checkPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~issueNewPassword">issueNewPassword</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~getAccountData">getAccountData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~list">list</a></li></ul></li><li><a href="module-http-server_api_oAuth.html">http-server/api/oAuth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateVKRedirect">generateVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleVKRedirect">handleVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateGoogleRedirect">generateGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleGoogleRedirect">handleGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateYandexRedirect">generateYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleYandexRedirect">handleYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~getOpenIdInstanceByReturnUrl">getOpenIdInstanceByReturnUrl</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleSteamRedirect">handleSteamRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~readUserData">readUserData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~endAuthentication">endAuthentication</a></li></ul></li><li><a href="module-http-server_api_payments_freekassa.html">http-server/api/payments/freekassa</a></li><li><a href="module-http-server_api_payments_gamemoney.html">http-server/api/payments/gamemoney</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~generateDepositRedirectSignature">generateDepositRedirectSignature</a></li></ul></li><li><a href="module-http-server_api_payments.html">http-server/api/payments</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~depositRules">depositRules</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~generateDepositRedirect">generateDepositRedirect</a></li></ul></li><li><a href="module-http-server_config.html">http-server/config</a></li><li><a href="module-http-server.html">http-server</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-http-server.html#.API">API</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server.html#~startServe">startServe</a></li><li data-type='method' style='display: none;'><a href="module-http-server.html#~shutDown">shutDown</a></li></ul></li><li><a href="module-http-server_middleware_access.html">http-server/middleware/access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~setAuthCookie">setAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~removeAuthCookie">removeAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~addAuthorizationDataToRequest">addAuthorizationDataToRequest</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessUser">accessUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessAdmin">accessAdmin</a></li></ul></li><li><a href="module-http-server_gamemoney-lib.html">http-server/gamemoney-lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateHmacSignature">generateHmacSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~verifyRequestRsaSignature">verifyRequestRsaSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~createDeposit">createDeposit</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~updateDepositStatus">updateDepositStatus</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateDepositRedirectUrl">generateDepositRedirectUrl</a></li></ul></li><li><a href="module-http-server_health-check.html">http-server/health-check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~updateState">updateState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~getState">getState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpMiddleware">httpMiddleware</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpEndpoint">httpEndpoint</a></li></ul></li><li><a href="module-http-server_mailer.html">http-server/mailer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_mailer.html#~sendMail">sendMail</a></li></ul></li><li><a href="module-http-server_plugins_withdrawals_approval.html">http-server/plugins/withdrawals/approval</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_plugins_withdrawals_approval.html#~checkForWithdrawalsBlockers">checkForWithdrawalsBlockers</a></li></ul></li><li><a href="module-http-server_lib.html">http-server/lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~freezeObjectDeep">freezeObjectDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesSizeOfObject">bytesSizeOfObject</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~asyncInterval">asyncInterval</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~delay">delay</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~compareDeep">compareDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~generateRandomString">generateRandomString</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~minMax">minMax</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~shuffleArray">shuffleArray</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~toFixedPrecisionFloat">toFixedPrecisionFloat</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~to2DigitsPrecisionFloat">to2DigitsPrecisionFloat</a></li></ul></li><li><a href="module-logger.html">logger</a></li><li><a href="module-redis-connection_config.html">redis-connection/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_HOST">REDIS_HOST</a></li><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_PORT">REDIS_PORT</a></li></ul></li><li><a href="module-Games.html">Games</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createLocalAccount">createLocalAccount</a></li><li><a href="global.html#authenticateLocalAccount">authenticateLocalAccount</a></li><li><a href="global.html#fetchAccountData">fetchAccountData</a></li><li><a href="global.html#createAxiosInstance">createAxiosInstance</a></li><li><a href="global.html#createAuthInfrastructure">createAuthInfrastructure</a></li><li><a href="global.html#createWebsocketConnection">createWebsocketConnection</a></li><li><a href="global.html#socketCookieParser">socketCookieParser</a></li><li><a href="global.html#authCookieParser">authCookieParser</a></li><li><a href="global.html#hasAccessUser">hasAccessUser</a></li><li><a href="global.html#hasAccessAdmin">hasAccessAdmin</a></li><li><a href="global.html#util">util</a></li><li><a href="global.html#isMainBroadcastingServer">isMainBroadcastingServer</a></li><li><a href="global.html#MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD">MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD</a></li><li><a href="global.html#BETTING_PERIOD_MS">BETTING_PERIOD_MS</a></li><li><a href="global.html#COMPLETED_PERIOD_MS">COMPLETED_PERIOD_MS</a></li><li><a href="global.html#CRASH_GAME_FRAMES_DELAY_MS">CRASH_GAME_FRAMES_DELAY_MS</a></li><li><a href="global.html#GAME_LOOP_DELAY_AFTER_ERROR_MS">GAME_LOOP_DELAY_AFTER_ERROR_MS</a></li><li><a href="global.html#%2522your-256-bit-secret%2522">"your-256-bit-secret"</a></li><li><a href="global.html#CURRENT_GAME">CURRENT_GAME</a></li><li><a href="global.html#generateFinalMultipliersGroup">generateFinalMultipliersGroup</a></li><li><a href="global.html#activateFinalMultipliersGroup">activateFinalMultipliersGroup</a></li><li><a href="global.html#generateDepositRedirect">generateDepositRedirect</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#Accounts">Accounts</a></li><li><a href="global.html#performInventoryItemWithdrawalStatusUpdateNotificationForUser">performInventoryItemWithdrawalStatusUpdateNotificationForUser</a></li><li><a href="global.html#itemsList">itemsList</a></li><li><a href="global.html#fileParser">fileParser</a></li><li><a href="global.html#CONTENT_TYPES%255Bundefined%255D">CONTENT_TYPES[undefined]</a></li><li><a href="global.html#STEAM_ITEM_ICON_URL_HASHES_CACHE%255Bundefined%255D">STEAM_ITEM_ICON_URL_HASHES_CACHE[undefined]</a></li><li><a href="global.html#freekassaIPVerificationMiddleware">freekassaIPVerificationMiddleware</a></li><li><a href="global.html#freekassaHookSignatureVerificationMiddleware">freekassaHookSignatureVerificationMiddleware</a></li><li><a href="global.html#gamemoneyIPVerificationMiddleware">gamemoneyIPVerificationMiddleware</a></li><li><a href="global.html#gamemoneyHookSignatureVerificationMiddleware">gamemoneyHookSignatureVerificationMiddleware</a></li><li><a href="global.html#skinsBackIPVerificationMiddleware">skinsBackIPVerificationMiddleware</a></li><li><a href="global.html#skinsBackHookSignatureVerificationMiddleware">skinsBackHookSignatureVerificationMiddleware</a></li><li><a href="global.html#unitpayIPVerificationMiddleware">unitpayIPVerificationMiddleware</a></li><li><a href="global.html#unitpayHookSignatureVerificationMiddleware">unitpayHookSignatureVerificationMiddleware</a></li><li><a href="global.html#affiliateExists">affiliateExists</a></li><li><a href="global.html#getAffiliate">getAffiliate</a></li><li><a href="global.html#createNewAffiliate">createNewAffiliate</a></li><li><a href="global.html#performRevshareAccrual">performRevshareAccrual</a></li><li><a href="global.html#createDefaultTariff">createDefaultTariff</a></li><li><a href="global.html#getValidMatchingTariff">getValidMatchingTariff</a></li><li><a href="global.html#MENTION_SUGGESTIONS">MENTION_SUGGESTIONS</a></li><li><a href="global.html#searchMentionedUsers">searchMentionedUsers</a></li><li><a href="global.html#filterProhibitedWords">filterProhibitedWords</a></li><li><a href="global.html#EMOJIS_LIST">EMOJIS_LIST</a></li><li><a href="global.html#generateDepositRedirectUrl">generateDepositRedirectUrl</a></li><li><a href="global.html#handleNewPromocodeActivation">handleNewPromocodeActivation</a></li><li><a href="global.html#handleNewCompletedDeposit">handleNewCompletedDeposit</a></li><li><a href="global.html#generateSignature">generateSignature</a></li><li><a href="global.html#verifyHookSignature">verifyHookSignature</a></li><li><a href="global.html#createOrReplaceDeposit">createOrReplaceDeposit</a></li><li><a href="global.html#Status">Status</a></li><li><a href="global.html#createConnection">createConnection</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#KNOWN_ACQUIRING_SYSTEMS">KNOWN_ACQUIRING_SYSTEMS</a></li><li><a href="global.html#PAYMENT_METHOD_KINDS">PAYMENT_METHOD_KINDS</a></li><li><a href="global.html#PAYMENT_METHOD_ICON_NAMES">PAYMENT_METHOD_ICON_NAMES</a></li><li><a href="global.html#PaymentMethod">PaymentMethod</a></li><li><a href="global.html#depositRules">depositRules</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">botz-service/index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const {DB} = require('../database/connection.js')
const {config} = require('./config.js')
const {codes} = require('status-codes')
const {delay} = require('../lib.js')
const {scrapeProfilesFromSteamFriendsList} = require('./actions/scrape-profiles.js')
const {info, error, drawTable} = require('../logger')
const {Bot} = require('./botz/bot.js')
const {shuffleArray} = require('../lib.js')



class BotzPool {

    /**
     * @type Bot[]
     */
    botz = []

    /**
     *
     * @type {String[]}
     */
    deleted_botz_usernames = []

    /**
     * @type {String}
     */
    last_scraped_link = null

    constructor () {

    }

    async start () {

        if (config.BOTZ_POOL_VERBOSE_MODE) info(`Botz pool started at ${new Date().toLocaleString()}`)


        while (true) {

            try {

                await this.addBotzToPool({
                    required_player_role_botz: config.PLAYER_ROLE_BOTZ - this.playerBotzInPoolCount,
                    required_observer_role_botz: config.OBSERVER_ROLE_BOTZ - this.observerBotzInPoolCount
                })


                await this.delegateRolesToBotz()

                await this.clearPool()

                await delay(2000)

            } catch (e) {
                error('BotzPool.start() err:', e)
                process.exit(1)
            }
        }

    }





    async addBotzToPool ({required_player_role_botz, required_observer_role_botz}) {
        try {

            if (config.BOTZ_POOL_VERBOSE_MODE) info (`start adding new botz to pool`)

            const prev_pool_size = this.totalBotzInPoolCount


            if (typeof required_player_role_botz !== 'number' || typeof required_observer_role_botz !== 'number') {
                return {
                    status: codes.WRONG_ARGS,
                    desc: {
                        required_player_role_botz,
                        required_observer_role_botz
                    }
                }
            }


            /** botz from db are sorted by stored inventory items / balance DESCENDING */
            const {free_bot_profiles_from_db} = await this.getFreeBotProfilesFromDB({
                limit: required_player_role_botz + required_observer_role_botz
            })

            if (config.BOTZ_POOL_VERBOSE_MODE) {
                info(`${free_bot_profiles_from_db.length} bot profiles was retrieved from DB`)
            }

            for await (const bot_profile of free_bot_profiles_from_db) {
                try {

                    const {status, bot} = await Bot.restore({
                        base_url: config.HTTP_API_BASE_URL,
                        ...bot_profile
                    })


                    if (codes.statusEqual(status, codes.OK)) {
                        this.botz.push(bot)
                        if (config.BOTZ_POOL_VERBOSE_MODE) (`bot ${bot.username} was added to pool`)
                    }

                } catch (e) {
                    error('restoring a bot from db profile err:', e)
                }
            }

            const count_of_botz_to_create = (required_player_role_botz + required_observer_role_botz) - free_bot_profiles_from_db.length

            if (config.BOTZ_POOL_VERBOSE_MODE) info(`${count_of_botz_to_create} botz should be created`)

            if (!count_of_botz_to_create) {
                return {status: codes.OK}
            }

            if (!this.last_scraped_link) {
                this.last_scraped_link = config.STEAM_FRIENDS_LISTS_LINKS_TO_SCRAPE_PROFILES[0]
            }

            if (!this.last_scraped_link) {
                throw new Error(`No links to scrape!!!`)
            }


            const {scraped_profiles} = await scrapeProfilesFromSteamFriendsList({
                link_to_steam_account_friends_page: this.last_scraped_link
            })

            if (config.BOTZ_POOL_VERBOSE_MODE) info({scraped_profiles_count: scraped_profiles.length})

            const matching_scraped_profiles = scraped_profiles.filter(p => p.username &amp;&amp; p.avatar_link &amp;&amp; p.username.length > 3 &amp;&amp; p.username.length &lt;= 40 &amp;&amp; !p.username.toLowerCase().includes('bot'))


            const existing_profiles = await DB.query(
                `SELECT username FROM botz WHERE username = ANY ($1::TEXT[])`,
                [
                    matching_scraped_profiles.map(m_s_p => m_s_p.username)
                ]
            ).then(r=> r.rows)

            const not_existing_scraped_profiles = matching_scraped_profiles.filter(s_p => existing_profiles.every(e_p => s_p.username !== e_p.username ))


            if (config.BOTZ_POOL_VERBOSE_MODE) info({
                existing_profiles_count: existing_profiles.length,
                not_existing_scraped_profiles_count: not_existing_scraped_profiles.length
            })

            if (!not_existing_scraped_profiles.length) {

                this.last_scraped_link = config.STEAM_FRIENDS_LISTS_LINKS_TO_SCRAPE_PROFILES[
                    config.STEAM_FRIENDS_LISTS_LINKS_TO_SCRAPE_PROFILES.indexOf(this.last_scraped_link) + 1
                ]

                if (config.BOTZ_POOL_VERBOSE_MODE) info(`Next link to scrape: ${this.last_scraped_link}`)

                if (!this.last_scraped_link) {
                    throw new Error('No more links to scrape!!!')
                }
            }

            shuffleArray(not_existing_scraped_profiles)

            let created_botz = 0

            for (const {username, avatar_link} of not_existing_scraped_profiles) {

                if (created_botz >= count_of_botz_to_create) {
                    break
                }

                const {bot, status} = await Bot.create({
                    base_url: config.HTTP_API_BASE_URL,
                    username,
                    password: `${Math.trunc(Math.random() * Date.now())}_${Math.trunc(Math.random() * Date.now())}`,
                    email: `${Date.now()}_${Math.trunc(Math.random() * Date.now() / 1000000000)}@botz.botz`,
                    avatar_link
                })

                if (codes.statusEqual(status, codes.OK)) {
                    created_botz++
                    this.botz.push(bot)
                    if (config.BOTZ_POOL_VERBOSE_MODE) info(`bot ${bot.username} was added to pool`)
                }
            }

            if (config.BOTZ_POOL_VERBOSE_MODE) info(`${created_botz} botz were created`)

            if (!created_botz) {
                this.last_scraped_link = config.STEAM_FRIENDS_LISTS_LINKS_TO_SCRAPE_PROFILES[
                    config.STEAM_FRIENDS_LISTS_LINKS_TO_SCRAPE_PROFILES.indexOf(this.last_scraped_link) + 1
                ]

                if (config.BOTZ_POOL_VERBOSE_MODE) info(`Next link to scrape: ${this.last_scraped_link}`)

                if (!this.last_scraped_link) {
                    throw new Error('No more links to scrape!!!')
                }
            }

            if (config.BOTZ_POOL_VERBOSE_MODE) info (`${this.totalBotzInPoolCount - prev_pool_size} botz were added to pool`)

            return {status: codes.OK}

        } catch (e) {
            error('addBotzToPool() err:', e)
            return {status: codes.FAIL}
        } finally {
            if (config.BOTZ_POOL_VERBOSE_MODE) info('task addBotzToPool() is completed, botz in pool: ', this.botz.length)
        }

    }

    async getFreeBotProfilesFromDB ({limit}) {

        if (typeof limit !== 'number') {
            return {status: codes.WRONG_ARGS, desc: {limit}}
        }


        const unwanted_botz_usernames = [...this.botz.map(b => b.username), ...this.deleted_botz_usernames]


        return {
            status: codes.OK,
            free_bot_profiles_from_db: await DB.query(`
            WITH all_botz AS (   
                SELECT b.*,
                       u.avatar_link,
                       u.email,
                       u.user_id,
                       calcBalance(u.user_id) as balance,
                       (SELECT count(*)::INT
                        FROM inventory_items ii 
                        WHERE ii.user_id = u.user_id AND status = 'STORED') 
                            as stored_inventory_items_count
                FROM botz b
                         LEFT JOIN users u
                                   ON b.username = u.username
                WHERE ($1::TEXT[] IS NULL OR b.username != ALL ($1::TEXT[]))
                    AND u.avatar_link IS NOT NULL
               )
            SELECT * FROM all_botz 
            WHERE balance >= $3 OR stored_inventory_items_count > 0 
            ORDER BY stored_inventory_items_count DESC, balance DESC
            LIMIT $2
            `, [
                unwanted_botz_usernames.length ? unwanted_botz_usernames : null,
                limit,
                config.MIN_BET_AMOUNT_USD
            ])
                .then(r => r.rows)
        }
    }

    /**
     * @returns {Promise&lt;{status: *}>}
     */
    async clearPool () {
        try {

            if (config.BOTZ_POOL_VERBOSE_MODE) info (`Start clearing pool`)

            drawTable({
                total_botz: this.totalBotzInPoolCount,
                player_botz: this.playerBotzInPoolCount,
                observer_botz: this.observerBotzInPoolCount,
                botz_which_play_roles: this.botzWhichPlayRolesCount,
                botz_which_can_not_play_its_roles: this.botzWhichDontPlayItsRolesInPoolCount,
                botz_without_roles: this.botzWithoutRolesInPoolCount,
                dota2_items_botz: this.dota2ItemBots,
                csgo_items_botz: this.csgoItemBots
            })

            for await (const bot of this.botz) {

                if ( !bot.role || bot.role === 'PLAYER' &amp;&amp; !bot.is_playing_role ) { // a bot which can not play role
                    await bot.destructBot()
                    this.botz = this.botz.filter(b => b !== bot) //removing bot from pool
                    if (this.deleted_botz_usernames.every((u) => u !== bot.username)) {
                        this.deleted_botz_usernames.push(bot.username)
                    }
                    if (config.BOTZ_POOL_VERBOSE_MODE) info(`Bot ${bot.username} was destructed`)
                }

            }

            return {status: codes.OK}


        } catch (e) {
            error('clearPool() err:', e)
            return {status: codes.FAIL}
        } finally {
            if (config.BOTZ_POOL_VERBOSE_MODE) (`Pool is clear. Botz: ${this.totalBotzInPoolCount}`)
        }
    }

    async delegateRolesToBotz () {
        try {

            if (config.BOTZ_POOL_VERBOSE_MODE) info (`Start delegating roles to pool botz.`)

            for await (const bot of this.botz) {

                const required_additional_player_role_botz = config.PLAYER_ROLE_BOTZ - this.playerBotzInPoolCount
                const required_additional_observer_role_botz = config.OBSERVER_ROLE_BOTZ - this.observerBotzInPoolCount


                if (bot.role &amp;&amp; !bot.is_playing_role) {
                    /** bot will be removed from pool */
                    bot.role = null
                    continue
                }

                if (required_additional_player_role_botz > 0 &amp;&amp; !bot.hasNothingToBet &amp;&amp; bot.role !== 'PLAYER') {
                    await bot.setRole({new_role: 'PLAYER'})
                    continue
                }

                if (required_additional_observer_role_botz > 0 &amp;&amp; bot.role !== 'OBSERVER') {
                    await bot.setRole({new_role: 'OBSERVER'})
                    continue
                }

            }

            return {status: codes.OK}

        } catch (e) {
            error('delegateRolesToBotz() err:', e)
            return {status: codes.FAIL}
        } finally {
            if (config.BOTZ_POOL_VERBOSE_MODE) info(`Roles delegating cycle completed`)
        }
    }

    get totalBotzInPoolCount () {
        return this.botz.length
    }

    get playerBotzInPoolCount () {
        return this.botz.filter(b => b.role === 'PLAYER').length
    }

    get observerBotzInPoolCount () {
        return this.botz.filter(b => b.role === 'OBSERVER').length
    }

    get botzWhichPlayRolesCount () {
        return this.botz.filter(b => b.role &amp;&amp; b.is_playing_role).length
    }

    get botzWhichDontPlayItsRolesInPoolCount () {
        return this.botz.filter(b => b.role &amp;&amp; !b.is_playing_role).length
    }

    get botzWithoutRolesInPoolCount () {
        return this.botz.filter(b => !b.role).length
    }

    get dota2ItemBots () {
        return this.botz.filter(b => b.preferred_items_steam_app_name === 'DOTA2').length
    }
    get csgoItemBots () {
        return this.botz.filter(b => b.preferred_items_steam_app_name === 'CS_GO').length
    }


}

const botz_pool = new BotzPool()
botz_pool.start()

</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> on Mon Feb 08 2021 15:54:23 GMT+0300 (Moscow Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
