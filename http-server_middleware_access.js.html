<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>http-server/middleware/access.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OutgoingMessage.html">OutgoingMessage</a></li><li><a href="Game.html">Game</a></li><li><a href="CrashGame.html">CrashGame</a><ul class='members'><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGame.html#publishUpdatedPlayer">publishUpdatedPlayer</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#handleManualOutDirectives">handleManualOutDirectives</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#autoOutPlayers">autoOutPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outRemainingPlayers">outRemainingPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outPlayers">outPlayers</a></li></ul></li><li><a href="CrashGameDBTransaction.html">CrashGameDBTransaction</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#createSavePoint">createSavePoint</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#rollbackToSavePoint">rollbackToSavePoint</a></li></ul></li><li><a href="GameWin.html">GameWin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="GameWin.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="GameWin.html#.calcWonAmount">calcWonAmount</a></li></ul></li><li><a href="SteamItem.html">SteamItem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SteamItem.html#.fromObject">fromObject</a></li></ul></li><li><a href="module-Games-Game.html">Game</a></li><li><a href="module-Games-SteamItem.html">SteamItem</a></li><li><a href="module-Games-InventoryItem.html">InventoryItem</a></li><li><a href="module-Games-GameWin.html">GameWin</a></li><li><a href="module-Games-GameBet.html">GameBet</a></li><li><a href="module-Games-User.html">User</a></li><li><a href="module-Games-Player.html">Player</a></li></ul><h3>Modules</h3><ul><li><a href="module-access_config.html">access/config</a></li><li><a href="module-access.html">access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-access.html#~encryptString">encryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#.decryptString">decryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#~issueJWTToken">issueJWTToken</a></li></ul></li><li><a href="module-broadcasting-server_config.html">broadcasting-server/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-broadcasting-server_config.html#.PORT">PORT</a></li></ul></li><li><a href="module-ws-server_ws-clients.html">ws-server/ws-clients</a></li><li><a href="module-database_config.html">database/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_ATTEMPTS">RECONNECTION_ATTEMPTS</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_DELAY">RECONNECTION_DELAY</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_CONNECTION_URL">DB_CONNECTION_URL</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_TRANSACTIONS_RETRIES_LIMIT">DB_TRANSACTIONS_RETRIES_LIMIT</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.PG_POOL_QUERIES_VERBOSE_MODE">PG_POOL_QUERIES_VERBOSE_MODE</a></li></ul></li><li><a href="module-database_connection.html">database/connection</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-database_connection.html#~onClientConnected">onClientConnected</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~reconnect">reconnect</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~createNewClient">createNewClient</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~execRepeatableTransaction">execRepeatableTransaction</a></li></ul></li><li><a href="module-http-server_api_accounts.html">http-server/api/accounts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~createLocal">createLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~authenticateLocal">authenticateLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~initEmailConfirmation">initEmailConfirmation</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~confirmEmailWithCode">confirmEmailWithCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~sendPasswordRecoveryCode">sendPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~checkPasswordRecoveryCode">checkPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~issueNewPassword">issueNewPassword</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~getAccountData">getAccountData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~list">list</a></li></ul></li><li><a href="module-http-server_api_oAuth.html">http-server/api/oAuth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateVKRedirect">generateVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleVKRedirect">handleVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateGoogleRedirect">generateGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleGoogleRedirect">handleGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateYandexRedirect">generateYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleYandexRedirect">handleYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~getOpenIdInstanceByReturnUrl">getOpenIdInstanceByReturnUrl</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleSteamRedirect">handleSteamRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~readUserData">readUserData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~endAuthentication">endAuthentication</a></li></ul></li><li><a href="module-http-server_api_payments_freekassa.html">http-server/api/payments/freekassa</a></li><li><a href="module-http-server_api_payments_gamemoney.html">http-server/api/payments/gamemoney</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~generateDepositRedirectSignature">generateDepositRedirectSignature</a></li></ul></li><li><a href="module-http-server_api_payments.html">http-server/api/payments</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~depositRules">depositRules</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~generateDepositRedirect">generateDepositRedirect</a></li></ul></li><li><a href="module-http-server_config.html">http-server/config</a></li><li><a href="module-http-server.html">http-server</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-http-server.html#.API">API</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server.html#~startServe">startServe</a></li><li data-type='method' style='display: none;'><a href="module-http-server.html#~shutDown">shutDown</a></li></ul></li><li><a href="module-http-server_middleware_access.html">http-server/middleware/access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~setAuthCookie">setAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~removeAuthCookie">removeAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~addAuthorizationDataToRequest">addAuthorizationDataToRequest</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessUser">accessUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessAdmin">accessAdmin</a></li></ul></li><li><a href="module-http-server_gamemoney-lib.html">http-server/gamemoney-lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateHmacSignature">generateHmacSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~verifyRequestRsaSignature">verifyRequestRsaSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~createDeposit">createDeposit</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~updateDepositStatus">updateDepositStatus</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateDepositRedirectUrl">generateDepositRedirectUrl</a></li></ul></li><li><a href="module-http-server_health-check.html">http-server/health-check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~updateState">updateState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~getState">getState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpMiddleware">httpMiddleware</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpEndpoint">httpEndpoint</a></li></ul></li><li><a href="module-http-server_mailer.html">http-server/mailer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_mailer.html#~sendMail">sendMail</a></li></ul></li><li><a href="module-http-server_plugins_withdrawals_approval.html">http-server/plugins/withdrawals/approval</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_plugins_withdrawals_approval.html#~checkForWithdrawalsBlockers">checkForWithdrawalsBlockers</a></li></ul></li><li><a href="module-http-server_lib.html">http-server/lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~freezeObjectDeep">freezeObjectDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesSizeOfObject">bytesSizeOfObject</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~asyncInterval">asyncInterval</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~delay">delay</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~compareDeep">compareDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~generateRandomString">generateRandomString</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~minMax">minMax</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~shuffleArray">shuffleArray</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~toFixedPrecisionFloat">toFixedPrecisionFloat</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~to2DigitsPrecisionFloat">to2DigitsPrecisionFloat</a></li></ul></li><li><a href="module-logger.html">logger</a></li><li><a href="module-redis-connection_config.html">redis-connection/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_HOST">REDIS_HOST</a></li><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_PORT">REDIS_PORT</a></li></ul></li><li><a href="module-Games.html">Games</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createLocalAccount">createLocalAccount</a></li><li><a href="global.html#authenticateLocalAccount">authenticateLocalAccount</a></li><li><a href="global.html#fetchAccountData">fetchAccountData</a></li><li><a href="global.html#createAxiosInstance">createAxiosInstance</a></li><li><a href="global.html#createAuthInfrastructure">createAuthInfrastructure</a></li><li><a href="global.html#createWebsocketConnection">createWebsocketConnection</a></li><li><a href="global.html#socketCookieParser">socketCookieParser</a></li><li><a href="global.html#authCookieParser">authCookieParser</a></li><li><a href="global.html#hasAccessUser">hasAccessUser</a></li><li><a href="global.html#hasAccessAdmin">hasAccessAdmin</a></li><li><a href="global.html#util">util</a></li><li><a href="global.html#isMainBroadcastingServer">isMainBroadcastingServer</a></li><li><a href="global.html#MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD">MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD</a></li><li><a href="global.html#BETTING_PERIOD_MS">BETTING_PERIOD_MS</a></li><li><a href="global.html#COMPLETED_PERIOD_MS">COMPLETED_PERIOD_MS</a></li><li><a href="global.html#CRASH_GAME_FRAMES_DELAY_MS">CRASH_GAME_FRAMES_DELAY_MS</a></li><li><a href="global.html#GAME_LOOP_DELAY_AFTER_ERROR_MS">GAME_LOOP_DELAY_AFTER_ERROR_MS</a></li><li><a href="global.html#%2522your-256-bit-secret%2522">"your-256-bit-secret"</a></li><li><a href="global.html#CURRENT_GAME">CURRENT_GAME</a></li><li><a href="global.html#generateFinalMultipliersGroup">generateFinalMultipliersGroup</a></li><li><a href="global.html#activateFinalMultipliersGroup">activateFinalMultipliersGroup</a></li><li><a href="global.html#generateDepositRedirect">generateDepositRedirect</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#Accounts">Accounts</a></li><li><a href="global.html#performInventoryItemWithdrawalStatusUpdateNotificationForUser">performInventoryItemWithdrawalStatusUpdateNotificationForUser</a></li><li><a href="global.html#itemsList">itemsList</a></li><li><a href="global.html#fileParser">fileParser</a></li><li><a href="global.html#CONTENT_TYPES%255Bundefined%255D">CONTENT_TYPES[undefined]</a></li><li><a href="global.html#STEAM_ITEM_ICON_URL_HASHES_CACHE%255Bundefined%255D">STEAM_ITEM_ICON_URL_HASHES_CACHE[undefined]</a></li><li><a href="global.html#freekassaIPVerificationMiddleware">freekassaIPVerificationMiddleware</a></li><li><a href="global.html#freekassaHookSignatureVerificationMiddleware">freekassaHookSignatureVerificationMiddleware</a></li><li><a href="global.html#gamemoneyIPVerificationMiddleware">gamemoneyIPVerificationMiddleware</a></li><li><a href="global.html#gamemoneyHookSignatureVerificationMiddleware">gamemoneyHookSignatureVerificationMiddleware</a></li><li><a href="global.html#skinsBackIPVerificationMiddleware">skinsBackIPVerificationMiddleware</a></li><li><a href="global.html#skinsBackHookSignatureVerificationMiddleware">skinsBackHookSignatureVerificationMiddleware</a></li><li><a href="global.html#unitpayIPVerificationMiddleware">unitpayIPVerificationMiddleware</a></li><li><a href="global.html#unitpayHookSignatureVerificationMiddleware">unitpayHookSignatureVerificationMiddleware</a></li><li><a href="global.html#affiliateExists">affiliateExists</a></li><li><a href="global.html#getAffiliate">getAffiliate</a></li><li><a href="global.html#createNewAffiliate">createNewAffiliate</a></li><li><a href="global.html#performRevshareAccrual">performRevshareAccrual</a></li><li><a href="global.html#createDefaultTariff">createDefaultTariff</a></li><li><a href="global.html#getValidMatchingTariff">getValidMatchingTariff</a></li><li><a href="global.html#MENTION_SUGGESTIONS">MENTION_SUGGESTIONS</a></li><li><a href="global.html#searchMentionedUsers">searchMentionedUsers</a></li><li><a href="global.html#filterProhibitedWords">filterProhibitedWords</a></li><li><a href="global.html#EMOJIS_LIST">EMOJIS_LIST</a></li><li><a href="global.html#generateDepositRedirectUrl">generateDepositRedirectUrl</a></li><li><a href="global.html#handleNewPromocodeActivation">handleNewPromocodeActivation</a></li><li><a href="global.html#handleNewCompletedDeposit">handleNewCompletedDeposit</a></li><li><a href="global.html#generateSignature">generateSignature</a></li><li><a href="global.html#verifyHookSignature">verifyHookSignature</a></li><li><a href="global.html#createOrReplaceDeposit">createOrReplaceDeposit</a></li><li><a href="global.html#Status">Status</a></li><li><a href="global.html#createConnection">createConnection</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#KNOWN_ACQUIRING_SYSTEMS">KNOWN_ACQUIRING_SYSTEMS</a></li><li><a href="global.html#PAYMENT_METHOD_KINDS">PAYMENT_METHOD_KINDS</a></li><li><a href="global.html#PAYMENT_METHOD_ICON_NAMES">PAYMENT_METHOD_ICON_NAMES</a></li><li><a href="global.html#PaymentMethod">PaymentMethod</a></li><li><a href="global.html#depositRules">depositRules</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">http-server/middleware/access.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module http-server/middleware/access
 * @desc
 * ##### Exports
 * ---
 * A set of methods to work with auth cookies and also a set middlewares to authorizing and permissions
 * checking
 *
 * ##### Procedure
 * ---
 * When user credentials are correct on oauth / local signing in,
 * we read the frequently used user data from the DB (for e.x. username, avatar link, permissions)
 * and pack it into the jwt (access token). User can not change the packed data, but can read the token using
 * web services like https://jwt.io, and we don't need to read smth from DB to get user data handling his requests.
 * Tokens stored in signed cookies and so we only need to read the req cookie and decrypt the token.
 *
 * We should store the "compromised" web-tokens in the in-memory-cache with cold storage (redis seems perfect)
 * to not accept the tokens that were revoked.
 *
 * To make data into the jwt unavailable to be read by user, we add the extra-level of encryption and encrypt
 * the issued token using node native "crypto" module and the secret keys from env. It adds no significant CPU/MEM
 * overhead handling the api requests.
 *
 * @module http-server/middleware/access
 * @see https://jwt.io
 * @see https://tools.ietf.org/html/rfc7519
 */



/**
 * @desc Account data which will be added to each api-request before handling it with
 * an endpoint, if request is authorized.
 * @memberOf InternalTypes
 * @typedef {Object} AuthTokenContent
 * @property {User.user_id} user_id -  an unique user id, a foreign key in 'users' DB table
 * @property {User.permissions} permissions -  see {@link module:http-server/middleware/access}
 * @property {User.admin_permissions_scope} admin_permissions_scope  - see {@link module:http-server/middleware/access}
 */


const {codes} = require( 'status-codes')
const {config} = require( '../config.js')
const {error} = require( '../../logger/index.js')
const {hasUserPermissions, hasAdminPermissions, decryptString, decodeJWTToken} = require( '../../access/index.js')

const getAuthCookieDomain = (req) => {

    const full_hostname = (() => {
        /** domain from 'origin' || 'referer' header */
        if (req.headers.origin) {
            return req.headers.origin.split('//')[1].split('/')[0]
        } else if (req.headers.referer) {
            return req.headers.referer.split('//')[1].split('/')[0]
        } else if (req.DOMAIN) { /** available only working on localhost */
            return req.DOMAIN
        } else {
            throw new Error(`No header to get domain. Headers: ${JSON.stringify(req.headers)}`)
        }
    })()


    /** transforming green.cat.com:8080 to ['green', 'cat', 'com'] */
    const domain_parts = full_hostname.split(':')[0].split('.')

    let raw_domain
    const raw_domain_is_IPv4 = domain_parts.every(domain_part => !isNaN(parseInt(domain_part)))

    /** handling the request to the raw IPv4, like 0.0.0.0:&lt;PORT> */
    if (raw_domain_is_IPv4) {

        raw_domain = full_hostname.split(':')[0]

    } else {
        /**
         * if the domain has at least two parts, we take the last and one before it: 'green' + 'cat'
         * else it it has one part ( 'localhost' ) we'll take it.
         * */
        raw_domain = domain_parts[domain_parts.length - 2] ?
            `${domain_parts[domain_parts.length - 2]}.${domain_parts[domain_parts.length - 1]}` :
            domain_parts[domain_parts.length - 1]

    }

    /** some browsers doesnt allow wild-carded domains on localhost, so we should to know that */
    return raw_domain === 'localhost' || raw_domain_is_IPv4 ? raw_domain : `.${raw_domain}`

}


/**
 * @function setAuthCookie
 * @chain {@link module:http-server/api/accounts~authenticateLocal}
 * @chain this handler
 * @chain OR
 * @chain some oAuth authentication implementation.
 * See handlers named like .handle&lt;oAuth-Provider-Name>Redirect in {@link module:http-server/api/oAuth}.
 * @chain this handler
 * @chain OR
 * @chain some handler which updates the account data stored also in auth token
 * @chain this handler
 * @param {Express.request} req
 * @param {Express.response} res
 * @param {String} cookie_string -  auth cookie to set
 * @param {String} [explicit_auth_cookie_domain] - is required if req.headers['referer'] contains the foreign domain - after the oauth/openid service redirects etc.
 * @desc It adds the auth cookie to response with
 * different config depends of {@link module:http-server/config.AUTH_COOKIE_OPTIONS}
 */
const setAuthCookie = (req, res, cookie_string, explicit_auth_cookie_domain) => {
    try {

        const domain = explicit_auth_cookie_domain ? explicit_auth_cookie_domain : getAuthCookieDomain(req)

        res.cookie('authorization', cookie_string, {...config.AUTH_COOKIE_OPTIONS, domain})


    } catch (e) {
        error('access.setAuthCookie() err:', e)
        throw e
    }

}


/**
 * It removes cookie "authorization", provides the same cookie options as when cookie were placed
 * @function removeAuthCookie
 * @chain {@link module:http-server/api/accounts~logout}
 * @chain this handler
 * @header {String} host to get domain name
 */
const removeAuthCookie = (req, res) => {

    const domain = getAuthCookieDomain(req)

    return res.cookie('authorization', '', {...config.AUTH_COOKIE_OPTIONS, domain })
}

const addIPToRequest = (req, res, next) => {
    try {

        req.IP = req.headers['cf-connecting-ip'] || req.headers['x-forwarded-for'] || req.headers['x-original-forwarded-for'] || null
        req.IP_COUNTRY = req.headers['cf-ipcountry'] || null
        next()
    } catch (e) {
        error(`http-server/middleware/access.addIPToRequest() err:`, e)
        return res.json({status: codes.FAIL})
    }
}

const addDomainToRequest = (req, res, next) => {
    try {


        if (req.headers.referer &amp;&amp; !req.headers.referer.includes('localhost')) {


            const protocol_version = req.headers.referer.includes('https://') ? 'https://' : 'http://'

            req.DOMAIN = req.headers.referer.split(protocol_version)[1].split('/')[0]

        } else if (req.headers.host &amp;&amp; process.env.NODE_ENV === 'development') {

            req.DOMAIN =  req.headers.host /** development fallback */

        } else { /** production fallback */
            req.DOMAIN = config.APPLICATION_DOMAIN
        }

        next()


    } catch (e) {
        error('http-server/middleware/access.addDomainToRequest() err:', e)
        return res.json({status: codes.FAIL})
    }
}


/**
 * This middleware extracts a signed jwt-token from a signed cookie "authorization",
 * decrypts using {@link module:http-server/middleware/access~decryptString} to get a jwt token,
 * verifies and decrypts the jwt-token using package {@link https://www.npmjs.com/package/jsonwebtoken}
 * and if token is verified (we can trust its content) it adds its content to request to make them available as request.account_data
 * @path {ANY} /api/*
 * @chain this middleware
 * @chain {@link module:http-server/middleware/access~accessUser}
 * @chain any api endpoint
 * @chain OR
 * @chain this middleware
 * @chain {@link module:http-server/middleware/access~accessAdmin}
 * @chain any api endpoint
 * @chain OR
 * @chain this middleware
 * @chain any api endpoint that don't needs for authorization, but it still can use data from request.account_data
 * @chain OR
 * @chain this middleware
 * @chain any another middleware
 * @header {String} cookies not directly, using native express-cookie-parser
 */
const addAuthorizationDataToRequest = async (req, res, next) => {
    try {

        req.account_data = {}

        if (!req.signedCookies.authorization) return next()

        const encrypted_token = req.signedCookies.authorization

        const decrypted_token = decryptString(encrypted_token)

        const {token_content} = await decodeJWTToken(decrypted_token)

        if (token_content) {
            req.account_data = token_content
        }

        return next()

    } catch (e) {
        error('access/addAuthorizationDataToRequest err:', e)
        next()
    }
}



/**
 * @function accessUser
 * The core of authentication middleware, it denies all requests to the api endpoints
 * that need authentication and user-level access.
 * @code {403} if user is not authenticated and access denied
 * @response {FORBIDDEN} status if not authenticated
 * @path {ANY} /api/*
 * @function accessUser
 * @chain {@link module:http-server/middleware/access~addAuthorizationDataToRequest}
 * @chain this middleware
 * @chain some api method for authorized requests only
 * @example &lt;caption>Usage example&lt;/caption>
 * // creating the api endpoint guarded with user-level access using default express router syntax
 *  router.get('/api/some-protected-method', accessUser, (req, res) => {
 *
 *  // ...protected endpoint code...
 *  // here we can use the user credentials,
 *  // for e.g, req.account_data.user_id,
 *  // because request is definitely authorized
 *
 *  }
 */
const accessUser = async (req, res, next) => {

    try {

        if (hasUserPermissions(req.account_data.permissions) || hasAdminPermissions(req.account_data.permissions)) return next()

        return res.status(403).json({status: codes.FORBIDDEN})

    } catch (e) {
        error('access/accessUser err:', e)
        return res.status(403).json({status: codes.FORBIDDEN})
    }

}


/**
 * This is not a middleware, this is a simple middlewares constructor
 * returning the access-control middleware that requires the provided
 * permissions_scope to allow assess.
 * Usage is to to built the result (middleware) of this constructor call into the middlewares chain
 * @function accessAdmin
 * @path {ANY} /api/*
 * @example &lt;caption>Declaring some endpoint that reqires the admin-level permissions&lt;/caption>
 * router.post('/api/some-admin-endpoint', accessAdmin({ACCOUNTS: true}), (req, res) => {
 *  // ...protected endpoint code...
 *  // only admin with .admin_permissions_scope.BLOCKING_ACCOUNTS == true
 *  // can get access to this endpoint
 * })
 *
 * // also you can combine permissions scope as you need, for e.g
 *    accessAdmin({ACCOUNTS: true, SOME_ANOTHER_PERMISSION: true})
 * // it will return a middleware that will deny all requests authorized without this scopes combination
 *
 *
 * @chain {@link module:http-server/middleware/access~addAuthorizationDataToRequest}
 * @chain this middleware
 * @chain some api method for admins with provided scope only
 * @code {403} if access not allowed
 * @response {FORBIDDEN} status if access not allowed
 * @returns {function} a middleware which will check all provided permissions before access permitting
 */
const accessAdmin = (required_permissions_scope = {}) => {


    const ACCESS_ADMIN_IP_WHITELIST_ENABLED = Boolean(config.ACCESS_ADMIN_IPS_WHITELIST.length !== 1 || config.ACCESS_ADMIN_IPS_WHITELIST [0] !== '*')


    if (Object.keys(required_permissions_scope).some(scope => !config.REGISTERED_ADMIN_PERMISSIONS_SCOPES.includes(scope) ) ) {
        throw new Error(`Some admin permissions scope of provided bulk ("${Object.keys(required_permissions_scope).join(', ')}") is not registered. Check config module.`)
    }

    /**
     * @param req.account_data.permissions {Number}
     * @param req.account_data.admin_permissions_scope {Object} to compare scope with the provided to the constructor ones
     * @param next will be called if req is authorized
     */
    return async (req, res, next) => {
        try {


            /** not authorized */
            if (!req.account_data) {
                return res.status(403).json({status: codes.FORBIDDEN})
            }

            /** IP whitelist check */
            if ( ACCESS_ADMIN_IP_WHITELIST_ENABLED &amp;&amp; !config.ACCESS_ADMIN_IPS_WHITELIST.includes(req.IP)) {

                return res.status(403).json({status: codes.FORBIDDEN})
            }

            /** permissions matching */
            if (hasAdminPermissions(req.account_data.permissions)) {


                if (Object.keys(required_permissions_scope).some((required_scope) => req.account_data.admin_permissions_scope[required_scope] !== true)) {
                    return res.status(403).json({status: codes.FORBIDDEN})
                }

                next()

            } else {
                return res.status(403).json({status: codes.FORBIDDEN})
            }
        } catch (e) {
            error('access/accessAdmin err:', e)
            return res.status(403).json({status: codes.FORBIDDEN})
        }
    }

}


module.exports = {accessUser, accessAdmin, setAuthCookie, removeAuthCookie, addAuthorizationDataToRequest, addIPToRequest, addDomainToRequest, getAuthCookieDomain}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> on Mon Feb 08 2021 15:54:23 GMT+0300 (Moscow Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
