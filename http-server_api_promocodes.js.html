<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>http-server/api/promocodes.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="OutgoingMessage.html">OutgoingMessage</a></li><li><a href="Game.html">Game</a></li><li><a href="CrashGame.html">CrashGame</a><ul class='members'><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li><li data-type='member' style='display: none;'><a href="CrashGame.html#.CrashGame">CrashGame</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGame.html#publishUpdatedPlayer">publishUpdatedPlayer</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#handleManualOutDirectives">handleManualOutDirectives</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#autoOutPlayers">autoOutPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outRemainingPlayers">outRemainingPlayers</a></li><li data-type='method' style='display: none;'><a href="CrashGame.html#outPlayers">outPlayers</a></li></ul></li><li><a href="CrashGameDBTransaction.html">CrashGameDBTransaction</a><ul class='methods'><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#.start">start</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#createSavePoint">createSavePoint</a></li><li data-type='method' style='display: none;'><a href="CrashGameDBTransaction.html#rollbackToSavePoint">rollbackToSavePoint</a></li></ul></li><li><a href="GameWin.html">GameWin</a><ul class='methods'><li data-type='method' style='display: none;'><a href="GameWin.html#.create">create</a></li><li data-type='method' style='display: none;'><a href="GameWin.html#.calcWonAmount">calcWonAmount</a></li></ul></li><li><a href="SteamItem.html">SteamItem</a><ul class='methods'><li data-type='method' style='display: none;'><a href="SteamItem.html#.fromObject">fromObject</a></li></ul></li><li><a href="module-Games-Game.html">Game</a></li><li><a href="module-Games-SteamItem.html">SteamItem</a></li><li><a href="module-Games-InventoryItem.html">InventoryItem</a></li><li><a href="module-Games-GameWin.html">GameWin</a></li><li><a href="module-Games-GameBet.html">GameBet</a></li><li><a href="module-Games-User.html">User</a></li><li><a href="module-Games-Player.html">Player</a></li></ul><h3>Modules</h3><ul><li><a href="module-access_config.html">access/config</a></li><li><a href="module-access.html">access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-access.html#~encryptString">encryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#.decryptString">decryptString</a></li><li data-type='method' style='display: none;'><a href="module-access.html#~issueJWTToken">issueJWTToken</a></li></ul></li><li><a href="module-broadcasting-server_config.html">broadcasting-server/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-broadcasting-server_config.html#.PORT">PORT</a></li></ul></li><li><a href="module-ws-server_ws-clients.html">ws-server/ws-clients</a></li><li><a href="module-database_config.html">database/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_ATTEMPTS">RECONNECTION_ATTEMPTS</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.RECONNECTION_DELAY">RECONNECTION_DELAY</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_CONNECTION_URL">DB_CONNECTION_URL</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.DB_TRANSACTIONS_RETRIES_LIMIT">DB_TRANSACTIONS_RETRIES_LIMIT</a></li><li data-type='member' style='display: none;'><a href="module-database_config.html#.PG_POOL_QUERIES_VERBOSE_MODE">PG_POOL_QUERIES_VERBOSE_MODE</a></li></ul></li><li><a href="module-database_connection.html">database/connection</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-database_connection.html#~onClientConnected">onClientConnected</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~reconnect">reconnect</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~createNewClient">createNewClient</a></li><li data-type='method' style='display: none;'><a href="module-database_connection.html#~execRepeatableTransaction">execRepeatableTransaction</a></li></ul></li><li><a href="module-http-server_api_accounts.html">http-server/api/accounts</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~createLocal">createLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~authenticateLocal">authenticateLocal</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~initEmailConfirmation">initEmailConfirmation</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~confirmEmailWithCode">confirmEmailWithCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~sendPasswordRecoveryCode">sendPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~checkPasswordRecoveryCode">checkPasswordRecoveryCode</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~issueNewPassword">issueNewPassword</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~logout">logout</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~getAccountData">getAccountData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_accounts.html#~list">list</a></li></ul></li><li><a href="module-http-server_api_oAuth.html">http-server/api/oAuth</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateVKRedirect">generateVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleVKRedirect">handleVKRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateGoogleRedirect">generateGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleGoogleRedirect">handleGoogleRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~generateYandexRedirect">generateYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleYandexRedirect">handleYandexRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~getOpenIdInstanceByReturnUrl">getOpenIdInstanceByReturnUrl</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~handleSteamRedirect">handleSteamRedirect</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~readUserData">readUserData</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~createUser">createUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_oAuth.html#~endAuthentication">endAuthentication</a></li></ul></li><li><a href="module-http-server_api_payments_freekassa.html">http-server/api/payments/freekassa</a></li><li><a href="module-http-server_api_payments_gamemoney.html">http-server/api/payments/gamemoney</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments_gamemoney.html#~generateDepositRedirectSignature">generateDepositRedirectSignature</a></li></ul></li><li><a href="module-http-server_api_payments.html">http-server/api/payments</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~depositRules">depositRules</a></li><li data-type='method' style='display: none;'><a href="module-http-server_api_payments.html#~generateDepositRedirect">generateDepositRedirect</a></li></ul></li><li><a href="module-http-server_config.html">http-server/config</a></li><li><a href="module-http-server.html">http-server</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-http-server.html#.API">API</a></li></ul><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server.html#~startServe">startServe</a></li><li data-type='method' style='display: none;'><a href="module-http-server.html#~shutDown">shutDown</a></li></ul></li><li><a href="module-http-server_middleware_access.html">http-server/middleware/access</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~setAuthCookie">setAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~removeAuthCookie">removeAuthCookie</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~addAuthorizationDataToRequest">addAuthorizationDataToRequest</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessUser">accessUser</a></li><li data-type='method' style='display: none;'><a href="module-http-server_middleware_access.html#~accessAdmin">accessAdmin</a></li></ul></li><li><a href="module-http-server_gamemoney-lib.html">http-server/gamemoney-lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateHmacSignature">generateHmacSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~verifyRequestRsaSignature">verifyRequestRsaSignature</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~createDeposit">createDeposit</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~updateDepositStatus">updateDepositStatus</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~handleDepositHook">handleDepositHook</a></li><li data-type='method' style='display: none;'><a href="module-http-server_gamemoney-lib.html#~generateDepositRedirectUrl">generateDepositRedirectUrl</a></li></ul></li><li><a href="module-http-server_health-check.html">http-server/health-check</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~updateState">updateState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#~getState">getState</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpMiddleware">httpMiddleware</a></li><li data-type='method' style='display: none;'><a href="module-http-server_health-check.html#.httpEndpoint">httpEndpoint</a></li></ul></li><li><a href="module-http-server_mailer.html">http-server/mailer</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_mailer.html#~sendMail">sendMail</a></li></ul></li><li><a href="module-http-server_plugins_withdrawals_approval.html">http-server/plugins/withdrawals/approval</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_plugins_withdrawals_approval.html#~checkForWithdrawalsBlockers">checkForWithdrawalsBlockers</a></li></ul></li><li><a href="module-http-server_lib.html">http-server/lib</a><ul class='methods'><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~freezeObjectDeep">freezeObjectDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesSizeOfObject">bytesSizeOfObject</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~asyncInterval">asyncInterval</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~delay">delay</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~bytesToMb">bytesToMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~memoryUsageInMb">memoryUsageInMb</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~compareDeep">compareDeep</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~generateRandomString">generateRandomString</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~minMax">minMax</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~shuffleArray">shuffleArray</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~toFixedPrecisionFloat">toFixedPrecisionFloat</a></li><li data-type='method' style='display: none;'><a href="module-http-server_lib.html#~to2DigitsPrecisionFloat">to2DigitsPrecisionFloat</a></li></ul></li><li><a href="module-logger.html">logger</a></li><li><a href="module-redis-connection_config.html">redis-connection/config</a><ul class='members'><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_HOST">REDIS_HOST</a></li><li data-type='member' style='display: none;'><a href="module-redis-connection_config.html#.REDIS_PORT">REDIS_PORT</a></li></ul></li><li><a href="module-Games.html">Games</a></li></ul><h3>Global</h3><ul><li><a href="global.html#createLocalAccount">createLocalAccount</a></li><li><a href="global.html#authenticateLocalAccount">authenticateLocalAccount</a></li><li><a href="global.html#fetchAccountData">fetchAccountData</a></li><li><a href="global.html#createAxiosInstance">createAxiosInstance</a></li><li><a href="global.html#createAuthInfrastructure">createAuthInfrastructure</a></li><li><a href="global.html#createWebsocketConnection">createWebsocketConnection</a></li><li><a href="global.html#socketCookieParser">socketCookieParser</a></li><li><a href="global.html#authCookieParser">authCookieParser</a></li><li><a href="global.html#hasAccessUser">hasAccessUser</a></li><li><a href="global.html#hasAccessAdmin">hasAccessAdmin</a></li><li><a href="global.html#util">util</a></li><li><a href="global.html#isMainBroadcastingServer">isMainBroadcastingServer</a></li><li><a href="global.html#MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD">MIN_WON_INVENTORY_ITEM_SPAWN_PRICE_USD</a></li><li><a href="global.html#BETTING_PERIOD_MS">BETTING_PERIOD_MS</a></li><li><a href="global.html#COMPLETED_PERIOD_MS">COMPLETED_PERIOD_MS</a></li><li><a href="global.html#CRASH_GAME_FRAMES_DELAY_MS">CRASH_GAME_FRAMES_DELAY_MS</a></li><li><a href="global.html#GAME_LOOP_DELAY_AFTER_ERROR_MS">GAME_LOOP_DELAY_AFTER_ERROR_MS</a></li><li><a href="global.html#%2522your-256-bit-secret%2522">"your-256-bit-secret"</a></li><li><a href="global.html#CURRENT_GAME">CURRENT_GAME</a></li><li><a href="global.html#generateFinalMultipliersGroup">generateFinalMultipliersGroup</a></li><li><a href="global.html#activateFinalMultipliersGroup">activateFinalMultipliersGroup</a></li><li><a href="global.html#generateDepositRedirect">generateDepositRedirect</a></li><li><a href="global.html#list">list</a></li><li><a href="global.html#Accounts">Accounts</a></li><li><a href="global.html#performInventoryItemWithdrawalStatusUpdateNotificationForUser">performInventoryItemWithdrawalStatusUpdateNotificationForUser</a></li><li><a href="global.html#itemsList">itemsList</a></li><li><a href="global.html#fileParser">fileParser</a></li><li><a href="global.html#CONTENT_TYPES%255Bundefined%255D">CONTENT_TYPES[undefined]</a></li><li><a href="global.html#STEAM_ITEM_ICON_URL_HASHES_CACHE%255Bundefined%255D">STEAM_ITEM_ICON_URL_HASHES_CACHE[undefined]</a></li><li><a href="global.html#freekassaIPVerificationMiddleware">freekassaIPVerificationMiddleware</a></li><li><a href="global.html#freekassaHookSignatureVerificationMiddleware">freekassaHookSignatureVerificationMiddleware</a></li><li><a href="global.html#gamemoneyIPVerificationMiddleware">gamemoneyIPVerificationMiddleware</a></li><li><a href="global.html#gamemoneyHookSignatureVerificationMiddleware">gamemoneyHookSignatureVerificationMiddleware</a></li><li><a href="global.html#skinsBackIPVerificationMiddleware">skinsBackIPVerificationMiddleware</a></li><li><a href="global.html#skinsBackHookSignatureVerificationMiddleware">skinsBackHookSignatureVerificationMiddleware</a></li><li><a href="global.html#unitpayIPVerificationMiddleware">unitpayIPVerificationMiddleware</a></li><li><a href="global.html#unitpayHookSignatureVerificationMiddleware">unitpayHookSignatureVerificationMiddleware</a></li><li><a href="global.html#affiliateExists">affiliateExists</a></li><li><a href="global.html#getAffiliate">getAffiliate</a></li><li><a href="global.html#createNewAffiliate">createNewAffiliate</a></li><li><a href="global.html#performRevshareAccrual">performRevshareAccrual</a></li><li><a href="global.html#createDefaultTariff">createDefaultTariff</a></li><li><a href="global.html#getValidMatchingTariff">getValidMatchingTariff</a></li><li><a href="global.html#MENTION_SUGGESTIONS">MENTION_SUGGESTIONS</a></li><li><a href="global.html#searchMentionedUsers">searchMentionedUsers</a></li><li><a href="global.html#filterProhibitedWords">filterProhibitedWords</a></li><li><a href="global.html#EMOJIS_LIST">EMOJIS_LIST</a></li><li><a href="global.html#generateDepositRedirectUrl">generateDepositRedirectUrl</a></li><li><a href="global.html#handleNewPromocodeActivation">handleNewPromocodeActivation</a></li><li><a href="global.html#handleNewCompletedDeposit">handleNewCompletedDeposit</a></li><li><a href="global.html#generateSignature">generateSignature</a></li><li><a href="global.html#verifyHookSignature">verifyHookSignature</a></li><li><a href="global.html#createOrReplaceDeposit">createOrReplaceDeposit</a></li><li><a href="global.html#Status">Status</a></li><li><a href="global.html#createConnection">createConnection</a></li><li><a href="global.html#getConnection">getConnection</a></li><li><a href="global.html#KNOWN_ACQUIRING_SYSTEMS">KNOWN_ACQUIRING_SYSTEMS</a></li><li><a href="global.html#PAYMENT_METHOD_KINDS">PAYMENT_METHOD_KINDS</a></li><li><a href="global.html#PAYMENT_METHOD_ICON_NAMES">PAYMENT_METHOD_ICON_NAMES</a></li><li><a href="global.html#PaymentMethod">PaymentMethod</a></li><li><a href="global.html#depositRules">depositRules</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">http-server/api/promocodes.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const {codes} = require( 'status-codes')
const express = require( 'express')
const {accessUser, accessAdmin} = require( '../middleware/access.js')
const {error, info} = require( '../../logger/index.js')
const {DB, execRepeatableTransaction} = require( '../../database/connection.js')
const {publishPromocodeActivationUpdateEvent, handleNewPromocodeActivation} = require('../plugins/promocodes.js')
const {bindUserToAffiliate} = require('../plugins/affiliates/index.js')

const router = express.Router()


const activated = async (req, res) => {
    try {

        const {user_id} = req.account_data

        const activated = await DB.query(`SELECT pa.status,
                                                                pa.promocode_activation_id,
                                                                p.promocode_text,
                                                                p.valid_before,
                                                                p.bonus_kind,
                                                                p.bonus_trigger,
                                                                p.fixed_bonus_usd_amount,
                                                                p.percentage_bonus_value,
                                                                p.min_bonus_trigger_value
                                                           FROM promocodes_activations pa
                                                           JOIN promocodes p 
                                                               ON (pa.promocode_text = p.promocode_text)
                                                            WHERE pa.user_id = $1
                                                                AND p.valid_before >= now()`, [
            user_id
        ])
            .then(r => r.rows)

        return res.json({status: codes.OK, activated})

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


const activate = async (req, res) => {
    try {

        const promocode_text = req.body.promocode_text ? req.body.promocode_text.trim() : null

        if (!promocode_text) {
            return res.json({status: codes.WRONG_ARGS})
        }

        const {user_id} = req.account_data

        const inserting_result = await execRepeatableTransaction(async (client) => {

            /** deactivating the previous active promocode if exists */
            const rejected_promocodes_activations = await client.query(`
            
            WITH rejected_promocodes_activations_list AS (
                UPDATE promocodes_activations 
                SET status = 'REJECTED' 
                WHERE status = 'CREATED' 
                    AND user_id = $2 
                          AND LOWER(promocode_text COLLATE "ru_RU.utf8") != LOWER($1::TEXT COLLATE "ru_RU.utf8") RETURNING *)
            SELECT rpal.promocode_activation_id,
                   rpal.status,
                   p.promocode_text,
                   p.valid_before,
                   p.bonus_kind,
                   p.bonus_trigger,
                   p.fixed_bonus_usd_amount,
                   p.percentage_bonus_value,
                   p.min_bonus_trigger_value
            FROM rejected_promocodes_activations_list rpal
                LEFT JOIN promocodes p ON (rpal.promocode_text = p.promocode_text)
            `, [
                promocode_text,
                user_id
            ])
                .then(r => r.rows)


            const result = await client.query(`
            WITH promocodes_state AS (
                /* checking for the exceeding of the promocode activations limit 
                   and for the .valid_before timestamp of the promocode to be not in past */
                SELECT  activations_limit - (SELECT count(*) 
                                             FROM promocodes_activations 
                                             WHERE LOWER(promocode_text COLLATE "ru_RU.utf8") = LOWER($1::TEXT COLLATE "ru_RU.utf8") 
                                             )::INT
                        AS remaining_activations_count,
                        promocode_text
                FROM promocodes 
                WHERE LOWER(promocode_text COLLATE "ru_RU.utf8") = LOWER($1::TEXT COLLATE "ru_RU.utf8")
                        AND valid_before > now()
            ),
            /* creating the new (current) promocode activation bound to current .user_id, 
               if the result returned from the previous check means that the promocode is still valid (.valid_before)
               and its .remaining_activations_count is at least 1 */     
            inserted_promocodes_text AS ( INSERT INTO promocodes_activations (promocode_text, user_id, status) (SELECT
                                                                                                                           promocode_text,
                                                                                                                           $2::BIGINT as user_id,
                                                                                                                           'CREATED'
                                                                                                                       FROM promocodes_state
                                                                                                                       WHERE remaining_activations_count >= 1
            ) RETURNING json_build_object( 'promocode_text', promocode_text, 'promocode_activation_id', promocode_activation_id, 'status', status) as inserted_values)
            /* fetching details of the inserted promocode to display it to user */
            SELECT p.promocode_text,
                   p.affiliate_id,
                   p.valid_before,
                   p.bonus_kind,
                   p.bonus_trigger,
                   p.fixed_bonus_usd_amount,
                   p.percentage_bonus_value,
                   p.min_bonus_trigger_value,
                   ipt.inserted_values ->> 'promocode_activation_id' AS promocode_activation_id,
                   ipt.inserted_values ->> 'status' AS status
            FROM inserted_promocodes_text ipt
                        LEFT JOIN promocodes p ON (ipt.inserted_values ->> 'promocode_text' = p.promocode_text)
            `, [
                promocode_text,
                user_id
            ])
                .catch(e => e)

            if (result instanceof Error) {
                throw result
            }

            const promocode_details = result.rows[0]

            if (!promocode_details) {
                return {status: codes.IMPOSSIBLE}
            }


            /** promocodes also can be used as a replacement of the traditional referral link */
            if (promocode_details.affiliate_id) {

                info(`User #${user_id} should be bound to affiliate #${promocode_details.affiliate_id} activating promocode "${promocode_text}"`)

                await bindUserToAffiliate({
                    user_id,
                    affiliate_id: promocode_details.affiliate_id
                })

            }

            return {status: codes.OK, promocode_details: result.rows[0], rejected_promocodes_activations}

        }, {ISOLATION_LEVEL: 'SERIALIZABLE'})

        if (codes.statusEqual(inserting_result.status, codes.IMPOSSIBLE)) {

            /** seeking for existed activations of this promocode by this user */
            const existed_activation_of_this_promocode = await DB.query(`SELECT pa.status,
                                                                                      pa.promocode_activation_id,
                                                                                      p.promocode_text,
                                                                                      p.valid_before,
                                                                                      p.bonus_kind,
                                                                                      p.bonus_trigger,
                                                                                      p.fixed_bonus_usd_amount,
                                                                                      p.percentage_bonus_value,
                                                                                      p.min_bonus_trigger_value 
                        FROM promocodes_activations pa
                            INNER JOIN promocodes p ON (pa.promocode_text = p.promocode_text)
                        WHERE LOWER(pa.promocode_text COLLATE "ru_RU.utf8") = LOWER($1::TEXT COLLATE "ru_RU.utf8")
                          AND pa.user_id = $2`, [
                promocode_text,
                user_id
            ]).then(r => r.rows[0])


            /** activations found */
            if (existed_activation_of_this_promocode) {

                /** found activation is still active */
                if (existed_activation_of_this_promocode.status === 'CREATED') {
                    return res.json({status: codes.SAME_VALUE, promocode_details: existed_activation_of_this_promocode})
                }

                /** found activation is not active (bonus has been received
                 * or the activation was replaced with another one */
                return res.json({status: codes.ALREADY_DONE})
            }

            /** no activations found, but promocode is unavailable to activate (expired or activations limit reached */
            return res.json({status: codes.INCORRECT_STATE})
        }

        if (!codes.statusEqual(inserting_result.status, codes.OK)) {
            return res.json({status: inserting_result.status})
        }

        const {promocode_details, rejected_promocodes_activations} = inserting_result


        publishPromocodeActivationUpdateEvent({user_id, promocode_details})

        rejected_promocodes_activations.forEach(rejected_promocode_activation => {
            publishPromocodeActivationUpdateEvent({user_id, promocode_details: rejected_promocode_activation})
        })

        handleNewPromocodeActivation({promocode_activation_id: promocode_details.promocode_activation_id})

        return res.json({status: codes.OK, promocode_details})

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}



router.post('/activate', accessUser, activate)
router.get('/activated', accessUser, activated)




/** ADMINS API ENDPOINTS */


const list = async (req, res) => {
    try {

        const promocode_text = req.query.promocode_text ? `%${String(req.query.promocode_text).trim()}%` : null

        const bonus_kind = req.query.bonus_kind &amp;&amp; req.query.bonus_kind.trim()  ? req.query.bonus_kind.trim() : null
        const bonus_trigger = req.query.bonus_trigger &amp;&amp; req.query.bonus_trigger.trim()  ? req.query.bonus_trigger.trim() : null

        const created_at_from = req.query.created_at &amp;&amp; req.query.created_at.from &amp;&amp; new Date(req.query.created_at.from).toString() !== 'Incorrect Date' ? new Date(req.query.created_at.from) : null
        const created_at_to = req.query.created_at &amp;&amp; req.query.created_at.to &amp;&amp; new Date(req.query.created_at.to).toString() !== 'Incorrect Date' ? new Date(req.query.created_at.to) : null
        const valid_before_from = req.query.valid_before &amp;&amp; req.query.valid_before.from &amp;&amp; new Date(req.query.valid_before.from).toString() !== 'Incorrect Date' ? new Date(req.query.valid_before.from) : null
        const valid_before_to = req.query.valid_before &amp;&amp; req.query.valid_before.to &amp;&amp; new Date(req.query.valid_before.to).toString() !== 'Incorrect Date' ? new Date(req.query.valid_before.to) : null

        const activations_count_from = req.query.activations_count &amp;&amp; req.query.activations_count.from &amp;&amp; !isNaN(parseInt(req.query.activations_count.from)) ? parseInt(req.query.activations_count.from) : null
        const activations_count_to = req.query.activations_count &amp;&amp; req.query.activations_count.to &amp;&amp; !isNaN(parseInt(req.query.activations_count.to)) ? parseInt(req.query.activations_count.to) : null

        const activations_limit_from = req.query.activations_limit &amp;&amp; req.query.activations_limit.from &amp;&amp; !isNaN(parseInt(req.query.activations_limit.from)) ? parseInt(req.query.activations_limit.from) : null
        const activations_limit_to = req.query.activations_limit &amp;&amp; req.query.activations_limit.to &amp;&amp; !isNaN(parseInt(req.query.activations_limit.to)) ? parseInt(req.query.activations_limit.to) : null


        const bonuses_count_from = req.query.bonuses_count &amp;&amp; req.query.bonuses_count.from &amp;&amp; !isNaN(parseInt(req.query.bonuses_count.from)) ? parseInt(req.query.bonuses_count.from) : null
        const bonuses_count_to = req.query.bonuses_count &amp;&amp; req.query.bonuses_count.to &amp;&amp; !isNaN(parseInt(req.query.bonuses_count.to)) ? parseInt(req.query.bonuses_count.to) : null


        const bonuses_sum_from = req.query.bonuses_sum &amp;&amp; req.query.bonuses_sum.from &amp;&amp; !isNaN(parseInt(req.query.bonuses_sum.from)) ? parseInt(req.query.bonuses_sum.from) : null
        const bonuses_sum_to = req.query.bonuses_sum &amp;&amp; req.query.bonuses_sum.to &amp;&amp; !isNaN(parseInt(req.query.bonuses_sum.to)) ? parseInt(req.query.bonuses_sum.to) : null

        const affiliate_id = req.query.affiliate_id &amp;&amp; !isNaN(parseInt(req.query.affiliate_id)) ? parseInt(req.query.affiliate_id) : null

        const offset = req.query.offset &amp;&amp; !isNaN(parseInt(req.query.offset)) ? parseInt(req.query.offset) : 0
        const limit = req.query.limit &amp;&amp; !isNaN(parseInt(req.query.limit)) ? parseInt(req.query.limit) : 50
        const sorting_property = req.query.sorting_property &amp;&amp; req.query.sorting_property.trim() ? req.query.sorting_property.trim() : 'created_at'
        const sorting_direction = req.query.sorting_direction &amp;&amp; req.query.sorting_direction.trim() ? req.query.sorting_direction.trim() : 'ASC'




        const promocodes = await DB.query(`
        WITH raw_data AS (
            SELECT
                p.*,
                (count(*) OVER())::INTEGER AS total_found,
                (SELECT json_build_object('activations_count', count(*)::INT,
                                          'bonuses_count', (SELECT sum(CASE WHEN promocode_bonus_id IS NOT NULL THEN 1 ELSE 0 END) )::INT,
                                         'bonuses_sum', (SELECT COALESCE(sum(bonus_amount), 0.00))::NUMERIC(16,2) )
                FROM promocodes_activations pa
                LEFT JOIN  promocodes_bonuses pb 
                ON (pb.promocode_activation_id = pa.promocode_activation_id)
                WHERE pa.promocode_text = p.promocode_text) AS aggregated
            FROM promocodes p
        ),
        aggregated_values AS (
            SELECT *,
                   NULL as aggregated,
                   (aggregated ->> 'activations_count')::INT as activations_count,
                   (aggregated ->> 'bonuses_count')::INT as bonuses_count,
                   (aggregated ->> 'bonuses_sum')::NUMERIC(16,2) as bonuses_sum
            FROM raw_data 
        )
        SELECT * 
        FROM aggregated_values
        WHERE   ($1::TEXT IS NULL OR LOWER(promocode_text COLLATE "ru_RU.utf8") LIKE LOWER($1::TEXT COLLATE "ru_RU.utf8"))
            AND
                ($2::PROMOCODE_BONUS_KINDS IS NULL OR bonus_kind = $2::PROMOCODE_BONUS_KINDS)
            AND
                ($3::PROMOCODE_BONUS_TRIGGERS IS NULL OR bonus_trigger = $3::PROMOCODE_BONUS_TRIGGERS)
          AND
            ( ($4::TIMESTAMPTZ IS NULL OR $5::TIMESTAMPTZ IS NULL)
                OR date_trunc('day', created_at) >= date_trunc('day', $4::TIMESTAMPTZ)
                  AND
                   date_trunc('day', created_at) &lt;= date_trunc('day', $5::TIMESTAMPTZ)  )
          AND
            ( ($6::TIMESTAMPTZ IS NULL OR $7::TIMESTAMPTZ IS NULL)
                OR date_trunc('day', valid_before) >= date_trunc('day', $6::TIMESTAMPTZ)
                  AND
                   date_trunc('day', valid_before) &lt;= date_trunc('day', $7::TIMESTAMPTZ)  )
          AND 
            ( $8::INT IS NULL OR activations_limit >= $8::INT)
          AND
            ( $9::INT IS NULL OR activations_limit &lt;= $9::INT)
          AND
            ( $10::INT IS NULL OR activations_count >= $10::INT)
          AND
            ( $11::INT IS NULL OR activations_count &lt;= $11::INT)
          AND
            ( $12::INT IS NULL OR bonuses_count >= $12::INT)
          AND
            ( $13::INT IS NULL OR bonuses_count &lt;= $13::INT)
          AND
            ( $14::NUMERIC(16,2) IS NULL OR bonuses_sum >= $14::NUMERIC(16,2))
          AND
            ( $15::NUMERIC(16,2) IS NULL OR bonuses_sum &lt;= $15::NUMERIC(16,2))
          AND
            ( $16::BIGINT IS NULL OR affiliate_id = $16::BIGINT)
          ORDER BY ${sorting_property} ${sorting_direction}
          OFFSET $17
          LIMIT $18
        `, [
            promocode_text,

            bonus_kind,

            bonus_trigger,

            created_at_from,
            created_at_to,

            valid_before_from,
            valid_before_to,

            activations_limit_from,
            activations_limit_to,

            activations_count_from,
            activations_count_to,

            bonuses_count_from,
            bonuses_count_to,

            bonuses_sum_from,
            bonuses_sum_to,

            affiliate_id,

            offset,
            limit
        ])
            .then(r => r.rows)

        return res.json({
            status: codes.OK,
            promocodes
        })


    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


const activations = async (req, res) => {
    try {


        const offset = req.query.offset &amp;&amp; !isNaN(parseInt(req.query.offset)) ? parseInt(req.query.offset) : 0
        const limit = req.query.limit &amp;&amp; !isNaN(parseInt(req.query.limit)) ? parseInt(req.query.limit) : 50
        const sorting_property = req.query.sorting_property &amp;&amp; req.query.sorting_property.trim() ? req.query.sorting_property.trim() : 'pa.created_at'
        const sorting_direction = req.query.sorting_direction &amp;&amp; req.query.sorting_direction.trim() ? req.query.sorting_direction.trim() : 'ASC'

        const promocode_text = req.query.promocode_text ? req.query.promocode_text.trim() : null

        const username = req.query.username &amp;&amp; req.query.username.trim() ? `%${req.query.username.trim()}%` : null

        if (!promocode_text) {
            return res.json({status: codes.WRONG_ARGS})
        }

        const activations = await DB.query(`
            SELECT 
                pa.*, 
                pb.*,
                pa.created_at AS activation_created_at, 
                pb.created_at AS bonus_created_at,
                u.username,
                u.avatar_link,
                (SELECT json_build_object('tariff_kind', uab.tariff_kind) FROM user_affiliate_bindings uab  WHERE uab.user_id = u.user_id AND uab.affiliate_id = p.affiliate_id )
                AS user_affiliate_binding
            FROM promocodes_activations pa
                LEFT JOIN promocodes_bonuses pb 
                    ON pa.promocode_activation_id = pb.promocode_activation_id
                        LEFT JOIN users u 
                            ON pa.user_id  = u.user_id
                                LEFT JOIN promocodes p
                                    ON pa.promocode_text = p.promocode_text
            WHERE pa.promocode_text = $1::TEXT
                AND
                  ($2::TEXT IS NULL OR LOWER(u.username COLLATE "ru_RU.utf8") LIKE LOWER($2::TEXT COLLATE "ru_RU.utf8"))
            ORDER BY ${sorting_property} ${sorting_direction}
            OFFSET $3
            LIMIT $4`, [
            promocode_text,
            username,
            offset,
            limit
        ])
            .then(r => r.rows)


        return res.json({status: codes.OK, activations})

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}

const create = async (req, res) => {
    try {

        const promocode_text = req.body.promocode_text ? req.body.promocode_text.trim() : null
        const valid_before = req.body.valid_before ? new Date(req.body.valid_before) : null

        const {
            activations_limit,
            bonus_kind,
            bonus_trigger,
            fixed_bonus_usd_amount,
            percentage_bonus_value,
            min_bonus_trigger_value,
            required_account_turnover_to_unlock_possibilities
        } = req.body

        if (!promocode_text ||
            !valid_before ||
            !activations_limit ||
            !bonus_kind ||
            !bonus_trigger ||
            (!required_account_turnover_to_unlock_possibilities
                &amp;&amp; required_account_turnover_to_unlock_possibilities !== 0)
        ) {
            return res.json({status: codes.WRONG_ARGS})
        }

        const affiliate_id =
            req.body.affiliate_id &amp;&amp;
            String(req.body.affiliate_id).trim() &amp;&amp;
            !isNaN(parseInt(req.body.affiliate_id)) ?
                String(req.body.affiliate_id) :
                null

        if (req.body.affiliate_id &amp;&amp; !affiliate_id) {
            return res.json({
                status: codes.WRONG_ARGS
            })
        }


        if (new Date(valid_before).toString() === 'Invalid Date') {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_kind !== 'FIXED' &amp;&amp; bonus_kind !== 'PERCENTAGE') {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_kind === 'FIXED' &amp;&amp; !fixed_bonus_usd_amount) {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_kind === 'PERCENTAGE' &amp;&amp; !percentage_bonus_value) {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_kind === 'PERCENTAGE' &amp;&amp; bonus_trigger === 'INSTANT') {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_trigger !== 'INSTANT' &amp;&amp; bonus_trigger !== 'DEPOSIT') {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_trigger === 'DEPOSIT' &amp;&amp; !min_bonus_trigger_value &amp;&amp; min_bonus_trigger_value !== 0 ) {
            return res.json({status: codes.WRONG_ARGS})
        }

        const inserting_result = await DB.query(`
                INSERT INTO promocodes
                (promocode_text,
                 valid_before,
                 activations_limit,
                 bonus_kind,
                 bonus_trigger,
                 fixed_bonus_usd_amount,
                 percentage_bonus_value,
                 min_bonus_trigger_value,
                 required_account_turnover_to_unlock_possibilities,
                 affiliate_id
                ) VALUES (
                          $1,
                          $2,
                          $3,
                          $4,
                          $5,
                          $6,
                          $7,
                          $8,
                          $9,
                          $10
                         )
                RETURNING *
        `, [
            promocode_text,
            valid_before,
            activations_limit,
            bonus_kind,
            bonus_trigger,
            fixed_bonus_usd_amount,
            percentage_bonus_value,
            min_bonus_trigger_value,
            required_account_turnover_to_unlock_possibilities,
            affiliate_id
        ])
            .then(r => r.rows[0])
            .catch(e => e)

        if (inserting_result instanceof Error) {

            if (inserting_result.constraint === 'promocodes_affiliate_id_fkey') {
                return res.json({status: codes.INCORRECT_STATE})
            } else {
                throw inserting_result
            }

        }



        return res.json({
            status: codes.OK,
            promocode: inserting_result
        })

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


const update = async (req, res) => {
    try {

        const new_promocode_text = req.body.new_promocode_text ? req.body.new_promocode_text.trim() : null
        const promocode_text = req.body.promocode_text ? req.body.promocode_text.trim() : null
        const valid_before = req.body.valid_before ? new Date(req.body.valid_before) : null

        const {
            activations_limit,
            bonus_kind,
            bonus_trigger,
            fixed_bonus_usd_amount,
            percentage_bonus_value,
            min_bonus_trigger_value,
            required_account_turnover_to_unlock_possibilities,
            affiliate_id
        } = req.body

        if (affiliate_id &amp;&amp; isNaN(parseInt(affiliate_id))) {
            return res.json({
                status: codes.WRONG_ARGS
            })
        }

        if (!promocode_text ||
            !new_promocode_text ||
            !valid_before ||
            !activations_limit ||
            !bonus_kind ||
            !bonus_trigger ||
            (!required_account_turnover_to_unlock_possibilities
                &amp;&amp; required_account_turnover_to_unlock_possibilities !== 0)
        ) {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_kind !== 'FIXED' &amp;&amp; bonus_kind !== 'PERCENTAGE') {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_kind === 'FIXED' &amp;&amp; !fixed_bonus_usd_amount) {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_kind === 'PERCENTAGE' &amp;&amp; !percentage_bonus_value) {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_kind === 'PERCENTAGE' &amp;&amp; bonus_trigger === 'INSTANT') {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_trigger !== 'INSTANT' &amp;&amp; bonus_trigger !== 'DEPOSIT') {
            return res.json({status: codes.WRONG_ARGS})
        }

        if (bonus_trigger === 'DEPOSIT' &amp;&amp; !min_bonus_trigger_value &amp;&amp; min_bonus_trigger_value !== 0 ) {
            return res.json({status: codes.WRONG_ARGS})
        }

        const updated_promocode_text = await DB.query(`UPDATE promocodes
            SET promocode_text = $2,
                valid_before = $3,
                activations_limit = $4,
                bonus_kind = $5,
                bonus_trigger = $6,
                fixed_bonus_usd_amount = $7,
                percentage_bonus_value = $8,
                min_bonus_trigger_value = $9,
                required_account_turnover_to_unlock_possibilities = $10,
                affiliate_id = $11
            WHERE promocode_text = $1
            RETURNING promocode_text
                `, [
            promocode_text,
            new_promocode_text,
            valid_before,
            activations_limit,
            bonus_kind,
            bonus_trigger,
            fixed_bonus_usd_amount,
            percentage_bonus_value,
            min_bonus_trigger_value,
            required_account_turnover_to_unlock_possibilities,
            affiliate_id
        ])
            .then(r => r.rows[0].promocode_text)
            .catch(e => e)

        if (updated_promocode_text instanceof Error) {

            if (updated_promocode_text.constraint === 'promocodes_affiliate_id_fkey') {
                return res.json({status: codes.INCORRECT_STATE})
            } else {
                throw updated_promocode_text
            }

        }

        if (!updated_promocode_text) {
            return res.json({
                status: codes.NOT_FOUND
            })
        }

        return res.json({
            status: codes.OK,
            updated_promocode_text
        })


    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


const remove = async (req, res) => {
    try {

        const {promocode_text} = req.body

        if (!promocode_text) {
            return res.json({status: codes.WRONG_ARGS})
        }

        const result = await DB.query(`
            DELETE 
            FROM promocodes
            WHERE promocode_text = $1`, [
            promocode_text
        ])
            .catch(e => e)

        if (result instanceof Error) {
            if (result.constraint === 'promocodes_activations_promocode_text_fkey') {
                return res.json({status: codes.INCORRECT_STATE})
            }

            throw result
        }

        if (!result.rowCount) {
            return res.json({status: codes.NOT_FOUND})
        }

        return res.json({
            status: codes.OK
        })

    } catch (e) {
        error(`${req.originalUrl} err:`, e)
        return res.json({status: codes.FAIL})
    }
}


router.get('/list', accessAdmin({PROMOCODES: true}), list)
router.get('/activations', accessAdmin({PROMOCODES: true}), activations)
router.post('/update', accessAdmin({PROMOCODES: true}), update)
router.post('/create', accessAdmin({PROMOCODES: true}), create)
router.post('/remove', accessAdmin({PROMOCODES: true}), remove)


module.exports = router


</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.5</a> on Mon Feb 08 2021 15:54:23 GMT+0300 (Moscow Standard Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>


<script src="scripts/collapse.js" defer></script>


</body>
</html>
